var Map={defaults:{center:new google.maps.LatLng(38.901721,-77.035841),zoom:8,mapTypeId:google.maps.MapTypeId.ROADMAP},el:null,directionsEl:null,instance:null,directionsService:null,directionsDisplay:null,directionResponse:null,directionTemplate:Handlebars.compile($("#directions-template").html()),infoTemplate:Handlebars.compile($("#info-template").html()),isPrinting:false,markers:[],state:{addresses:null,markers:null,bounds:null},initialize:function(a,d){var b=this;this.el=a;this.directionsEl=d;this.state.addresses=[];this.state.markers=[];this.state.bounds={};this.instance=new google.maps.Map(a,this.defaults);this.directionsService=new google.maps.DirectionsService();this.directionsDisplay=new google.maps.DirectionsRenderer();this.directionsDisplay.setMap(this.instance);this.geocoder=new google.maps.Geocoder();var c;google.maps.event.addListener(this.instance,"bounds_changed",function(e){clearTimeout(c);c=setTimeout(function(){var f=b.instance.getBounds();b.state.bounds={ne:{lat:f.getNorthEast().lat(),lng:f.getNorthEast().lng()},sw:{lat:f.getSouthWest().lat(),lng:f.getSouthWest().lng()}};b.save()},500)});$.subscribe("marker:add",$.proxy(b.onMarkerAdded,b));$.subscribe("navigate",function(g,h,f){b.clearMarkers();b.state.addresses=[h,f];b.state.markers=[]})},setState:function(d){this.clear();this.state=$.extend(true,{},d);if(d.addresses&&d.addresses.length>0){Map.getDirections(d.addresses[0],d.addresses[1])}else{if(d.markers){for(var c=0,b=d.markers.length;c<b;c++){Map.placeMarker(d.markers[c])}}}if(d.bounds){var a=d.bounds.sw,e=d.bounds.ne;if(d.bounds.ne&&d.bounds.sw){this.instance.panToBounds(new google.maps.LatLngBounds(new google.maps.LatLng(a.lat,a.lng),new google.maps.LatLng(e.lat,e.lng)))}}},codeAddress:function(a){var b=jQuery.Deferred();this.geocoder.geocode({address:a},function(d,c){if(c==google.maps.GeocoderStatus.OK){b.resolve(d)}else{alert("Geocode was not successful for the following reason: "+c)}});return b.promise()},placeMarker:function(c){var b=this,a=c.address;b.directionsDisplay.setMap(null);b.codeAddress(a).then(function(h){var f=h[0].geometry.location,k=false,e;for(var j=0,d=b.markers.length;j<d;j++){e=b.markers[j];if(e.getPosition().equals(f)){k=true;break}}if(k!==true){var g=new google.maps.Marker({map:b.instance,position:f});$.publish("marker:add",[g,c])}b.instance.panTo(f);$.publish("marker:pan",c)})},onMarkerAdded:function(d,a,c){var b=this;this.state.addresses=[];this.state.markers.push(c);this.markers.push(a);a.InfoWindow=new google.maps.InfoWindow();google.maps.event.addListener(a,"click",function(){a.InfoWindow.setContent(b.infoTemplate(c));a.InfoWindow.setPosition(a.getPosition());a.InfoWindow.open(b.instance)})},getDirections:function(d,a){var c=this,b={origin:d,destination:a,travelMode:google.maps.TravelMode.DRIVING};c.directionsService.route(b,function(f,e){if(e==google.maps.DirectionsStatus.OK){c.directionsDisplay.setMap(c.instance);c.directionsDisplay.setDirections(f);c.directionResponse=f;$.publish("navigate",[d,a])}})},clear:function(){this.clearMarkers().clearDirections()},clearMarkers:function(){for(var c=0,a=this.markers.length;c<a;c++){var b=this.markers[c];b.setMap(null)}this.markers=this.state.markers=[];return this},clearDirections:function(){this.directionsDisplay.setMap(null);this.addresses=this.state.addresses=[];return this},toggleMapPrintView:function(){if(this.isPrinting===false){var a=this.directionResponse.routes[0].legs[0];$(this.el).css("display","none");$(this.directionsEl).css("display","block").html(this.directionTemplate(a));window.print()}else{$(this.el).css("display","");$(this.directionsEl).css("display","none").empty()}this.isPrinting=!this.isPrinting},save:function(){}};$(document).ready(function(){Map.initialize(document.getElementById("map"),document.getElementById("directions"))});