Ext.define("Ozone.data.Stack",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"int",defaultValue:-1},{name:"name",type:"string"},{name:"description",type:"string"},{name:"stackContext",type:"string"},{name:"descriptorUrl",type:"string"},{name:"totalDashboards",type:"int"},{name:"totalUsers",type:"int"},{name:"totalGroups",type:"int"},{name:"totalWidgets",type:"int"}]});Ext.define("Ozone.data.StackStore",{extend:"Ozone.data.OWFStore",model:"Ozone.data.Stack",sorters:[{property:"name",direction:"ASC"}],constructor:function(a){a=a?a:{};Ext.applyIf(a,{api:{read:"/stack",create:"/stack",update:"/stack",destroy:"/stack"},fields:["id","name","description","stackContext","descriptorUrl","totalDashboards","totalUsers","totalGroups","totalWidgets"],autoDestroy:true});this.callParent(arguments)}});Ext.define("Ozone.components.admin.ExportWindow",{extend:"Ext.window.Window",alias:["widget.exportwindow","widget.ExportWindow"],mixins:{widget:"Ozone.components.focusable.CircularFocus"},title:"Export",itemId:"exportwindow",modal:true,closable:true,draggable:false,resizable:false,closeAction:"hide",border:false,minWidth:250,layout:"auto",items:[{xtype:"panel",itemId:"exportpanel",cls:"admineditoraddpanel",layout:"fit",border:false,flex:1,items:[{xtype:"form",itemId:"form",layout:"anchor",bodyCls:"properties-body",border:false,preventHeader:true,padding:5,autoScroll:true,defaults:{anchor:"100%",msgTarget:"side",labelSeparator:"",margin:"5 5 0 5"},items:[{xtype:"textfield",itemId:"filename",fieldLabel:"File Name",labelWidth:130,allowBlank:false,name:"filename",maxLength:200,regex:/^[a-zA-Z\d\-\_]+$/,regexText:"Invalid characters! The Filename may only contain letters, numbers, dashes, and underscores."}]}]}],buttons:[{text:"OK",itemId:"ok",disabled:true},{text:"Cancel",itemId:"cancel"}],initComponent:function(){var a=this;a.setWidth(Math.round(Ext.getBody().getViewSize().width*0.9));a.on("beforeshow",function(){a.setTitle(a.generateTitle())});a.on("afterrender",function(){var d=a.down("#form");var b=a.down("#filename");var c=a.down("#ok");var e=a.down("#cancel");a.itemFilename&&b.setValue(a.itemFilename)&&c.enable();d.on("fieldvaliditychange",function(h,g,i,f){if(i){c.enable()}else{c.disable()}});e.on("click",function(f,g){a.close()});c.on("click",function(f,g){if(a.okFn){a.okFn(b.value)}a.close()});a.setupFocus(b.getFocusEl(),e.getFocusEl())});a.on("beforeclose",function(){a.down("#form").clearListeners();a.down("#ok").clearListeners();a.down("#cancel").clearListeners();a.focusOnClose&&a.focusOnClose.focus()});a.callParent(arguments)},generateTitle:function(){var d="Export";if(this.itemName){d="Export "+this.itemName}var c=100;d=Ext.util.Format.ellipsis(d,c);var b=Ext.getBody().getViewSize();var a=new Ext.util.TextMetrics();var e=a.getWidth(d);while(e>((b.width*0.8))){c-=5;d=Ext.util.Format.ellipsis(d,c);e=a.getWidth(d)}a.destroy();return Ext.htmlEncode(d)}});Ext.define("Ozone.components.admin.StacksGrid",{extend:"Ext.grid.Panel",alias:["widget.stacksgrid"],plugins:new Ozone.components.focusable.FocusableGridPanel(),cls:"grid-stack",title:"Stacks",columns:[{itemId:"id",header:"ID",dataIndex:"id",sortable:true,hidden:true},{header:"Title",dataIndex:"name",flex:8,renderer:function(a){return a?Ext.htmlEncode(a):""}},{header:"URL Name",dataIndex:"stackContext",flex:4,hidden:true,renderer:function(e,b,a,f,d,c){return Ext.htmlEncode(e)}},{header:"Dashboards",dataIndex:"totalDashboards",flex:3,sortable:false},{header:"Widgets",dataIndex:"totalWidgets",flex:3,sortable:false},{header:"Groups",dataIndex:"totalGroups",flex:3,sortable:false},{header:"Users",dataIndex:"totalUsers",flex:3,sortable:false}],defaultPageSize:50,multiSelect:true,initComponent:function(){Ext.apply(this,{columnLines:true});this.store=Ext.create("Ozone.data.StackStore",{id:"stackstore",autoLoad:false,pageSize:this.defaultPageSize});this.bbar=Ext.create("Ext.toolbar.Paging",{itemId:"bottomBar",store:this.store,pageSize:this.pageSize,displayInfo:true});this.relayEvents(this.store,["datachanged"]);this.callParent(arguments)},applyFilter:function(d,a){this.store.proxy.extraParams=undefined;if(d){var c=[];for(var b=0;b<a.length;b++){c.push({filterField:a[b],filterValue:d})}this.store.proxy.extraParams={filters:Ext.JSON.encode(c),filterOperator:"OR"}}if(this.baseParams){this.setBaseParams(this.baseParams)}this.store.loadPage(1,{params:{offset:0,max:this.pageSize}})},clearFilter:function(){this.store.proxy.extraParams=undefined;if(this.baseParams){this.setBaseParams(this.baseParams)}this.store.load({params:{start:0,max:this.pageSize}})},setBaseParams:function(a){this.baseParams=a;if(this.store.proxy.extraParams){Ext.apply(this.store.proxy.extraParams,a)}else{this.store.proxy.extraParams=a}},setStore:function(b,c){this.reconfigure(b,c);var a=this.getBottomToolbar();if(a){a.bindStore(b)}},getTopToolbar:function(){return this.getDockedItems('toolbar[dock="top"]')[0]},getBottomToolbar:function(){return this.getDockedItems('toolbar[dock="bottom"]')[0]},load:function(){this.store.loadPage(1)},refresh:function(){this.store.loadPage(this.store.currentPage)}});Ext.define("Ozone.components.admin.stack.StackDetailPanel",{extend:"Ext.panel.Panel",alias:["widget.stackdetailpanel"],viewStack:null,initComponent:function(){this.viewStack=Ext.create("Ext.view.View",{store:Ext.create("Ext.data.Store",{storeId:"storeStackItem",fields:[{name:"name",type:"string"},{name:"description",type:"string"},{name:"stackContext",type:"string"}]}),deferEmptyText:false,tpl:new Ext.XTemplate('<tpl for=".">','<div class="selector">','<div id="detail-info" class="detail-info">','<div class="detail-header-block">','<div class="detail-icon-block">','<div class="detail-title">{name:htmlEncode}</div>',"</div>","</div>",'<div class="detail-block">','<div><span class="detail-label">Stack URL:</span></div>','<div><span class="detail-link">{stackContext:this.renderStackUrl}</span></div>',"</div>",'<div class="detail-block">','<div><span class="detail-label">Description:</span></div>',"<div>{description:htmlEncode}</div>","</div>","</div>","</div>","</tpl>",{compiled:true,renderStackUrl:function(b){b=Ext.htmlEncode(b);var a=OWF.getContainerUrl()+"/#stack="+b;return'<a href="'+a+'" target="_top">'+a+"</a>"}}),emptyText:"No stack selected",itemSelector:"div.selector",autoScroll:"true"});this.items=[this.viewStack];this.callParent(arguments)},loadData:function(a){this.viewStack.store.loadData([a],false)},removeData:function(){this.viewStack.store.removeAll(false)}});Ext.define("Ozone.components.admin.stack.StackManagementPanel",{extend:"Ozone.components.admin.ManagementPanel",alias:["widget.stackmanagement"],layout:"fit",gridStacks:null,pnlStackDetail:null,txtHeading:null,lastAction:null,guid_EditCopyWidget:null,widgetStateHandler:null,dragAndDrop:true,launchesWidgets:true,channel:"AdminChannel",defaultTitle:"Stacks",minButtonWidth:80,detailsAutoOpen:true,initComponent:function(){var a=this;OWF.Preferences.getUserPreference({namespace:"owf.admin.StackEditCopy",name:"guid_to_launch",onSuccess:function(b){a.guid_EditCopyWidget=b.value},onFailure:function(b){a.showAlert("Preferences Error","Error looking up Stack Editor: "+b)}});this.gridStacks=Ext.create("Ozone.components.admin.StacksGrid",{preventHeader:true,region:"center",border:false});this.gridStacks.store.proxy.extraParams={adminEnabled:true};this.gridStacks.store.load({params:{offset:0,max:this.pageSize}});this.relayEvents(this.gridStacks,["datachanged","select","deselect","itemdblclick"]);this.pnlStackDetail=Ext.create("Ozone.components.admin.stack.StackDetailPanel",{layout:{type:"fit",align:"stretch"},region:"east",preventHeader:true,collapseMode:"mini",collapsible:true,collapsed:true,split:true,border:false,width:200});this.txtHeading=Ext.create("Ext.toolbar.TextItem",{text:'<span class="heading-bold">'+this.defaultTitle+"</span>"});this.searchBox=Ext.widget("searchbox");this.items=[{xtype:"panel",layout:"border",border:false,items:[this.gridStacks,this.pnlStackDetail]}];this.dockedItems=[{xtype:"toolbar",dock:"top",layout:{type:"hbox",align:"stretchmax"},items:[this.txtHeading,{xtype:"tbfill"},this.searchBox]},{xtype:"toolbar",dock:"bottom",ui:"footer",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"button",text:"Create",handler:function(c,b){b.stopPropagation();a.doCreate()}},{xtype:"splitbutton",text:"Edit",itemId:"btnEdit",handler:function(){var b=a.gridStacks.getSelectionModel().getSelection();if(b&&b.length>0){for(var c=0;c<b.length;c++){a.doEdit(b[c].data.id,b[c].data.name)}}else{a.showAlert("Error","You must select at least one stack to edit.")}},menu:{xtype:"menu",plain:true,hideMode:"display",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"owfmenuitem",text:"Export",handler:function(c){var b=a.gridStacks.getSelectionModel().getSelection();if(b&&b.length===1){a.doExport("stack",b[0])}else{if(b&&b.length>1){a.showAlert("Error","You must select only one stack to export.")}else{a.showAlert("Error","You must select a stack to export.")}}}}]}},{xtype:"button",text:"Delete",itemId:"btnDelete",handler:function(b){a.doDelete()}}]}];this.on("datachanged",function(b,c){if(this.pnlStackDetail!=null){this.pnlStackDetail.collapse();this.pnlStackDetail.removeData()}if(!this.disableLaunchMenuRefresh){this.refreshWidgetLaunchMenu()}},this);this.on("select",function(e,b,c,d){this.pnlStackDetail.loadData(b);if(this.pnlStackDetail.collapsed&&this.detailsAutoOpen){this.pnlStackDetail.expand()}},this);this.searchBox.on("searchChanged",function(b,c){this.gridStacks.applyFilter(c,["name","description","stackContext"])},this);this.on("itemdblclick",function(d,c,g,e,b,f){this.doEdit(c.data.id,c.data.name)},this);this.gridStacks.getView().on("itemkeydown",function(d,c,f,e,b){switch(b.getKey()){case b.SPACE:case b.ENTER:this.doEdit(c.data.id,c.data.name)}},this);this.callParent(arguments);OWF.Eventing.subscribe("AdminChannel",owfdojo.hitch(this,function(b,d,c){if(d.domain==="Stack"){this.gridStacks.getBottomToolbar().doRefresh()}}));this.on("afterrender",function(){var b=this.el.down(".x-collapse-el");b.on("click",function(){var c=this.el.down(".x-splitter-collapsed");if(c){this.detailsAutoOpen=true}else{this.detailsAutoOpen=false}},this)},this)},launchFailedHandler:function(a){if(a.error){this.showAlert("Launch Error","Stack Editor Launch Failed: "+a.message)}},doEdit:function(c,b){var a=Ozone.util.toString({id:c,copyFlag:false});OWF.Launcher.launch({title:"$1 - "+b,titleRegex:/(.*)/,guid:this.guid_EditCopyWidget,launchOnlyIfClosed:false,data:a},this.launchFailedHandler)},doDelete:function(){var a=this.gridStacks.getSelectionModel().getSelection();if(a&&a.length>0){var b="This action will permanently delete ";if(a.length===1){b+='<span class="heading-bold">'+Ext.htmlEncode(a[0].data.name)+"</span>."}else{b+='the selected <span class="heading-bold">'+a.length+" stacks</span>."}this.showConfirmation("Warning",b,function(e,g,f){if(e=="ok"){var c=this.gridStacks.getStore();c.remove(a);var d=c.getTotalCount()-a.length;c.on({write:{fn:function(){if(c.data.items.length==0&&c.currentPage>1){var i=c.getPageFromRecordIndex(d-1);var h=(i>=c.currentPage)?c.currentPage:i;c.loadPage(h)}this.gridStacks.getBottomToolbar().doRefresh();this.pnlStackDetail.removeData();if(!this.pnlDashboardDetail.collapsed){this.pnlDashboardDetail.collapse()}this.refreshWidgetLaunchMenu()},scope:this,single:true}});c.save()}})}else{this.showAlert("Error","You must select at least one stack to delete.")}}});