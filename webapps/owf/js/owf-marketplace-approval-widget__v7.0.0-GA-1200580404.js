Ext.define("Ozone.data.WidgetDefinition",{extend:"Ext.data.Model",idProperty:"widgetGuid",fields:[{name:"id",mapping:"id"},{name:"name",mapping:"value.namespace"},{name:"originalName",mapping:"value.originalName"},{name:"version",mapping:"value.widgetVersion"},{name:"description",mapping:"value.description"},{name:"url",mapping:"value.url"},{name:"headerIcon",mapping:"value.headerIcon"},{name:"image",mapping:"value.image"},{name:"width",mapping:"value.width"},{name:"height",mapping:"value.height"},{name:"widgetGuid",mapping:"path"},{name:"universalName",mapping:"value.universalName"},{name:"maximized",mapping:"value.maximized"},{name:"minimized",mapping:"value.minimized"},{name:"x",mapping:"value.x"},{name:"y",mapping:"value.y"},{name:"visible",mapping:"value.visible"},{name:"definitionVisible",mapping:"value.definitionVisible"},{name:"background",mapping:"value.background"},{name:"disabled",mapping:"value.disabled"},{name:"editable",mapping:"value.editable"},{name:"tags",mapping:"value.tags"},{name:"singleton",mapping:"value.singleton"},{name:"allRequired",mapping:"value.allRequired"},{name:"directRequired",mapping:"value.directRequired"},{name:"userId",mapping:"value.userId"},{name:"userRealName",mapping:"value.userRealName"},{name:"totalUsers",mapping:"value.totalUsers"},{name:"totalGroups",mapping:"value.totalGroups"},{name:"widgetTypes",mapping:"value.widgetTypes"},{name:"descriptorUrl",mapping:"value.descriptorUrl"},{name:"intents",mapping:"value.intents"},{name:"title",mapping:"value.namespace"},{name:"groups",mapping:"value.groups"},{name:"disabled",mapping:"value.disabled"}]});Ext.define("Ozone.data.stores.AdminWidgetStore",{extend:"Ozone.data.OWFStore",model:"Ozone.data.WidgetDefinition",alias:"store.adminwidgetstore",remoteSort:true,sorters:[{property:"name",direction:"ASC"}],constructor:function(a){Ext.applyIf(a,{api:{read:"/widget",create:"/widget",update:"/widget",destroy:"/widget"}});this.callParent(arguments)}});Ext.define("Ozone.data.stores.WidgetApprovalStore",{extend:"Ozone.data.OWFStore",model:"Ozone.data.WidgetDefinition",alias:"store.widgetapprovalstore",sorters:[{property:"name",direction:"ASC"}],constructor:function(a){Ext.applyIf(a,{api:{read:"/widget/listUserWidgets"}});this.callParent(arguments)}});Ext.define("Ozone.components.admin.grid.WidgetApprovalsGrid",{extend:"Ext.grid.Panel",alias:["widget.widgetapprovalsgrid"],plugins:new Ozone.components.focusable.FocusableGridPanel(),cls:"grid-widget",defaultPageSize:50,baseParams:{tags:Ozone.config.carousel.pendingApprovalTagGroupName},initComponent:function(){if(this.store==null){this.store=Ext.StoreMgr.lookup({type:"widgetapprovalstore",pageSize:this.defaultPageSize})}if(this.baseParams){this.setBaseParams(this.baseParams)}Ext.apply(this,{selModel:Ext.create("Ext.selection.CheckboxModel"),columnLines:true,columns:[{itemId:"widgetGuid",header:"Widget GUID",dataIndex:"widgetGuid",flex:1,minWidth:210,sortable:true,hidden:true,renderer:function(f,c,b,g,e,d,a){return'<div class="grid-text">'+Ext.htmlEncode(f)+"</div>"}},{itemId:"name",header:"Widget",dataIndex:"name",flex:1,minWidth:200,sortable:true,renderer:function(m,b,f,j,g,n,k){var l=m;var a=f.get("headerIcon");var d=Ozone.util.contextPath();if(!a.match(new RegExp("^/?"+d+"/.*$","i"))&&!a.match(new RegExp("^https?://.*","i"))){if(a.indexOf("/")==0){a=d+a}else{a=d+"/"+a}var i=/admin\/64x64_blue_dashboard.png/g;var h=/admin\/64x64_blue_group.png/g;var e=/admin\/64x64_blue_user.png/g;var o=/admin\/64x64_blue_widget.png/g;if(a.match(i)){a=a.replace(i,"admin/24x24_blue_dashboard.png")}else{if(a.match(h)){a=a.replace(h,"admin/24x24_blue_group.png")}else{if(a.match(e)){a=a.replace(e,"admin/24x24_blue_user.png")}else{if(a.match(o)){a=a.replace(o,"admin/24x24_blue_widget.png")}}}}}var c='<div class="grid-icon-and-text-title-box"><div class="grid-icon-and-text-icon"><img class="grid-icon-and-text-icon-image" src="'+Ext.htmlEncode(a)+'">';c+="</div>";c+='<div class="grid-icon-and-text-title">'+Ext.htmlEncode(l)+"</div>";return c}},{itemId:"userId",header:"Requesting User Name",dataIndex:"userId",minWidth:200,flex:1,sortable:true,hidden:true,renderer:function(f,c,b,g,e,d,a){return'<div class="grid-text">'+Ext.htmlEncode(f)+"</div>"}},{itemId:"userRealName",header:"Requesting User",dataIndex:"userRealName",minWidth:200,flex:1,sortable:true,renderer:function(f,c,b,g,e,d,a){return'<div class="grid-text">'+Ext.htmlEncode(f)+"</div>"}}]});Ext.apply(this,{multiSelect:true,dockedItems:[Ext.create("Ext.toolbar.Paging",{dock:"bottom",store:this.store,displayInfo:true,hidden:this.hidePagingToolbar,itemId:"widget-grid-paging"})]});this.callParent(arguments);this.on("afterrender",function(b){var a=b.getEl().select(".x-column-header-checkbox").first();Ozone.components.focusable.Focusable.setupFocus(a);a.on("keydown",function(c){if(c.getKey()===c.SPACE){if(a.hasCls("x-grid-hd-checker-on")){this.getView().getSelectionModel().deselectAll()}else{this.getView().getSelectionModel().selectAll()}}},b)})},load:function(){this.store.loadPage(1)},refresh:function(){this.store.loadPage(this.store.currentPage)},getTopToolbar:function(){return this.getDockedItems('toolbar[dock="top"]')[0]},getBottomToolbar:function(){return this.getDockedItems('toolbar[dock="bottom"]')[0]},applyFilter:function(d,a){this.store.proxy.extraParams=undefined;if(d){var c=[];for(var b=0;b<a.length;b++){c.push({filterField:a[b],filterValue:d})}this.store.proxy.extraParams={filters:Ext.JSON.encode(c),filterOperator:"OR"}}if(this.baseParams){this.setBaseParams(this.baseParams)}this.store.loadPage(1,{params:{offset:0,max:this.store.pageSize}})},clearFilters:function(){this.store.proxy.extraParams=undefined;if(this.baseParams){this.setBaseParams(this.baseParams)}this.store.load({params:{start:0,max:this.store.pageSize}})},setBaseParams:function(a){this.baseParams=a;if(this.store.proxy.extraParams){Ext.apply(this.store.proxy.extraParams,a)}else{this.store.proxy.extraParams=a}},setStore:function(b,c){this.reconfigure(b,c);var a=this.getBottomToolbar();if(a){a.bindStore(b)}}});Ext.define("Ozone.components.admin.widget.WidgetDetailPanel",{extend:"Ext.panel.Panel",alias:["widget.widgetdetailpanel"],layout:{type:"vbox",align:"stretch"},viewGroup:null,initComponent:function(){var a=this;OWF.Preferences.getUserPreference({namespace:"owf.admin.WidgetEditCopy",name:"guid_to_launch",onSuccess:function(b){a.guid_EditCopyWidget=b.value},onFailure:function(b){Ext.Msg.alert("Preferences Error","Error looking up Widget Editor: "+b)}});if(this.store==null){this.store=Ext.StoreMgr.lookup({type:"adminwidgetstore"})}this.viewGroup=Ext.create("Ext.view.View",{cls:"widgetDetailsView",store:this.store,deferEmptyText:false,flex:1,tpl:new Ext.XTemplate('<tpl for=".">','<div class="detail-info">','<div class="detail-header-block">','<div class="detail-widget">','<div class="detail-icon">','<img src={image:this.renderImage} title="{name:htmlEncode}" class="detail-icon-image">',"</div>","</div>",'<div class="detail-icon-block">','<div class="detail-title">{name:htmlEncode}</div>','<div><span class="detail-label">Version:</span> {version:htmlEncode}</div>',"</div>","</div>",'<div class="detail-block">','<div><span class="detail-label">Description:</span> {description:htmlEncode}</div>','<div><span class="detail-label">Universal Name:</span> {universalName:htmlEncode}</div>','<div><span class="detail-label">Default Tags:</span> {tags:this.renderTags}</div>','<div><span class="detail-label">Single Instance:</span> {singleton}</div>','<div><span class="detail-label">Visible:</span> {definitionVisible}</div>','<div><span class="detail-label">Background:</span> {background}</div>','<div><span class="detail-label">Requires Widgets:</span> {directRequired:this.renderRequiresFlag}</div>','<div><span class="detail-label">Width:</span> {width}</div>','<div><span class="detail-label">Height:</span> {height}</div>',"</div>","</div>","</tpl>",{compiled:true,renderImage:function(c){var b=Ozone.util.contextPath();if(!c.match(new RegExp("^/?"+b+"/.*$","i"))&&!c.match(new RegExp("^https?://.*","i"))){if(c.indexOf("/")==0){c=b+c}else{c=b+"/"+c}}return encodeURI(decodeURI(c))},renderTags:function(b){var d="";if(b!=null){for(var c=0;c<b.length;c++){d+=Ext.htmlEncode(b[c].name);if(c<b.length-1){d+=", "}}}if(d==""){d="<i>none</i>"}return d},renderRequiresFlag:function(b){return b!=null&&b.length>0}}),emptyText:"No widget selected",itemSelector:"div.mpDetailSummary",autoScroll:"true"});this.items=[this.viewGroup,{xtype:"grid",itemId:"reqGrid",cls:"reqGrid",autoScroll:true,hidden:true,hideHeaders:true,forceFit:true,flex:1,border:false,store:{type:"adminwidgetstore",remoteSort:false},dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"tbtext",text:"This Widget Requires:"}]}],columns:[{itemId:"name",header:"Title",dataIndex:"name",flex:1,minWidth:200,sortable:true,renderer:function(k,c,f,h,g,l,i){var j=k;var b=f.get("headerIcon");var e=Ozone.util.contextPath();if(!b.match(new RegExp("^/?"+e+"/.*$","i"))&&!b.match(new RegExp("^https?://.*","i"))){if(b.indexOf("/")==0){b=e+b}else{b=e+"/"+b}}var d='<div class="grid-widget"><div class="grid-icon-and-text-title-box"><div class="grid-icon-and-text-icon"><img class="grid-icon-and-text-icon-image" src="'+b+'"> ';d+="</div>";d+='<div class="grid-icon-and-text-title">'+j+"</div>";return d}}],listeners:{itemdblclick:{fn:function(b){var c=b.getSelectionModel().getSelection();if(c&&c.length>0){for(var d=0;d<c.length;d++){this.doEdit(c[d].data.id,c[d].data.name)}}else{Ext.Msg.alert("Error","You must select at least one widget to edit.")}},scope:this}}}];this.callParent(arguments)},clear:function(){this.load(null)},load:function(b){var a=this.getComponent("reqGrid");var c=[];if(b!=null){c.push(b)}this.viewGroup.store.loadData(c,false);if(b!=null&&b.data.allRequired!=null&&b.data.allRequired.length>0){this.requestFrom=b.data.id;Ext.Ajax.request({url:Ozone.util.contextPath()+"/widget",params:{id:b.data.allRequired,_method:"GET"},success:function(e,h){var g=Ext.decode(e.responseText);if(g){var j=g.data;if(j!=null&&j.length>0){var d=[];if(j){for(var f=0;f<j.length;f++){d.push({id:j[f].path,name:j[f].value.namespace,version:j[f].value.widgetVersion,url:j[f].value.url,headerIcon:j[f].value.headerIcon,image:j[f].value.image,width:j[f].value.width,height:j[f].value.height,widgetGuid:j[f].path,maximized:j[f].value.maximized,minimized:j[f].value.minimized,x:j[f].value.x,y:j[f].value.y,visible:j[f].value.visible,tags:j[f].value.tags,totalUsers:j[f].value.totalUsers,totalGroups:j[f].value.totalGroups,singleton:j[f].value.singleton})}}if(a&&this.store.getAt(0).get("id")==this.requestFrom){a.store.loadData(d);a.setVisible(true)}}else{if(a){a.store.removeAll(true);a.setVisible(false)}}}},failure:function(d,e){Ext.Msg.alert("Server Error","Error retrieving required widgets: "+d)},scope:this})}else{if(a){a.store.removeAll(true);a.setVisible(false)}}},doEdit:function(c,b){var a=Ozone.util.toString({id:c,copyFlag:false});OWF.Launcher.launch({title:"$1 - "+b,titleRegex:/(.*)/,guid:this.guid_EditCopyWidget,launchOnlyIfClosed:false,data:a},function(d){if(d.error){Ext.Msg.alert("Launch Error","Widget Editor Launch Failed: "+d.message)}})}});Ext.define("Ozone.components.admin.widget.ApprovePanel",{extend:"Ext.panel.Panel",alias:["widget.approvepanel","widget.Ozone.components.admin.widget.ApprovePanel"],widgets:null,itemId:"approvepanel",cls:"approvepanel",initComponent:function(){this.addEvents(["approve","cancel"]);if(this.store==null){this.store=Ext.StoreMgr.lookup({type:"adminwidgetstore"})}Ext.apply(this,{layout:{type:"vbox",align:"stretch"},items:[{xtype:"component",itemId:"titlePanel",cls:"titlePanel",layout:"fit",border:false,height:30,renderTpl:["You have selected to approve {name}."],renderData:{name:"0 widget(s)"}},{xtype:"component",itemId:"reqTitlePanel",cls:"reqTitlePanel",layout:"fit",border:false,height:50,renderTpl:["These widgets are required by other widgets in OWF. Approving these widgets will additionally approve the widgets listed below."]},{xtype:"grid",itemId:"reqGrid",autoScroll:true,forceFit:true,flex:1,border:false,store:{type:"adminwidgetstore",remoteSort:false},columns:[{itemId:"name",header:"Title",dataIndex:"name",flex:1,minWidth:200,sortable:true,renderer:function(j,b,e,g,f,k,h){var i=j;var a=e.get("headerIcon");var d=Ozone.util.contextPath();if(!a.match(new RegExp("^/?"+d+"/.*$","i"))&&!a.match(new RegExp("^https?://.*","i"))){if(a.indexOf("/")==0){a=d+a}else{a=d+"/"+a}}var c='<div class="grid-widget"><div class="grid-icon-and-text-title-box"><div class="grid-icon-and-text-icon"><img class="grid-icon-and-text-icon-image" src="'+a+'"> ';c+="</div>";c+='<div class="grid-icon-and-text-title">'+i+"</div>";return c}},{itemId:"widgetUrl",header:"URL",dataIndex:"url",flex:1,minWidth:250,menuDisabled:true,sortable:true}]}],buttons:[{text:Ozone.layout.DialogMessages.ok,handler:function(a){this.approve()},scope:this},{text:"Cancel",handler:function(a){this.cancel()},scope:this}]});this.callParent();this.on({afterrender:{fn:function(){if(this.widgets!=null){this.loadData(this.widgets)}},scope:this}})},loadData:function(c){if(c!=null){this.store.loadData(c);var d=this.down("#titlePanel");var b=this.store.getCount();var g={name:b>1?('<span class="heading-bold">'+b+"</span> widgets"):('<span class="heading-bold">'+this.store.getAt(0).data.name+"</span>")};if(d.rendered){d.renderTpl.overwrite(d.getTargetEl(),g)}else{d.renderData=g}var f=this.requiredWidgets;var a=this.down("#reqGrid");var e=a.getStore();if(e){e.removeAll();if(f.length>0){e.loadData(f)}this.doLayout()}}},approve:function(){var e=this.store.getRange();var a=this.down("#reqGrid");var d=a.getStore();var b=d.getRange();var c=e.concat(b);this.fireEvent("approve",{widgetRecs:c})},cancel:function(){this.fireEvent("cancel")},down:function(a){if(this.cmpCache==null){this.cmpCache=Ext.create("Ext.util.MixedCollection")}var b=this.cmpCache.getByKey(a);if(b==null){b=this.callParent(arguments);if(b!=null){this.cmpCache.add(a,b)}}return b}});Ext.define("Ozone.components.admin.widget.WidgetApprovalPanel",{extend:"Ozone.components.admin.ManagementPanel",alias:["widget.WidgetApprovalPanel","widget.widgetapprovalpanel","widget.Ozone.components.admin.widget.WidgetApprovalPanel"],dragAndDrop:true,launchesWidgets:true,channel:"AdminChannel",defaultTitle:"Widget Requests",minButtonWidth:80,cls:"widgetapprovalpanel",detailsAutoOpen:true,initComponent:function(){var a=this;Ext.apply(this,{xtype:"panel",itemId:"main",layout:{type:"border"},items:[{xtype:"widgetapprovalsgrid",itemId:"grid",border:false,region:"center"},{xtype:"widgetdetailpanel",itemId:"widgetdetailpanel",store:Ext.create("Ozone.data.stores.WidgetApprovalStore"),region:"east",preventHeader:true,collapseMode:"mini",collapsible:true,collapsed:true,split:true,border:false,width:300}],dockedItems:[{xtype:"toolbar",dock:"top",layout:{type:"hbox",align:"stretchmax"},items:[{itemId:"tbtext",xtype:"tbtext",text:'<span class="heading-bold">'+this.defaultTitle+" </span>"},"->",{xtype:"searchbox",listeners:{searchChanged:function(c,d){var b=a.down("#grid");if(b!=null){b.applyFilter(d,["name","userId","userRealName"])}}}}]},{xtype:"toolbar",dock:"bottom",ui:"footer",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"button",text:"Approve",itemId:"approveButton",handler:function(){var c=this.down("#grid");var b=c.getSelectionModel().getSelection();if(b&&b.length>0){this.approve(b)}else{a.showAlert("Error","You must select at least one widget to approve.")}},scope:this},{xtype:"button",text:"Reject",itemId:"rejectButton",handler:function(){var c=this.down("#grid");var b=c.getSelectionModel().getSelection();if(b&&b.length>0){this.reject(b)}else{a.showAlert("Error","You must select at least one widget to reject.")}},scope:this}]}]});this.callParent();this.on({render:{fn:function(){var b=this.down("#grid");if(b!=null){b.on({select:{fn:function(g,c,d,e){var f=this.down("#widgetdetailpanel");if(f!=null){f.load(c);if(this.detailsAutoOpen){f.expand()}}},scope:this}});b.load();b.store.on({datachanged:{fn:function(){var c=this.down("#widgetdetailpanel");if(c!=null){c.collapse();c.clear()}if(!this.disableLaunchMenuRefresh){this.refreshWidgetLaunchMenu()}},scope:this}})}},scope:this},afterrender:{fn:function(){var b=this.el.down(".x-collapse-el");b.on("click",function(){var c=this.el.down(".x-splitter-collapsed");if(c){this.detailsAutoOpen=true}else{this.detailsAutoOpen=false}},this)},scope:this}})},createApprovalWindow:function(g){var h=this;var b=Ext.create("Ext.util.MixedCollection");b.getKey=function(i){return i};var f=Ext.create("Ext.util.MixedCollection");b.getKey=function(i){return i};var e=Ext.create("Ext.util.MixedCollection");e.getKey=function(i){return i.userId+"-"+i.widgetGuid};if(g!=null){for(var d=0;d<g.length;d++){var a=g[d].data;b.add(a.widgetGuid);e.add({userId:a.userId,widgetGuid:a.widgetGuid});if(a.allRequired!=null&&a.allRequired.length>0){for(var c=0;c<a.allRequired.length;c++){f.add(a.allRequired[c]);e.add({userId:a.userId,widgetGuid:a.allRequired[c]})}}}}Ext.Ajax.request({url:Ozone.util.contextPath()+"/widget",params:{id:f.getRange(),_method:"GET"},success:function(l,j){var r=Ext.decode(l.responseText);if(r){var m=r.data;if(m!=null&&m.length>0){var o=[];if(m){for(var n=0;n<m.length;n++){var q={id:m[n].id,name:m[n].value.namespace,version:m[n].value.widgetVersion,url:m[n].value.url,headerIcon:m[n].value.headerIcon,image:m[n].value.image,width:m[n].value.width,height:m[n].value.height,widgetGuid:m[n].path,maximized:m[n].value.maximized,minimized:m[n].value.minimized,x:m[n].value.x,y:m[n].value.y,visible:m[n].value.visible,tags:m[n].value.tags,userId:m[n].value.userId,userRealName:m[n].value.userRealName,totalUsers:m[n].value.totalUsers,totalGroups:m[n].value.totalGroups,singleton:m[n].value.singleton};if(!b.containsKey(q.widgetGuid)){o.push(q)}}}var k="You have selected to approve ";var p=g.length;k+=p>1?('<span class="heading-bold">'+p+"</span> widgets"):('<span class="heading-bold">'+g[0].data.name+"</span>");k+=". <br/><br/> "+(p>1?"These widgets require":"This widget requires")+" other widget(s) in OWF. Approving "+(p>1?"these widgets":"this widget ")+" will automatically approve "+(p>1?"their":"its")+" required widget(s).";this.showConfirmation("Warning",k,function(i,t,s){if(i=="ok"){this.doApproveReject(e.getRange())}})}}},failure:function(i,j){h.showAlert("Error","Error retrieving required widgets.")},scope:this})},approve:function(c){var a=false;if(c!=null){for(var b=0;b<c.length;b++){if(c[b].data.allRequired!=null&&c[b].data.allRequired.length>0){a=true;break}}if(a){this.createApprovalWindow(c)}else{this.doApproveReject(c)}}},reject:function(a){this.doApproveReject(null,a)},doApproveReject:function(b,e){var j=[];var g=[];var a=new Date();var h=Ext.Date.format(a,"Y-m-d");if(b){for(var d=0,f=b.length;d<f;d++){var c=b[d].data!=null?b[d].data:b[d];j.push({userId:c.userId,widgetGuid:c.widgetGuid})}}if(e){for(var d=0,f=e.length;d<f;d++){var c=e[d].data!=null?e[d].data:e[d];g.push({userId:c.userId,widgetGuid:c.widgetGuid})}}Ext.Ajax.request({url:Ozone.util.contextPath()+"/widget/approve",method:"POST",timeout:30000,autoAbort:false,disableCaching:true,params:{toApprove:Ext.encode(j),toDelete:Ext.encode(g)},scope:this,success:function(){var i=this.down("#grid");i.refresh();var k=Ext.getCmp("approvewindow");if(k){k.close()}},failure:function(){me.showAlert("Error","Server Error during approve or reject.");var i=Ext.getCmp("approvewindow");if(i){i.close()}}})}});