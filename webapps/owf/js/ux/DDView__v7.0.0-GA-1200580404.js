Ext.define("Ext.ux.DDView",{extend:"Ext.view.View",sortDir:"ASC",isFormField:true,classRe:/class=(['"])(.*)\1/,tagRe:/(<\w*)(.*?>)/,reset:Ext.emptyFn,clearInvalid:Ext.form.field.Field.prototype.clearInvalid,constructor:function(b){if(!b.itemSelector){var a=b.tpl;if(this.classRe.test(a)){b.tpl=a.replace(this.classRe,"class=$1x-combo-list-item $2$1")}else{b.tpl=a.replace(this.tagRe,'$1 class="x-combo-list-item" $2')}b.itemSelector=".x-combo-list-item"}this.callParent([Ext.apply(b,{border:false})])},afterRender:function(){Ext.ux.DDView.superclass.afterRender.call(this);if(this.dragGroup){this.setDraggable(this.dragGroup.split(","))}if(this.dropGroup){this.setDroppable(this.dropGroup.split(","))}if(this.deletable){this.setDeletable()}this.isDirtyFlag=false;this.addEvents("drop")},validate:function(){return true},destroy:function(){this.clearListeners();this.getEl().removeAllListeners();this.getEl().remove();if(this.dragZone){if(this.dragZone.destroy){this.dragZone.destroy()}}if(this.dropZone){if(this.dropZone.destroy){this.dropZone.destroy()}}},getName:function(){return this.name},setValue:function(a){if(!this.store){throw"DDView.setValue(). DDView must be constructed with a valid Store"}var b={};b[this.store.reader.meta.root]=a?[].concat(a):[];this.store.proxy=new Ext.data.MemoryProxy(b);this.store.load()},getValue:function(){var a="(";this.store.each(function(b){a+=b.id+","});return a.substr(0,a.length-1)+")"},getIds:function(){var b=0,a=new Array(this.store.getCount());this.store.each(function(c){a[b++]=c.id});return a},isDirty:function(){return this.isDirtyFlag},getTargetFromEvent:function(b){var a=b.getTarget();while((a!==null)&&(a.parentNode!=this.el.dom)){a=a.parentNode}if(!a){a=this.el.dom.lastChild||this.el.dom}return a},getDragData:function(d){var c=this.findItemFromChild(d.getTarget());if(c){if(!this.isSelected(c)){delete this.ignoreNextClick;this.onItemClick(c,this.indexOf(c),d);this.ignoreNextClick=true}var b={sourceView:this,viewNodes:[],records:[],copy:this.copy||(this.allowCopy&&d.ctrlKey)};if(this.getSelectionCount()==1){var a=this.getSelectedIndexes()[0];var f=this.getNode(a);b.viewNodes.push(b.ddel=f);b.records.push(this.store.getAt(a));b.repairXY=Ext.fly(f).getXY()}else{b.ddel=document.createElement("div");b.ddel.className="multi-proxy";this.collectSelection(b)}return b}return false},getRepairXY:function(a){return this.dragData.repairXY},collectSelection:function(b){b.repairXY=Ext.fly(this.getSelectedNodes()[0]).getXY();if(this.preserveSelectionOrder===true){Ext.each(this.getSelectedIndexes(),function(c){var e=this.getNode(c);var d=e.cloneNode(true);d.id=Ext.id();b.ddel.appendChild(d);b.records.push(this.store.getAt(c));b.viewNodes.push(e)},this)}else{var a=0;this.store.each(function(d){if(this.isSelected(a)){var e=this.getNode(a);var c=e.cloneNode(true);c.id=Ext.id();b.ddel.appendChild(c);b.records.push(this.store.getAt(a));b.viewNodes.push(e)}a++},this)}},setDraggable:function(a){if(a instanceof Array){Ext.each(a,this.setDraggable,this);return}if(this.dragZone){this.dragZone.addToGroup(a)}else{this.dragZone=new Ext.dd.DragZone(this.getEl(),{containerScroll:true,ddGroup:a});if(!this.multiSelect){this.singleSelect=true}this.dragZone.getDragData=this.getDragData.bind(this);this.dragZone.getRepairXY=this.getRepairXY;this.dragZone.onEndDrag=this.onEndDrag}},setDroppable:function(a){if(a instanceof Array){Ext.each(a,this.setDroppable,this);return}if(this.dropZone){this.dropZone.addToGroup(a)}else{this.dropZone=new Ext.dd.DropZone(this.getEl(),{owningView:this,containerScroll:true,ddGroup:a});this.dropZone.getTargetFromEvent=this.getTargetFromEvent.bind(this);this.dropZone.onNodeEnter=this.onNodeEnter.bind(this);this.dropZone.onNodeOver=this.onNodeOver.bind(this);this.dropZone.onNodeOut=this.onNodeOut.bind(this);this.dropZone.onNodeDrop=this.onNodeDrop.bind(this)}},getDropPoint:function(g,j,d){if(j==this.el.dom){return"above"}var f=Ext.lib.Dom.getY(j),a=f+j.offsetHeight;var i=f+(a-f)/2;var h=Ext.lib.Event.getPageY(g);if(h<=i){return"above"}else{return"below"}},isValidDropPoint:function(b,e,a){if(!a.viewNodes||(a.viewNodes.length!=1)){return true}var c=a.viewNodes[0];if(c==e){return false}if((b=="below")&&(e.nextSibling==c)){return false}if((b=="above")&&(e.previousSibling==c)){return false}return true},onNodeEnter:function(d,a,c,b){if(this.highlightColor&&(b.sourceView!=this)){this.el.highlight(this.highlightColor)}return false},onNodeOver:function(h,a,g,d){var b=this.dropNotAllowed;var f=this.getDropPoint(g,h,a);if(this.isValidDropPoint(f,h,d)){if(this.appendOnly||this.sortField){return"x-tree-drop-ok-below"}if(f){var c;if(f=="above"){b=h.previousSibling?"x-tree-drop-ok-between":"x-tree-drop-ok-above";c="x-view-drag-insert-above"}else{b=h.nextSibling?"x-tree-drop-ok-between":"x-tree-drop-ok-below";c="x-view-drag-insert-below"}if(this.lastInsertClass!=c){Ext.fly(h).replaceClass(this.lastInsertClass,c);this.lastInsertClass=c}}}return b},onNodeOut:function(d,a,c,b){this.removeDropIndicators(d)},onNodeDrop:function(c,k,h,f){if(this.fireEvent("drop",this,c,k,h,f)===false){return false}var l=this.getDropPoint(h,c,k);var d=(this.appendOnly||(c==this.el.dom))?this.store.getCount():c.viewIndex;if(l=="below"){d++}if(f.sourceView==this){if(l=="below"){if(f.viewNodes[0]==c){f.viewNodes.shift()}}else{if(f.viewNodes[f.viewNodes.length-1]==c){f.viewNodes.pop()}}if(!f.viewNodes.length){return false}if(d>this.store.indexOf(f.records[0])){d--}}if(f.node instanceof Ext.tree.TreeNode){var a=f.node.getOwnerTree().recordFromNode(f.node);if(a){f.records=[a]}}if(!f.records){alert("Programming problem. Drag data contained no Records");return false}for(var g=0;g<f.records.length;g++){var a=f.records[g];var b=this.store.getById(a.id);if(b&&(k!=this.dragZone)){if(!this.allowDup&&!this.allowTrash){Ext.fly(this.getNode(this.store.indexOf(b))).frame("red",1);return true}var j=new Ext.data.Record();a.id=j.id;delete j}if(f.copy){this.store.insert(d++,a.copy())}else{if(f.sourceView){f.sourceView.isDirtyFlag=true;f.sourceView.store.remove(a)}if(!this.allowTrash){this.store.insert(d++,a)}}if(this.sortField){this.store.sort(this.sortField,this.sortDir)}this.isDirtyFlag=true}this.dragZone.cachedTarget=null;return true},onEndDrag:function(a,b){var c=Ext.get(this.dragData.ddel);if(c&&c.hasClass("multi-proxy")){c.remove()}},removeDropIndicators:function(a){if(a){Ext.fly(a).removeCls(["x-view-drag-insert-above","x-view-drag-insert-left","x-view-drag-insert-right","x-view-drag-insert-below"]);this.lastInsertClass="_noclass"}},setDeletable:function(a){if(!this.singleSelect&&!this.multiSelect){this.singleSelect=true}var b=this.getContextMenu();this.contextMenu.on("itemclick",function(c){switch(c.id){case"delete":this.remove(this.getSelectedIndexes());break}},this);this.contextMenu.add({icon:a||AU.resolveUrl("/images/delete.gif"),id:"delete",text:AU.getMessage("deleteItem")})},getContextMenu:function(){if(!this.contextMenu){this.contextMenu=new Ext.menu.Menu({id:this.id+"-contextmenu"});this.el.on("contextmenu",this.showContextMenu,this)}return this.contextMenu},disableContextMenu:function(){if(this.contextMenu){this.el.un("contextmenu",this.showContextMenu,this)}},showContextMenu:function(b,a){a=this.findItemFromChild(b.getTarget());if(a){b.stopEvent();this.select(this.getNode(a),this.multiSelect&&b.ctrlKey,true);this.contextMenu.showAt(b.getXY())}},remove:function(b){b=[].concat(b);for(var a=0;a<b.length;a++){var c=this.store.getAt(b[a]);this.store.remove(c)}},onDblClick:function(f){var d=this.findItemFromChild(f.getTarget());if(d){if(this.fireEvent("dblclick",this,this.indexOf(d),d,f)===false){return false}if(this.dragGroup){var a=Ext.dd.DragDropMgr.getRelated(this.dragZone,true);while(a.indexOf(this.dropZone)!==-1){a.remove(this.dropZone)}if((a.length==1)&&(a[0].owningView)){this.dragZone.cachedTarget=null;var b=Ext.get(a[0].getEl());var c=b.getBox(true);a[0].onNodeDrop(b.dom,{target:b.dom,xy:[c.x,c.y+c.height-1]},null,this.getDragData(f))}}}},onItemClick:function(b,a,c){if(this.ignoreNextClick){delete this.ignoreNextClick;return}if(this.fireEvent("beforeclick",this,a,b,c)===false){return false}if(this.multiSelect||this.singleSelect){if(this.multiSelect&&c.shiftKey&&this.lastSelection){this.select(this.getNodes(this.indexOf(this.lastSelection),a),false)}else{if(this.isSelected(b)&&c.ctrlKey){this.deselect(b)}else{this.deselect(b);this.select(b,this.multiSelect&&c.ctrlKey);this.lastSelection=b}}c.preventDefault()}return true}});