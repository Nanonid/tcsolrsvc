Ext.define("Ozone.layout.CreateViewContainer",{extend:"Ext.form.Panel",alias:["widget.owfCreateDashboardsContainer","widget.owfCreateViewsContainer","widget.Ozone.layout.CreateViewContainer"],requires:["Ext.layout.container.Border"],border:false,config:{},views:null,dashboardContainer:null,itemId:"createNewDashboardPanel",cls:"cvc-createNewDashboardContainer",afterRenderInitComplete:false,createViewContainer_FormValid:true,hideViewSelectRadio:false,initComponent:function(){this.config=this.dashboardContainer.activeDashboard.config;this.views=this.dashboardContainer.dashboards;this.addEvents("saved","failed");this.titleBox={xtype:"textfield",name:"titleBox",cls:"titleBox",itemId:"titleBox",fieldLabel:Ozone.util.createRequiredLabel(Ozone.ux.DashboardMgmtString.title),labelSeparator:"",labelWidth:undefined,allowBlank:false,maxLength:200,value:"",enforceMaxLength:true,listeners:{blur:function(e){var f=e.getValue().replace(new RegExp(Ozone.lang.regexLeadingTailingSpaceChars),"");e.setValue(f)}}};this.description={xtype:"textareafield",name:"description",cls:"description",itemId:"description",fieldLabel:Ozone.ux.DashboardMgmtString.description,labelSeparator:"",labelWidth:undefined,value:"",maxLength:4000,enforceMaxLength:true};if(this.existingDashboardRecord!=null){this.titleBox.value=this.existingDashboardRecord.get("name");this.description.value=this.existingDashboardRecord.get("description")}this.existingViewRadio={boxLabel:Ozone.layout.CreateViewWindowString.createFromExisiting,name:"viewSelectRadio",inputValue:"copiedDashboard",cls:"existingViewRadio",listeners:{change:{fn:function(f,i,e){if(i){var h=this.down("#existViewCb");h.enable();h.validate();var g=this.down("#importFileupload");g.reset();g.disable()}},scope:this}},vtype:"copiedDashboard",copiedDashboardField:"existViewCb"};this.importedViewRadio={boxLabel:Ozone.layout.CreateViewWindowString.importView,name:"viewSelectRadio",inputValue:"importedDashboard",cls:"importedViewRadio",listeners:{change:{fn:function(f,i,e){if(i){var h=this.down("#existViewCb");h.reset();h.disable();var g=this.down("#importFileupload");g.enable();g.validate()}},scope:this}},vtype:"importedDashboard",importedDashboardField:"importFileupload"};this.existingView={xtype:"combo",itemId:"existViewCb",store:this.dashboardContainer.dashboardStore,valueField:"guid",displayField:"name",hideLabel:true,typeAhead:true,queryMode:"local",value:null,triggerAction:"all",editable:true,selectOnFocus:true,allowBlank:true,forceSelection:true,disabled:true,width:400};this.existingView.value=this.views[0].guid;function c(e){d=null;Ozone.Msg.alert(Ozone.util.ErrorMessageString.dashboardConfig,"Invalid configuration file.",function(){e.focusTitleBox()},e,null,e.dashboardContainer.modalWindowManager)}var a=this;var d=null;var b=false;this.importedView={xtype:"filefield",itemId:"importFileupload",cls:"importFileupload",name:"importFileupload",hideLabel:true,label:"",width:400,emptyText:Ozone.ux.DashboardMgmtString.uploadConfig,allowBlank:true,disabled:true,buttonText:Ozone.ux.DashboardMgmtString.browse,listeners:{afterrender:function(e){e.setupFocus=function(){var j=this.button.getEl();var g=this.button.btnEl;var f=this.fileInputEl;var h=true;g.dom.tabIndex=-1;e.inputEl.dom.tabIndex=-1;f.dom.tabIndex=0;f.dom.hideFocus=true;f.dom.style.outlineStyle="none";e.mon(f,"focus",function(){this.addCls("x-focus")},j);e.mon(f,"blur",function(){this.removeCls("x-focus")},j);function i(){h=true}e.mon(f,{mouseup:i,mouseout:i})};e.setupFocus();e._reset=e.reset;e.reset=function(){if(!b){this._reset.apply(this,arguments);d=null}else{if(this.rendered){this.fileInputEl.remove();this.createFileInput()}this.callParent()}this.setupFocus()}},change:function(f,g,e){b=true;a.getForm().submit({clientValidation:false,reset:false,url:Ozone.util.contextPath()+"/servlet/FileServlet",waitMsg:"Reading file...",success:function(h,i){d=Ozone.util.parseJson(i.response.responseText).value;if(!Ozone.util.validateDashboardJSON(d)){c()}else{if(a.getComponent("description").getValue()==null||a.getComponent("description").getValue()==""){a.getComponent("description").setValue(d.description)}}b=false},failure:Ext.bind(function(h,i){c(a);b=false},a)})}}};this.viewSelectRadio={layout:{type:"hbox",align:"stretchmax"},cls:"createSelector",region:"center",allowBlank:false,hideLabel:true,hidden:this.hideViewSelectRadio,items:[[{xtype:"radiogroup",flex:1,cls:"viewSelect",itemId:"viewSelect",layout:{type:"vbox",align:"stretch"},defaults:{flex:1},items:[this.existingViewRadio,this.importedViewRadio]},{layout:{type:"vbox",align:"stretch"},cls:"viewSelectBoxes",flex:1,defaults:{flex:1},items:[this.existingView,this.importedView]}]]};this.layout={type:"vbox",align:"stretch"};this.items=[this.titleBox,this.description,this.viewSelectRadio];this.dockedItems=[{xtype:"toolbar",dock:"bottom",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"tbfill"},{xtype:"button",scale:"small",text:Ozone.layout.DialogMessages.ok,itemId:"saveButton",handler:function(h,e){if(this.getForm().isValid()&&this.createViewContainer_FormValid){Ozone.util.formField.removeLeadingTrailingSpaces(this.getComponent("titleBox"));Ext.getCmp("mainPanel").saveActiveDashboardToServer();var l=this.getComponent("titleBox").getValue();var j=this.getComponent("description").getValue();if(j==null||j==""){j=" "}if(this.existingDashboardRecord!=null){this.existingDashboardRecord.set("name",l);this.existingDashboardRecord.set("description",j);this.dashboardContainer.editDashboard(this.existingDashboardRecord);this.close()}else{var m=this.down("#viewSelect").getValue().viewSelectRadio;var f=(m=="copiedDashboard")?true:false;var k=(m=="importedDashboard")?true:false;if(f){var g=this.down("#existViewCb").getValue();if(Ext.isEmpty(g)){this.down("#existViewCb").markInvalid("This field cannot be blank.");Ozone.Msg.alert(Ozone.util.ErrorMessageString.invalidForm,Ozone.util.ErrorMessageString.invalidFormMsg,function(){this.focusTitleBox()},this,null,this.dashboardContainer.modalWindowManager);return}var i=this.dashboardContainer.dashboardStore.getById(g).data;i=Ozone.util.cloneDashboard(i,true);i.name=l;i.description=j;i.isdefault=false;Ext.getCmp("mainPanel").createDashboard(Ext.create("Ozone.data.Dashboard",i));this.close()}else{if(k){if(d!=null){d.name=l;d.description=j;if(!Ozone.util.validateDashboardJSON(d)){Ozone.Msg.alert(Ozone.util.ErrorMessageString.dashboardConfig,"Invalid "+d.layout+" configuration file.",function(){this.focusTitleBox()},this,null,this.dashboardContainer.modalWindowManager)}else{delete d.state;Ext.getCmp("mainPanel").createDashboard(Ext.create("Ozone.data.Dashboard",Ozone.util.cloneDashboard(d,true)));this.close()}}else{Ozone.Msg.alert(Ozone.util.ErrorMessageString.invalidForm,Ozone.util.ErrorMessageString.invalidFormMsg,function(){this.focusTitleBox()},this,null,this.dashboardContainer.modalWindowManager)}}else{Ext.getCmp("mainPanel").createDashboard(Ext.create("Ozone.data.Dashboard",{name:l,description:j}));this.close()}}}}else{Ozone.Msg.alert(Ozone.util.ErrorMessageString.invalidForm,Ozone.util.ErrorMessageString.invalidFormMsg,function(){this.focusTitleBox()},this,null,this.dashboardContainer.modalWindowManager)}},scope:this,listeners:{afterrender:function(e){e.getEl().on("keydown",function(f){f.stopPropagation()})}}},{xtype:"button",scale:"small",text:"Cancel",itemId:"cancelBtn",scope:this,handler:this.cancel}]}];this.on("beforedestroy",function(e){e.dockedItems=null});this.callParent()},refreshData:function(){this.config=this.dashboardContainer.activeDashboard.config;this.views=this.dashboardContainer.dashboards;var e=this.getComponent("titleBox");if(e){e.setRawValue("")}var d=this.getComponent("description");if(d){d.setRawValue("")}var b=this.down("#importFileupload");if(b){b.setRawValue("")}var c=this.getComponent("viewSelect");if(c){c.reset()}var a=this.down("#existViewCb");a.setValue(this.views[0].guid)},focusTitleBox:function(){Ext.defer(function(){this.getComponent("titleBox").focus()},500,this)},cancel:function(){this.close()},close:function(){Ext.getCmp(this.winId).close()}});