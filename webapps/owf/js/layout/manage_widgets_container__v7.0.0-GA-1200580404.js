Ext.define("Ozone.layout.ManageWidgetsContainer",{extend:"Ext.form.Panel",alias:["widget.owfManageWidgetsContainer","widget.Ozone.layout.ManageWidgetsContainer"],requires:["Ext.layout.container.VBox"],layout:{type:"vbox",align:"stretch"},border:false,cls:"mwc-manageWidgetsContainer",mixins:{focus:"Ozone.components.focusable.CircularFocus"},loadGridData:function(){this.setLoading(true);var h=this.dashboardContainer.widgetStore;var f=[];for(var c=0;c<h.getCount();c++){var e=h.getAt(c).data;e.removed=false;if(e.definitionVisible&&e.widgetTypes!=null){var d=e.widgetTypes;var a=false;for(var b=0;b<d.length;b++){var g=d[b];if(g!=null&&g.name=="standard"){a=true;break}}if(a){f.push(e)}}}this.store.loadData(f);this.setLoading(false)},refreshOriginalWidgetNames:function(b){this.setLoading(true);var a=this;Ozone.pref.PrefServer.findWidgets({onSuccess:function(c){for(var d=0;d<c.length;d++){a.dashboardContainer.originalWidgetNames[c[d].path]=c[d].value.namespace}if(b.reloadGrid==true){a.loadGridData()}else{a.setLoading(false)}b.callback()},onFailure:function(){a.setLoading(false);b.callback()}})},initComponent:function(){var d=this;var c=Ext.define("widgetJsonModel",{extend:"Ext.data.Model",fields:["widgetGuid",{name:"name",sortType:Ext.data.SortTypes.asUCString},"visible","removed","headerIcon","tags","editable","_tags","_editable"]});this.store=Ext.create("Ext.data.JsonStore",{model:"widgetJsonModel",sorters:[{property:"name",direction:"ASC"}],listeners:{datachanged:{fn:function(m){var g=m;g.suspendEvents();for(var l=0;l<g.getCount();l++){var o=g.getAt(l);var n=o.data;if(Ext.isArray(n.tags)&&n.tags.length>0){var f="";var k=true;for(var h=0;h<n.tags.length;h++){f+=n.tags[h].name;if(h<n.tags.length-1){f+=", "}if(n.tags[h].editable===false){k=false}}o.set("_tags",f);o.set("_editable",k);o.commit()}else{o.set("_tags","");o.set("_editable",true);o.commit()}}g.resumeEvents()},scope:this}}});this.nameField=Ext.create("Ext.form.field.Text",{maxLength:200,allowBlank:false,blankText:Ozone.layout.DialogMessages.view_dashboardNameField_blankText,validator:function(g){if(this.value){if(this.value.toUpperCase()!=g.toUpperCase()){for(var f=0;f<store.data.items.length;f++){if(g.charAt(0)===" "||g.charAt(g.length-1)===" "){return Ozone.util.ErrorMessageString.invalidDashboardNameMsg}}}else{if(this.value.charAt(0)===" "||this.value.charAt(this.value.length-1)===" "){return Ozone.util.ErrorMessageString.invalidDashboardNameMsg}}return true}return true}});this.tagsField=Ext.create("Ext.form.field.Text",{allowBlank:true,validator:function(f){if(f.match(Ozone.config.carousel.restrictedTagGroupsRegex)!=null){return'"'+f+'"'+Ozone.util.ErrorMessageString.restrictedTagError}else{return true}}});var e=Ext.create("Ext.Action",{text:"Reset Title",handler:function(g,f){var h=d.widgetGrid.getSelectionModel().getSelection()[0];if(h){d.refreshOriginalWidgetNames({reloadGrid:false,callback:function(){var i=h.get("originalName");h.set("name",i)}})}}});var a=Ext.create("Ext.Action",{text:"Reset All Titles",handler:function(h,g){var f=d.widgetGrid.getStore().getRange();d.refreshOriginalWidgetNames({reloadGrid:false,callback:function(){for(var o=0;o<f.length;o++){if(f[o].data.editable){var n=f[o].get("originalName");f[o].data.name=n;var m=[];if(f[o].data._tags.length>0&&f[o].data._tags!=""){var p=f[o].data._tags.split(",");for(var l=0;l<p.length;l++){var k=Ext.String.trim(p[l]);if(k!=""){m.push({name:k,visible:true,position:-1,editable:f[o].data._editable})}}}f[o].data.tags=m}}d.store.loadRecords(f,{addRecords:false})}})}});var b=Ext.create("Ext.menu.Menu",{items:[e,a]});this.widgetGrid=Ext.create("Ext.grid.GridPanel",{ddGroup:"ddWidgets",cls:"mwc-widgetGridPanel",store:this.store,autoScroll:true,scroll:true,viewConfig:{listeners:{itemcontextmenu:{fn:function(f,j,h,g,i){i.stopEvent();this.dashboardContainer.modalWindowManager.register(b);b.showAt(i.getXY());this.dashboardContainer.modalWindowManager.bringToFront(b);return false},scope:this},itemkeydown:{fn:function(k,i,n,j,m){switch(m.getKey()){case Ext.EventObject.S:i.set("visible",!i.get("visible"));k.refreshNode(j);var g=this.down("#showCheckColumn");i.get("visible")?g.onChecked(k,i):g.onUnchecked(k,i);break;case Ext.EventObject.D:i.set("removed",!i.get("removed"));k.refreshNode(j);var g=this.down("#deleteCheckColumn");i.get("removed")?g.onChecked(k,i):g.onUnchecked(k,i);break;case Ext.EventObject.R:if(!Ext.EventObject.hasModifier()){var f=Ext.select("tr[class*=x-grid-row-focused]:first td").item(2);var l=f.getXY();l[0]-=5;l[1]+=10;this.dashboardContainer.modalWindowManager.register(b);b.showAt(l);this.dashboardContainer.modalWindowManager.bringToFront(b);b.addListener("hide",function(p,o,q){Ext.defer(function(){Ext.getCmp("manageWidgetsWindowId").getComponent(0).getComponent(0).getComponent(0).focus()},100,this);b.removeListener("hide",arguments.callee)})}break;case Ext.EventObject.ENTER:var h=k.headerCt.getHeaderAtIndex(1);k.editingPlugin.startEdit(i,h)}},scope:this},afterrender:function(f){f.getEl().on("keyup",function(g){if(g.getKey()===g.ESC){g.stopPropagation()}})}}},columns:[{xtype:"gridcolumn",text:'<span class="gridHdr">Icon</span>',dataIndex:"headerIcon",width:36,sortable:false,resizable:false,menuDisabled:true,renderer:function(k,g,f,l,i,h){if(f.get("editable")==false){g.attr='ext:qtip="This widget belongs to a Group and may not be edited or deleted"';g.tdCls+=" x-item-disabled"}var j='<div><img width="24px" height="24px" src="'+k+'">';j+="</div>";return j}},{xtype:"textcolumn",text:'<span class="gridHdr">Widget</span>',dataIndex:"name",field:this.nameField,width:176,resizable:false,menuDisabled:true,renderer:function(j,g,f,k,i,h){if(f.get("editable")!=false&&f.get("_editable")!=false){g.tdCls+=" manage-editable"}if(f.get("editable")==false){g.tdAttr='data-qtip="This widget belongs to a Group and may not be edited or deleted"';g.tdCls+=" x-item-disabled"}return Ext.util.Format.htmlEncode(j)}},{xtype:"textcolumn",menuDisabled:true,text:'<span class="gridHdr">Tags</span>',field:this.tagsField,dataIndex:"_tags",width:170,sortable:false,resizable:false,renderer:function(k,h,g,l,j,i){h.tdCls="hd-tags";if(g.get("_editable")==false){h.tdCls+=" x-item-disabled"}if(g.get("editable")==false){h.tdAttr='data-qtip="This widget belongs to a Group and may not be edited or deleted"';h.tdCls+=" x-item-disabled"}if(g.get("editable")!=false&&g.get("_editable")!=false){h.tdCls+=" manage-editable";var f=Ext.util.Format.htmlEncode(k);h.tdAttr='data-qtip="'+new Ext.XTemplate("{foo:htmlEncode}").apply({foo:f})+'"'}return Ext.util.Format.htmlEncode(k)}},{xtype:"checkcolumn",itemId:"showCheckColumn",text:'<span class="gridHdrShow"><span class="x-grid-column-checkbox-off"></span><span class="underline">S</span>how</span>',dataIndex:"visible",width:90,sortable:false,tdCls:"gridCellShowWidgets-chkbox",listeners:{afterrender:{scope:this,single:true,fn:function(f){this.store.mon(this.store,"datachanged",function(){if(this.find("visible",false)===-1){f.toggleHeader(true)}})}}}},{xtype:"checkcolumn",itemId:"deleteCheckColumn",text:'<span class="gridHdrDelete"><span class="x-grid-column-checkbox-off"></span><span class="underline">D</span>elete</span>',dataIndex:"removed",width:90,sortable:false,tdCls:"gridCellDeleteWidgets-chkbox"}],selType:"rowmodel",frame:false,enableDragDrop:true,enableHdMenu:false,enableColumnResize:false,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1}),new Ozone.components.focusable.FocusableGridPanel()],flex:1,listeners:{beforeedit:function(g){var f=function(h){if(h.get("removed")||h.get("_editable")===false||h.get("editable")===false){return false}return true};return f(g.record)},edit:function(f,g){if(f.editors.items[g.column.id]){g.record.set("_tags",f.editors.items[g.column.id].field.value.toLowerCase())}}}});this.items=[this.widgetGrid];this.widgetGrid.headerCt.on("headerclick",function(g,h,f,i){if(typeof h.onGridHeaderCtClick=="function"){h.onGridHeaderCtClick(this.widgetGrid,f,i)}},this);this.keys=[];this.keys.push({key:Ext.EventObject.ENTER,fn:function(f,h){var g=this.getFooterToolbar().getComponent("saveButton");if(g){h.button=0;g.onClick(h)}},scope:this});this.dockedItems=[{xtype:"toolbar",dock:"bottom",defaults:{minWidth:this.minButtonWidth},layout:{type:"hbox",pack:"end"},items:[{xtype:"button",scale:"small",text:Ozone.layout.MessageBoxButtonText.ok,itemId:"saveButton",handler:function(){d.onSaveClick()},listeners:{}},{xtype:"button",scale:"small",itemId:"cancelBtn",text:Ozone.layout.MessageBoxButtonText.cancel,handler:function(){Ext.getCmp(d.winId).close()}}]}];this.on("beforedestroy",function(f){f.dockedItems=null});this.on({afterrender:{fn:function(f){var g=Ext.getCmp(f.winId);g.on("show",function(){f.loadGridData()});g.setupFocus(f.widgetGrid.getView().getEl(),f.down("#cancelBtn").getFocusEl())},scope:this}});this.on("resize",function(){this.syncShadow()});this.callParent()},onSaveClick:function(){var l=this.widgetGrid.store.data.items;var d=[];var n=[];var b=[];for(var f=0;f<l.length;f++){if(l[f].data.editable){if(!l[f].data.removed){var p=l[f].data;var q=[];if(p._tags.length>0&&p._tags!=""){var m=p._tags.split(",");for(var e=0;e<m.length;e++){var a=Ext.String.trim(m[e]);if(a!=""){q.push({name:a,visible:true,position:-1,editable:p._editable})}}}var g={guid:l[f].data.widgetGuid,visible:l[f].data.visible,tags:q};var h=l[f].data.originalName;if(l[f].data.name!==h){g.name=l[f].data.name}d.push(g)}else{b.push(l[f].data.widgetGuid);n.push({guid:l[f].data.widgetGuid,name:l[f].data.name,headerIcon:l[f].data.headerIcon,image:l[f].data.image})}}}var o=this;function k(){o.dashboardContainer.retrieveUpdatedWidgets()}function c(){Ozone.Msg.alert(Ozone.util.ErrorMessageString.saveUpdatedWidgets,Ozone.util.ErrorMessageString.saveUpdatedWidgetsMsg,null,null,null,o.dashboardContainer.modalWindowManager)}Ext.getCmp(this.winId).close();Ozone.pref.PrefServer.updateAndDeleteWidgets({widgetsToUpdate:d,widgetGuidsToDelete:[],updateOrder:false,onSuccess:k,onFailure:c});if(b.length>0){Ext.create("Ext.window.Window",{title:"Deleting Widgets",cls:"delete-widgets-window",height:550,ownerCt:o.dashboardContainer,dashboardContainer:o.dashboardContainer,constrain:Ext.isIE,constrainHeader:true,width:600,layout:"fit",resizable:false,modal:true,items:{xtype:"deletewidgetspanel",delWidgets:n,dashboardContainer:o.dashboardContainer},listeners:{show:function(i){i.dashboardContainer.modalWindowManager.register(i);i.dashboardContainer.modalWindowManager.bringToFront(i);Ext.defer(function(){this.focus()},100,i.getComponent("topdeletepanel").okBtn)}}}).show()}}});