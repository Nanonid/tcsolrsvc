Ext.define("Ozone.components.pane.Pane",{extend:"Ext.panel.Panel",alias:["widget.pane","widget.Ozone.components.pane.Pane"],plugins:[new Ozone.plugins.pane.Pane()],activeWidget:null,id:null,paneGuid:null,dashboard:null,type:null,afterWidgetLaunch:function(){},launchWidget:function(b,a,f,d,c,e){},maximizeCollapseWidget:function(a){},minimizeExpandWidget:function(a){},moveWidgetUp:function(a){},moveWidgetRight:function(a){},moveWidgetDown:function(a){},moveWidgetLeft:function(a){},initComponent:function(){var f=this,d=Ext.StoreManager.lookup("widgetStore"),g;f.id=f.paneGuid=guid.util.guid();f.statePositionCount=0;f.widgets=f.widgets||[];f.defaultSettings=f.defaultSettings||{};f.componentCls="pane "+f.xtype;g=f.widgets;f.widgets=[];for(var c=0,a=g.length;c<a;c++){var b=g[c];var e=d.getById(g[c].widgetGuid);if(e){b.singleton=e.get("singleton");b.background=e.get("background");f.widgets.push(b)}}f.stateStore=Ext.create("Ozone.data.StateStore",{storeId:f.paneGuid,data:f.widgets});f.stateStore.on({add:{fn:f.onStoreAdd,scope:f},remove:{fn:f.onStoreRemove,scope:f}});f.addEvents(OWF.Events.Widget.BEFORE_LAUNCH,OWF.Events.Widget.AFTER_LAUNCH);f.enableBubble([OWF.Events.Widget.BEFORE_LAUNCH,OWF.Events.Widget.AFTER_LAUNCH]);f.on(OWF.Events.Widget.AFTER_LAUNCH,f.afterWidgetLaunch,f);f.on("destroy",f.onPaneDestroy,f);f.callParent(arguments)},afterRender:function(){this.el.set({tabIndex:-1});this.dashboard=this.up("dashboard");this.callParent(arguments)},onPaneDestroy:function(){this.stateStore.clearListeners();this.clearWidgets()},clearWidgets:function(d){var a=this.stateStore.data.items;for(var b=a.length-1;b>=0;b--){var e=a[b];var c=Ext.getCmp(e.get("uniqueId"));if(c&&d!==false){c.destroy()}else{if(c&&c.floatingWidget!==true){c.destroy()}}}},getWidgets:function(){var d=Ext.clone(this.items.items),c=this.stateStore;for(var b=0,a=c.getCount();b<a;b++){if(c.getAt(b).data.floatingWidget){d.push(Ext.getCmp(c.getAt(b).data.uniqueId))}}return d},getStatesOfAllWidgets:function(){var d=[],c=this.getWidgets();for(var b=0,a=c.length;b<a;b++){d.push(c[b].getState())}for(var b=0,a=this.stateStore.getCount();b<a;b++){if(this.stateStore.getAt(b).get("background")){d.push(this.stateStore.getAt(b).data)}}return d},launchFloatingWidget:function(d,i,h,f,a,e){var g=this,j,c;j=g.createWidgetConfig(d,f,a);j=Ext.Object.merge(j,{width:d.get("width"),height:d.get("height"),x:i?i:d.get("x"),y:h?h:d.get("y"),active:d.get("active")||true,floatingWidget:!e});if(!d.data.uniqueId){if(g.defaultSettings&&g.defaultSettings.widgetStates&&g.defaultSettings.widgetStates[j.widgetGuid]){var b=g.defaultSettings.widgetStates[j.widgetGuid];j=Ext.Object.merge(j,{width:b.width,height:b.height});if(!i&&!h){j=Ext.Object.merge(j,{x:b.x,y:b.y})}}}j.renderTo=e?g.body:g.dashboard.body;c=Ext.widget("widgetwindow",j);!e&&this.dashboard.dashboardContainer.floatingWidgetManager.register(c);c.on("statesave",function(l,k){this.defaultSettings.widgetStates=this.defaultSettings.widgetStates||{};this.defaultSettings.widgetStates[k.widgetGuid]={x:l.x,y:l.y,height:k.height,width:k.width,timestamp:Ext.Date.now()}},this);if(e){g.createTaskbarComponent(c);if(!g._launchingPreviouslyOpenedWidgets){c.show()}else{g._widgetCmps[c.id]=c}}else{this.dashboard.dashboardContainer.floatingWidgetManager.register(c);c.show();c.model.get("minimized")&&c.minimize()}return c.deferred.promise()},launchPreviouslyOpenedWidgets:function(){var a;this._launchingPreviouslyOpenedWidgets=true;a=this.launchWidgets(this.stateStore.data.items);delete this._launchingPreviouslyOpenedWidgets;return a},launchWidgets:function(h,b,g,f){var d,e=[];if(!h){return}h=[].concat(h);b=b>0?b:null;g=g>0?g:null;for(var c=0,a=h.length;c<a;c++){d=h[c];d=d.isModel?d:Ext.create("Ozone.data.State",d);if(this.fireEvent(OWF.Events.Widget.BEFORE_LAUNCH,this,d)!==false){if(d.get("floatingWidget")){e.push(this.launchFloatingWidget(d,b,g,null,null,f))}else{e.push(this.launchWidget(d,b,g,null,null,f))}Ext.isNumber(f)&&f++}}return e},activateWidget:function(b,a,c){b.focus(false,false,a,c);this.dashboard.updateActiveWidget(b);return true},createWidgetConfig:function(a,d,c){var b=this,e;d||(d=a.get("uniqueId")||guid.util.guid());OWF.Container.State.registerHandler(d);e={id:d,itemId:d,isWidget:true,model:a,pane:b,dashboard:b.dashboard,paneGuid:b.paneGuid,dashboardGuid:b.dashboard.id,uniqueId:d,universalName:a.get("universalName"),widgetGuid:a.get("widgetGuid"),widgetStateContainer:this.widgetStateContainer,name:a.get("name"),title:a.get("name"),icon:encodeURI(decodeURI(a.get("headerIcon"))),singleton:a.get("singleton"),background:a.get("background"),statePosition:++this.statePositionCount,launchData:c||a.get("launchData")||null,intentConfig:a.get("intentConfig")||null,deferred:$.Deferred(),listeners:{afterrender:{fn:b.onWidgetRender,options:{single:true}},beforeclose:{fn:b.onBeforeClose,scope:b}}};return e},cloneWidgetDataForTransfer:function(c){var b=Ext.clone(c.model.data),a=this.dashboard.widgetStore.findRecord("widgetGuid",c.model.get("widgetGuid"));b.name=c.title||a.get("name");b.uniqueId=c.id;b.intentConfig=c.intentConfig;b.launchData=c.launchData||null;return b},reorderWidget:function(e,b,c){var d=this,a=d.cloneWidgetDataForTransfer(e);e.on("destroy",function(){d._reorderingWidgets=true;d.launchWidgets(a,null,null,b);delete d._reorderingWidgets});e.destroy()},onBeforeClose:function(a){if(this.dashboard.configRecord.get("locked")&&!a.floatingWidget){Ozone.Msg.alert(Ozone.layout.DialogMessages.dashboardLockAlertTitle,Ozone.layout.DialogMessages.dashboardLockAlert,null,null,null,this.dashboard.dashboardContainer.modalWindowManager);return false}return true},onWidgetRender:function(){this.pane.fireEvent(OWF.Events.Widget.AFTER_LAUNCH,this,this.model,false);this.add({xtype:"widgetiframe",iframeProperties:OWF.Container.Eventing.getIframeProperties(this.model.get("url"),this.id,this.model.data,this.pane.type,this.launchData,this.dashboard.configRecord.get("locked"))});this.deferred.resolve(true);if(!(this.model instanceof Ozone.data.State)){this.focus(false,false,false,true)}},getBubbleTarget:function(){return this.dashboard},onStoreRemove:function(a,b){this.dashboard.hasChanged=true;this.dashboard.stateStore.remove(b)},onStoreAdd:function(a,b){this.dashboard.hasChanged=true;this.dashboard.stateStore.add(b)},focus:function(){this.enableDrop();this.callParent(arguments)},blur:function(){this.disableDrop()},shim:function(){if(!this.shimEl){this.shimEl=Ext.DomHelper.append(this.el,"<div></div>",true)}this.shimEl&&this.shimEl.addCls("paneshim")},unshim:function(){this.shimEl&&this.shimEl.removeCls("paneshim")},enableDrop:function(){this.shimEl&&this.shimEl.addCls("highlight-dashboard-designer-drop")},disableDrop:function(){this.shimEl&&this.shimEl.removeCls("highlight-dashboard-designer-drop")},enableWidgetMove:function(){this.shim();this.el.on("mousemove",this.enableDrop,this);this.el.on("mouseout",this.disableDrop,this)},disableWidgetMove:function(){this.unshim();this.disableDrop();this.el.un("mousemove",this.enableDrop,this);this.el.un("mouseout",this.disableDrop,this)},moveFloatingWidgetUp:function(a){a&&a.moveUp()},moveFloatingWidgetRight:function(a){a&&a.moveRight(a.renderTo.getWidth())},moveFloatingWidgetDown:function(a){a&&a.moveDown(a.renderTo.getHeight())},moveFloatingWidgetLeft:function(a){a&&a.moveLeft()}});