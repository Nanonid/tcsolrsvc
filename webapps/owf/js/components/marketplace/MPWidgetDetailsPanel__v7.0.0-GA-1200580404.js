Ext.define("Ozone.components.marketplace.MPWidgetDetailsPanel",{extend:"Ext.panel.Panel",alias:["widget.marketplace.widgetdetails","widget.Ozone.components.marketplace.MPWidgetDetailsPanel"],itemId:"mpWidgetDetailPage",cls:"mpWidgetDetailPage",preventHeader:true,autoScroll:true,recordId:null,parentWidget:{},requiredListings:[],mpWidgetSummary:null,mpWidgetSpecifications:null,mpWidgetAssociations:null,returnToSearchResults:function(){var a=this.up("#mpMainPanel"),b=a.up("#mpWindow");a.layout.setActiveItem("mpSearchResultsPanel");b.focus()},refreshPage:function(a,e){this.parentWidget=a?a:this.parentWidget;this.requiredListings=e?e:this.requiredListings;this.mpWidgetSummary.store=new Ext.data.Store({model:"Ozone.marketplace.model.ServiceItem",data:[this.parentWidget]});this.mpWidgetSummary.tpl.overwrite(this.mpWidgetSummary.el,this.parentWidget);this.mpWidgetSummary.doComponentLayout();var f=Ext.get("mpSearchResultsLink");if(f){Ozone.components.focusable.Focusable.setupFocus(f);f.addListener({click:{fn:this.returnToSearchResults,scope:this},keydown:{fn:function(g,h){switch(g.getKey()){case g.ENTER:case g.SPACE:this.returnToSearchResults()}},scope:this}})}var b=Ext.get("mpAddButton");if(b){Ext.create("Ext.Button",{text:"Add Widget",renderTo:"mpAddButton",width:100,handler:function(){this.addWidget()},scope:this})}this.mpWidgetSpecifications.tpl.overwrite(this.mpWidgetSpecifications.body,this.parentWidget);this.mpWidgetSpecifications.doComponentLayout();var c=[];for(var d=0;d<this.requiredListings.length;d++){c.push(Ext.create("Ozone.marketplace.model.ServiceItem",this.requiredListings[d]))}this.mpWidgetAssociations.setTitle(this.parentWidget.title+" Requires:");this.mpWidgetAssociations.store=Ext.data.StoreManager.lookup("requiredWidgetsStore");this.mpWidgetAssociations.store.loadRecords(c,{addRecords:false});if(this.requiredListings&&this.requiredListings.length>0){this.mpWidgetAssociations.show()}else{this.mpWidgetAssociations.hide()}this.mpWidgetSummary.fireEvent("refresh",this.mpWidgetSummary)},updateDetails:function(a){this.recordId=a?a:this.recordId;if(this.recordId){var b=this;this.setLoading(true);Ozone.marketplace.util.getOWFRequiredListings({id:this.recordId,success:function c(e){if(e.data instanceof Array){b.refreshPage(e.data[0],e.data.slice(1))}else{b.refreshPage(e.data,[])}b.setLoading(false)},failure:function d(f,e){b.setLoading(false)}})}},addWidget:function(){var k={};var n=[];var f=[];var c=this.requiredListings;var a=this.parentWidget;if(Ozone.config.enablePendingApprovalWidgetTagGroup){k={name:Ozone.config.carousel.pendingApprovalTagGroupName,visible:true,position:-1,editable:false}}else{var b=new Date();var l=Ext.Date.format(b,"Y-m-d");k={name:Ozone.config.carousel.approvedTagGroupName+" on "+l,visible:true,position:-1,editable:true}}if(a.requires){for(var g=0;g<a.requires.length;g++){f.push(a.requires[g].uuid)}}var m={displayName:a.title,height:200,imageUrlLarge:a.imageLargeUrl?a.imageLargeUrl:Ozone.util.contextPath(),imageUrlSmall:a.imageSmallUrl?a.imageSmallUrl:Ozone.util.contextPath(),isExtAjaxFormat:true,widgetGuid:a.uuid,widgetUrl:a.launchUrl,width:200,widgetVersion:a.versionName,tags:Ext.JSON.encode([k]),singleton:a.owfProperties&&a.owfProperties!=""?a.owfProperties.singleton:false,visible:a.owfProperties&&a.owfProperties!=""?a.owfProperties.visibleInLaunch:true,isSelected:true,background:false};if(f.length>0){m.directRequired=Ext.JSON.encode(f)}n.push(Ext.JSON.encode(m));if(c&&c.length>0){for(var g=0;g<c.length;g++){f=[];for(var e=0;e<c[g].requires.length;e++){f.push(c[g].requires[e].uuid)}m={displayName:c[g].title,height:200,imageUrlLarge:c[g].imageLargeUrl?c[g].imageLargeUrl:Ozone.util.contextPath(),imageUrlSmall:c[g].imageSmallUrl?c[g].imageSmallUrl:Ozone.util.contextPath(),isExtAjaxFormat:true,widgetGuid:c[g].uuid,widgetUrl:c[g].launchUrl,width:200,widgetVersion:c[g].versionName,tags:Ext.JSON.encode([k]),singleton:c[g].owfProperties?c[g].owfProperties.singleton:false,visible:c[g].owfProperties?c[g].owfProperties.visibleInLaunch:true,background:false};if(f.length>0){m.directRequired=Ext.JSON.encode(f)}n.push(Ext.JSON.encode(m))}var d=Ext.create("Ext.panel.Panel",{autoScroll:true,preventHeader:true,cls:"mpWindow",bodyCls:"mpMsgWindow",data:c,tpl:Ext.create("Ext.XTemplate",'<div class="mpParentListing">',"<table>","<tr>",'<td valign="top" width="65">','<div class="parent-icon">','<img src="'+a.imageLargeUrl+'" title="'+Ext.util.Format.htmlEncode(a.title)+'">',"</div>","</td>",'<td valign="top">','<div class="parent-title">'+Ext.util.Format.htmlEncode(a.title)+"</div>",'<div class="parent-text">'+Ozone.layout.DialogMessages.marketplaceWindow_RequiredListingsAlertMsg+"</div>","</td>","</tr>","</table>","</div>",'<div id="mpMsgWindowProgress" class="mpMsgWindowProgress"></div>','<div class="mpRequiredListings">','<tpl for=".">','<div class="mpDetailSummary {[xindex % 2 === 0 ? "" : "striped-row"]}">','<table width="100%">',"<tr>",'<td valign="top" width="85">','<div class="detail-icon">','<img src="{imageLargeUrl}" title="{title:this.htmlEncode}">',"</div>","</td>",'<td valign="top">','<div class="detail-title">{title:this.htmlEncode}</div>','<div class="detail-version">',"Version {versionName:this.htmlEncode}&nbsp;&nbsp;{owfProperties:this.visibleInLaunch}","</div>",'<div class="mpDetailInfo">','<span class="detail-author-label">Owner: </span>','<span class="detail-author">{author:this.htmlEncode}</span>',"</div>",'<tpl if="releaseDate != &quot;&quot;">','<div class="mpDetailInfo">','<span class="detail-released-label">Released: </span>','<tpl if="releaseDate != &quot;&quot;">','<span class="detail-released">{releaseDate:this.displayDate}</span>',"</tpl>","</div>","</tpl>","</td>",'<td valign="top">','<div style="padding-top:25px;">&nbsp;</div>','<div class="mpDetailInfo">','<span class="detail-organization-label">Organization: </span>','<span class="detail-organization">{organization:this.htmlEncode}</span>',"</div>",'<tpl if="lastActivity != null && lastActivity.activityDate != &quot;&quot;">','<div class="mpDetailInfo">','<span class="detail-modified-label">Modified: </span>','<tpl if="lastActivity != null && lastActivity.activityDate != &quot;&quot;">','<span class="detail-modified">{lastActivity.activityDate:this.displayDate}</span>',"</tpl>","</div>","</tpl>","</td>","</tr>","</table>","</div>","</tpl>","</div>",{compiled:true,htmlEncode:function(i){return Ext.util.Format.htmlEncode(i)},displayDate:function(q){if(q){var t=q.substr(0,4);var s=parseInt(q.substr(5,2),10)-1;var i=q.substr(8,2);var o=q.substr(11,2);var j=q.substr(14,2);var p=q.substr(17,2);var r=new Date(t,s,i,o,j,p,0);q=Ext.Date.format(r,"m/d/Y")}return q?q:""},visibleInLaunch:function(i){return i&&i.visibleInLaunch?"":"(Hidden)"}})});var h=Ext.create("Ext.window.Window",{title:"Adding Widget",width:650,height:400,layout:"fit",modal:true,items:[d],dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",items:[{xtype:"tbfill"},{xtype:"button",itemId:"okBtn",text:Ozone.layout.MessageBoxButtonText.ok,handler:function(){var i=Ext.create("Ext.ProgressBar",{text:"Adding Widget...",autoShow:true,renderTo:"mpMsgWindowProgress"});i.wait({text:"Adding Widget...",interval:1000,increment:100});owfdojo.xhrPost({url:Ozone.util.contextPath()+"/widget/",sync:true,content:{addExternalWidgetsToUser:true,widgets:Ext.JSON.encode(n)},load:function(o,j){var p=Ext.getCmp("launchMenuPanel");p.widgetStore.load();h.close()},error:function(o,j){h.close();Ozone.Msg.alert(Ozone.layout.DialogMessages.error,Ozone.layout.DialogMessages.marketplaceWindow_AddWidget,null,null,{cls:"confirmationDialog"})}})}},{xtype:"button",itemId:"cancelBtn",text:Ozone.layout.MessageBoxButtonText.cancel,handler:function(){h.close()}},{xtype:"tbfill"}]}],listeners:{afterrender:function(i){Ext.applyIf(i,new Ozone.components.focusable.EscCloseHelper());i.setupFocusOnEsc(Ext.getCmp("mpWindow").getFocusEl());Ext.applyIf(i,new Ozone.components.focusable.CircularFocus());i.setupFocus(i.down("#okBtn").getFocusEl(),i.down("#cancelBtn").getFocusEl())}}});h.show()}else{owfdojo.xhrPost({url:Ozone.util.contextPath()+"/widget/",sync:true,content:{addExternalWidgetsToUser:true,widgets:Ext.JSON.encode(n)},load:function(j,i){var o=Ext.getCmp("launchMenuPanel");o.widgetStore.load()},error:function(j,i){Ozone.Msg.alert(Ozone.layout.DialogMessages.error,Ozone.layout.DialogMessages.marketplaceWindow_AddWidget,null,null,{cls:"confirmationDialog"})}})}},onBeforeShow:function(a){this.callParent(arguments)},onShow:function(a){this.callParent(arguments);this.updateDetails()},onRender:function(a){this.callParent(arguments);this.updateDetails()},initComponent:function(){Ozone.components.MPListingsAPI=new Ozone.marketplace.MPListingsAPI();Ozone.components.MPCategoryAPI=new Ozone.marketplace.MPCategoryAPI();var a=[];this.mpWidgetSummary=Ext.widget("templateeventdataview",{itemId:"mpWidgetDetailPage",cls:"mpWidgetDetailPage",multiSelect:false,singleSelect:false,simpleSelect:false,autoScroll:true,autoHeight:true,itemSelector:".selectable",listeners:{itemclick:{scope:this,fn:function(f,c,e,d){}},templaterendered:{fn:function(f){f.el.dom.tabIndex=0;f.focus();var d=Ext.get("mpSearchResultsLink");if(d){var e=Ext.bind(function(){this.returnToSearchResults()},this);d.addListener("click",e,this);d.addListener("keydown",function(g){switch(g.getKey()){case Ext.EventObject.ENTER:case Ext.EventObject.SPACE:e()}},this)}var c=Ext.get("mpAddButton");if(c){Ext.create("Ext.Button",{text:"Add Widget",renderTo:"mpAddButton",width:100,handler:function(){this.addWidget()},scope:this})}var d=Ext.get("mpSearchResultsLink");if(d){Ozone.components.focusable.Focusable.setupFocus(d,this)}},scope:this}},tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div id="mpSearchResultsLink" class="return-search-link detail-selectable">Return to Search Results</div>','<div class="detail-title">{title:this.htmlEncode}</div>','<div id="mpDetailSummary" class="mpDetailSummary">',"<table>","<tr>",'<td valign="top" width="125" class="detail-top-row">','<div id="mpDetailIcon" class="mpDetailIcon">','<div class="detail-icon">','<img src="{imageLargeUrl}" title="{title:this.htmlEncode}">',"</div>",'<div id="mpAddButton" class="detail-add-button">',"</div>","</div>","</td>",'<td valign="top">','<div id="mpDetailInfo" class="mpDetailInfo">','<span class="detail-author-label">Owner: </span>','<span class="detail-author">{author:this.htmlEncode}</span>','<span class="detail-version">Version {versionName:this.htmlEncode}</span>',"</div>",'<div class="detail-description">{description:this.htmlEncode}</div>','<div class="detail-categories">','<span class="detail-category-header">Categories: </span>','<span class="detail-category">{categories:this.listCategoryLinks}</span>',"</td>","</td>","</tr>","</table>","</div>",'<div id="mpAddlInfo" class="mpAddlInfo">',"</div>",'<div id="mpDependencies" class="mpDependencies">',"</div>","</tpl>",{compiled:true,idHeader:"detail-category-",htmlEncode:function(c){return Ext.util.Format.htmlEncode(c)},listCategoryLinks:function(c){var e="";for(var d=0;d<c.length;d++){var g=c[d].id?this.idHeader+c[d].id:this.idHeader+"all";var f=Ext.util.Format.htmlEncode(c[d].title);e+='<span id="'+g+'" class="detail-category-link">'+f+"</span>";if(c.length>1&&d<c.length-1){e+=", "}}return e}})});a.push(this.mpWidgetSummary);this.mpWidgetSpecifications=Ext.create("Ext.panel.Panel",{title:"Specifications",data:this.parentWidget,componentCls:"mp-specifications-panel",tpl:Ext.create("Ext.XTemplate",'<tpl for=".">',"<table>",'<tr class="detail-specifications">','<td valign="top" width="125" class="detail-specifications-row">',"<div>State:</div>","</td>",'<td valign="top" class="detail-specifications-row">','<tpl for="state">',"<div>{title:this.htmlEncode}</div>","</tpl>","</td>","</tr>",'<tr class="detail-specifications">','<td valign="top" width="125" class="detail-specifications-row">',"<div>Launch URL:</div>","</td>",'<td valign="top" class="detail-specifications-row">',"<div>{launchUrl}</div>","</td>","</tr>",'<tr class="detail-specifications">','<td valign="top" width="125" class="detail-specifications-row">',"<div>Organization:</div>","</td>",'<td valign="top" class="detail-specifications-row">',"<div>{organization:this.htmlEncode}</div>","</td>","</tr>",'<tr class="detail-specifications">','<td valign="top" width="125" class="detail-specifications-row">',"<div>Technical POC:</div>","</td>",'<td valign="top" class="detail-specifications-row">',"<div>{techPoc:this.htmlEncode}</div>","</td>","</tr>",'<tr class="detail-specifications">','<td valign="top" width="125" class="detail-specifications-row">',"<div>Recommended Layouts:</div>","</td>",'<td valign="top" class="detail-specifications-row">',"<div>{recommendedLayouts:this.convertArrayToString}</div>","</td>","</tr>",'<tr class="detail-specifications">','<td valign="top" width="125" class="detail-specifications-row">',"<div>Singleton:</div>","</td>",'<td valign="top" class="detail-specifications-row">',"<div>{owfProperties:this.isSingleton}</div>","</td>","</tr>",'<tr class="detail-specifications">','<td valign="top" width="125" class="detail-specifications-row">',"<div>Visible in Launch Menu:</div>","</td>",'<td valign="top" class="detail-specifications-row">',"<div>{owfProperties:this.isVisible}</div>","</td>","</tr>",'<tr class="detail-specifications">','<td valign="top" width="125" class="detail-specifications-row">',"<div>Screenshot:</div>","</td>",'<td valign="top" class="detail-specifications-row">{screenshot1Url:this.createScreenshot}',"</td>","</tr>",'<tpl if="this.getCreatedBy(createdBy)">','<tr class="detail-specifications">','<td valign="top" width="125" class="detail-specifications-row">',"<div>Created By:</div>","</td>",'<td valign="top" class="detail-specifications-row">',"<div>{createdBy:this.getCreatedBy}</div>","</td>","</tr>","</tpl>",'<tpl if="createdDate != &quot;&quot;">','<tr class="detail-specifications">','<td valign="top" width="125" class="detail-specifications-row">',"<div>Created Date:</div>","</td>",'<td valign="top" class="detail-specifications-row">',"<div>{createdDate:this.displayDate}</div>","</td>","</tr>","</tpl>","</table>","</div>","</tpl>",{compiled:true,htmlEncode:function(c){return Ext.util.Format.htmlEncode(c)},getCreatedBy:function(c){return Ext.util.Format.htmlEncode(c.name)},displayDate:function(g){if(g){var j=g.substr(0,4);var i=parseInt(g.substr(5,2),10)-1;var c=g.substr(8,2);var e=g.substr(11,2);var d=g.substr(14,2);var f=g.substr(17,2);var h=new Date(j,i,c,e,d,f,0);g=Ext.Date.format(h,"M d, Y h:i:s A T")}return g?g:""},convertArrayToString:function(c){return c?c.toString().replace(/,/g,", "):""},createScreenshot:function(c){return c?'<div class="detail-specifications-screenshot"><img src="'+c+'" title="{title}"></div>':""},isVisible:function(c){return(c&&Ext.isDefined(c.visibleInLaunch))?c.visibleInLaunch:true},isSingleton:function(c){return(c&&c.singleton)?c.singleton:false}})});a.push(this.mpWidgetSpecifications);var b=Ext.create("Ext.data.Store",{storeId:"requiredWidgetsStore",model:"Ozone.marketplace.model.ServiceItem"});this.mpWidgetAssociations=Ext.create("Ext.grid.Panel",{title:this.parentWidget.title+" Requires:",store:b,hideHeaders:true,componentCls:"mp-required-panel",bodyCls:"mp-required-body",loadMask:true,viewConfig:{stripeRows:false},height:200,columns:[{xtype:"gridcolumn",dataIndex:"imageSmallUrl",width:36,sortable:false,resizable:false,menuDisabled:true,renderer:function(h,d,c,i,f,e){var g='<div><img width="24px" height="24px" src="'+h+'"></div>';return h?g:""}},{dataIndex:"title",flex:1,renderer:function(g,d,c,h,f,e){return g?Ext.util.Format.htmlEncode(g):""}},{xtype:"gridcolumn",dataIndex:"versionName",width:75,sortable:false,menuDisabled:true,renderer:function(h,d,c,i,f,e){var g='<span class="requiredListingsVersion">v.'+Ext.util.Format.htmlEncode(h)+"</span>";return h?g:""}}],listeners:{itemdblclick:{scope:this,fn:function(d,c,f,e,g){this.updateDetails(c.data.id)}}}});a.push(this.mpWidgetAssociations);Ext.applyIf(this,{items:[a]});this.callParent()}});