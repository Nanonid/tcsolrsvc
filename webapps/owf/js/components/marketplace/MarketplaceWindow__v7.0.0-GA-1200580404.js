var DEFAULT_ICON_HEIGHT=49;var DEFAULT_ICON_WIDTH=48;var DEFAULT_ITEM_WIDTH=75;Ext.define("Ozone.components.marketplace.MarketplaceWindow",{extend:"Ext.window.Window",alias:["widget.marketplace","widget.Ozone.components.marketplace.MarketplaceWindow"],id:"mpWindow",itemId:"mpWindow",cls:"mpWindow",layout:"fit",width:800,height:500,closable:true,closeAction:"hide",title:"Marketplace",plugins:new Ozone.components.keys.HotKeyComponent(Ozone.components.keys.HotKeys.MARKETPLACE),mixins:{circularFocus:"Ozone.components.focusable.CircularFocus"},mpPanel:null,mpMainPanelContainer:null,mpWidgetDetailPage:null,mpSearchResults:null,mpHomeIcon:{itemId:"mpHomeIcon",cls:"mpHomeIcon",height:90,region:"north",html:'<div id="mpShoppeIcon" class="mpShoppeIcon"><img class="market-icon" src="images/marketplace/shoppe.png" /><div class="market-text">Market</div></div>'},mpCategories:null,listeners:{activate:{fn:function(a){a.removeCls("floatingWinContainerInactive")},scope:this},deactivate:{fn:function(a){a.addCls("floatingWinContainerInactive")},scope:this},move:{fn:function(d,a,g){var f=Ext.core.Element.getViewportWidth();var b=Ext.core.Element.getViewportHeight();var e=a;var c=g;if(g<19){c=19}else{if(g>b-(d.getHeight()+19)){c=b-(d.getHeight()+19)}}if(a<0){e=0}else{if(a>f-d.getWidth()){e=f-d.getWidth()}}if(e!=a||c!=g){d.setPagePosition(e,c)}},scope:this}},searchByText:function(b){var d=this.mpSearchResults;if(d){var a=Ozone.components.MPListingsAPI.getStore();var c=a.lastOptions;if(b==""){b=null}Ext.apply(c.params,{useIndex:true,queryString:b,countCategories:false,start:0,limit:a.lastOptions.params.limit,dir:a.lastOptions.params.dir,sort:a.lastOptions.params.sort});Ozone.components.MPListingsAPI.loadStore(c.params)}},addWidget:function(){var a=this.down("#mpWidgetDetailPage").data;var c=this.down("#mpWidgetDetailPage").data.requiredListings;var k={};var n=[];var f=[];if(Ozone.config.enablePendingApprovalWidgetTagGroup){k={name:Ozone.config.carousel.pendingApprovalTagGroupName,visible:true,position:-1,editable:false}}else{var b=new Date();var l=Ext.Date.format(b,"Y-m-d");k={name:Ozone.config.carousel.approvedTagGroupName+" on "+l,visible:true,position:-1,editable:true}}if(c&&c[0].requires){for(var g=0;g<c[0].requires.length;g++){f.push(c[0].requires[g].uuid)}}var m={displayName:a.title,height:200,imageUrlLarge:a.imageLargeUrl?a.imageLargeUrl:Ozone.util.contextPath(),imageUrlSmall:a.imageSmallUrl?a.imageSmallUrl:Ozone.util.contextPath(),isExtAjaxFormat:true,widgetGuid:a.uuid,widgetUrl:a.launchUrl,width:200,widgetVersion:a.versionName,tags:Ext.JSON.encode([k]),singleton:a.owfProperties&&a.owfProperties!=""?a.owfProperties.singleton:false,visible:a.owfProperties&&a.owfProperties!=""?a.owfProperties.visibleInLaunch:true};if(f.length>0){m.directRequired=Ext.JSON.encode(f)}n.push(Ext.JSON.encode(m));if(c&&c.length>1){c=c.slice(1);for(var g=0;g<c.length;g++){f=[];for(var e=0;e<c[g].requires.length;e++){f.push(c[g].requires[e].uuid)}m={displayName:c[g].title,height:200,imageUrlLarge:c[g].imageLargeUrl?c[g].imageLargeUrl:Ozone.util.contextPath(),imageUrlSmall:c[g].imageSmallUrl?c[g].imageSmallUrl:Ozone.util.contextPath(),isExtAjaxFormat:true,widgetGuid:c[g].uuid,widgetUrl:c[g].launchUrl,width:200,widgetVersion:c[g].versionName,tags:Ext.JSON.encode([k]),singleton:c[g].owfProperties?c[g].owfProperties.singleton:false,visible:c[g].owfProperties?c[g].owfProperties.visibleInLaunch:true};if(f.length>0){m.directRequired=Ext.JSON.encode(f)}n.push(Ext.JSON.encode(m))}var d=Ext.widget("templateeventdataview",{multiSelect:false,singleSelect:false,simpleSelect:false,autoScroll:true,cls:"mpWindow",style:{background:"none"},itemSelector:".selectable",data:c,tpl:Ext.create("Ext.XTemplate",'<div class="mpMsgWindow">','<div class="mpParentListing">','<table width="100%">',"<tr>",'<td valign="top" width="65">','<div class="parent-icon">','<img src="'+a.imageLargeUrl+'" title="'+Ext.util.Format.htmlEncode(a.title)+'">',"</div>","</td>",'<td valign="top">','<div class="parent-title">'+Ext.util.Format.htmlEncode(a.title)+"</div>",'<div class="parent-text">'+Ozone.layout.DialogMessages.marketplaceWindow_RequiredListingsAlertMsg+"</div>","</td>","</tr>","</table>","</div>",'<div id="mpMsgWindowProgress" class="mpMsgWindowProgress"></div>','<div class="mpRequiredListings">','<tpl for=".">','<div class="mpDetailSummary {[xindex % 2 === 0 ? "" : "striped-row"]}">','<table width="100%">',"<tr>",'<td valign="top" width="85">','<div class="detail-icon">','<img src="{imageLargeUrl}" title="{title:this.htmlEncode}">',"</div>","</td>",'<td valign="top">','<div class="detail-title">{title:this.htmlEncode}</div>','<div class="detail-version">',"Version {versionName:this.htmlEncode}&nbsp;&nbsp;{owfProperties:this.visibleInLaunch}","</div>",'<div class="mpDetailInfo">','<span class="detail-author-label">Owner: </span>','<span class="detail-author">{author:this.htmlEncode}</span>',"</div>",'<div class="mpDetailInfo">','<span class="detail-released-label">Released: </span>','<span class="detail-released">{createdDate:this.displayDate}</span>',"</div>","</td>",'<td valign="top">','<div style="padding-top:25px;">&nbsp;</div>','<div class="mpDetailInfo">','<span class="detail-organization-label">Organization: </span>','<span class="detail-organization">{organization:this.htmlEncode}</span>',"</div>",'<div class="mpDetailInfo">','<span class="detail-modified-label">Modified: </span>','<span class="detail-modified">{editedDate:this.displayDate}</span>',"</div>","</td>","</tr>","</table>","</div>","</tpl>","</div>","</div>",{compiled:true,htmlEncode:function(i){return Ext.util.Format.htmlEncode(i)},displayDate:function(q){if(q){var t=q.substr(0,4);var s=parseInt(q.substr(5,2),10)-1;var i=q.substr(8,2);var o=q.substr(11,2);var j=q.substr(14,2);var p=q.substr(17,2);var r=new Date(t,s,i,o,j,p,0);q=Ext.Date.format(r,"m/d/Y")}return q?q:""},visibleInLaunch:function(i){return i&&i.visibleInLaunch?"":"(Hidden)"}})});var h=Ext.create("Ext.window.Window",{title:"Adding Widget",width:750,height:450,layout:"fit",modal:true,items:[d],dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",items:[{xtype:"tbfill"},{xtype:"button",text:Ozone.layout.MessageBoxButtonText.ok,handler:function(){var i=Ext.create("Ext.ProgressBar",{text:"Adding Widget...",autoShow:true,renderTo:"mpMsgWindowProgress"});i.wait({text:"Adding Widget...",interval:1000,increment:100});owfdojo.xhrPost({url:Ozone.util.contextPath()+"/widget/",sync:true,content:{addExternalWidgetsToUser:true,widgets:Ext.JSON.encode(n)},load:function(o,j){var p=Ext.getCmp("launchMenuPanel");p.widgetStore.load();h.close()},error:function(o,j){h.close();Ozone.Msg.alert(Ozone.layout.DialogMessages.error,Ozone.layout.DialogMessages.marketplaceWindow_AddWidget,null,null,{cls:"confirmationDialog"})}})}},{xtype:"button",text:Ozone.layout.MessageBoxButtonText.cancel,handler:function(){h.close()}},{xtype:"tbfill"}]}]}).show()}else{owfdojo.xhrPost({url:Ozone.util.contextPath()+"/widget/",sync:true,content:{addExternalWidgetsToUser:true,widgets:Ext.JSON.encode(n)},load:function(j,i){var o=Ext.getCmp("launchMenuPanel");o.widgetStore.load()},error:function(j,i){Ozone.Msg.alert(Ozone.layout.DialogMessages.error,Ozone.layout.DialogMessages.marketplaceWindow_AddWidget,null,null,{cls:"confirmationDialog"})}})}},initComponent:function(){Ozone.components.MPListingsAPI=new Ozone.marketplace.MPListingsAPI();Ozone.components.MPCategoryAPI=new Ozone.marketplace.MPCategoryAPI();this.mpWidgetDetailPage=Ext.create("Ozone.components.marketplace.MPWidgetDetailsPanel",{parentWidget:{},requiredListings:[]});this.mpWidgetDetailPage.mpWidgetSummary.on("templaterendered",this.resetCircularFocus,this);this.mpWidgetDetailPage.mpWidgetSummary.on("refresh",this.resetCircularFocus,this);var c=function(j,i){var h=this.down("#mpWidgetDetailPage");h.recordId=i.data.id;var g=this.down("#mpMainPanel");g.layout.setActiveItem("mpWidgetDetailPage")};this.mpSearchResults=Ext.widget("templateeventdataview",{pageSize:12,itemId:"mpSearchResults",tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div id="{uuid}-thumb" class="thumb-wrap dataview-item" style="width:'+DEFAULT_ITEM_WIDTH+'px;">',"<center>",'<div id="{uuid}-thumb-icon" class="thumb">','<img src="{imageLargeUrl}">',"</div>",'<div id="{uuid}-thumb-name" class="thumb-text">{shortName}</div>','<div id="{uuid}-thumb-author" class="thumb-text">By {shortAuthor}</div>',"</center>","</div>","</tpl>",{compiled:true,createTooltip:function(h,g){return Ext.util.Format.htmlEncode(Ext.util.Format.ellipsis(h,30))+"<br>"+Ext.util.Format.htmlEncode(Ext.util.Format.ellipsis(g,144))}}),multiSelect:false,singleSelect:true,autoScroll:true,store:Ozone.components.MPListingsAPI.getStore(),autoHeight:true,cls:"mpSearchResults",itemSelector:"div.dataview-item",overItemCls:"x-grid3-row-over",selectedItemCls:"x-grid3-cell-selected",region:"center",listeners:{itemdblclick:{fn:c,scope:this},itemkeydown:{fn:function(i,h,k,j,g){switch(g.getKey()){case g.ENTER:case g.SPACE:c.apply(this,arguments)}},scope:this},templaterendered:{fn:function(g){var j=g.getNodes();var h=g.getRecords(j);for(var k=0;k<j.length;k++){var n=Ext.util.Format.htmlEncode(h[k].data.title);var l=Ext.util.Format.htmlEncode(Ext.util.Format.ellipsis(h[k].data.description,144));var m='<div class="tooltip-title">'+n+"</div><div>"+l+"</div>";Ext.create("Ext.tip.ToolTip",{target:j[k],html:m});Ozone.components.focusable.Focusable.setupFocus(j[k])}},scope:this}},prepareData:function(g){g.shortName=Ext.util.Format.htmlEncode(Ext.util.Format.ellipsis(g.title,10));g.shortAuthor=Ext.util.Format.htmlEncode(Ext.util.Format.ellipsis(g.author,7));return g}});function f(p,l,j,g){var i=Ozone.util.parseID;var k=p.tpl.idHeader;var n=i(j.id,k)!="all"?parseInt(i(j.id,k),10):undefined;var m=[];if(n){m.push(n)}var o=Ozone.components.MPListingsAPI.getStore();var h=o.lastOptions;Ext.apply(h.params,{categoryIDs:m.length>0?("["+m.toString()+"]"):undefined,event:{dataView:p,index:l,node:j,event:g},countCategories:false,start:0,limit:this.mpSearchResults.pageSize,currentPage:1,queryString:h.params.queryString,callback:function(s,y,w){var q=y.event;var r=q.dataView.getNodes();for(var u=0;u<r.length;u++){if(q.node.id==r[u].id){(Ext.create("Ext.core.Element",r[u])).addCls("category-selected")}else{(Ext.create("Ext.core.Element",r[u])).removeCls("category-selected")}}var t=Ext.get("category-tree-all");if(t){t.removeCls("category-selected")}var x=this.down("#mpMainPanel");var v=Ozone.components.MPListingsAPI.getStore();if(v&&x){if(v!==this.mpSearchResults.store){this.mpSearchResults.bindStore(v)}x.layout.setActiveItem("mpSearchResultsPanel")}},scope:this});Ozone.components.MPListingsAPI.loadStore(h.params,true)}this.mpCategories=Ext.widget("templateeventdataview",{id:"mpCategoryTree",itemId:"mpCategoryTree",multiSelect:false,singleSelect:true,store:Ozone.components.MPCategoryAPI.getStore(),autoHeight:false,autoScroll:true,itemSelector:"span.category-selectable",region:"center",ctCls:"navigation-panel",selectedItemCls:"",listeners:{itemclick:{fn:f,scope:this},itemkeydown:{fn:function(k,h,j,i,g){switch(g.getKey()){case g.ENTER:case g.SPACE:f.apply(this,arguments)}},scope:this},templaterendered:{fn:function(i){var h=Ext.get("category-tree-all");if(h){function g(){var k=Ozone.util.parseID;var n=i.tpl.idHeader;var m=undefined;var l=[];if(m){l.push(m)}var j=Ozone.components.MPListingsAPI.getStore();Ozone.components.MPListingsAPI.loadStore({queryString:j.lastOptions.params.queryString,categoryIDs:undefined,countCategories:false,start:0,limit:this.mpSearchResults.pageSize,sort:"title",order:"asc",callback:function(q,r,u){var p=i.getNodes();for(var t=0;t<p.length;t++){(Ext.create("Ext.core.Element",p[t])).removeCls("category-selected")}if(h){h.addCls("category-selected")}var o=this.down("#mpMainPanel");var s=Ozone.components.MPListingsAPI.getStore();if(s&&o){if(s!==this.mpSearchResults.store){this.mpSearchResults.bindStore(s)}o.layout.setActiveItem("mpSearchResultsPanel")}},scope:this})}h.addListener("click",g,this);h.addListener("keydown",function(j){switch(j.getKey()){case j.ENTER:case j.SPACE:g.apply(this)}},this)}Ext.select(".category-selectable, .category-all-selectable").each(function(j){Ozone.components.focusable.Focusable.setupFocus(j.dom,this)},this);this.resetCircularFocus()},scope:this}},tpl:Ext.create("Ext.XTemplate",'<div id="category-tree" class="category-tree">','<span class="category-header">Categories</span><br>','<span id={id:this.createID} class="category-selected category-all-selectable">All Categories</span><br>','<tpl for=".">','<span id={id:this.createID} class="category-selectable">','{title}<span id="{id:this.createID}-count"></span>',"</span><br>","</tpl>","</div>",{compiled:true,idHeader:"category-tree-",createID:function(g){return g?this.idHeader+g:this.idHeader+"all"}})});this.mpNavigation={itemId:"mpNavigation",cls:"mpNavigation",region:"west",split:false,border:true,layout:"border",width:200,items:[this.mpHomeIcon,this.mpCategories]};var b=[["Alphabetical: A -> Z","title-asc"],["Alphabetical: Z -> A","title-desc"],["Newest -> Oldest","releaseDate-desc"],["Oldest -> Newest","releaseDate-asc"]];var e=new Array();e.push("Sort&nbsp;");e.push({xtype:"combo",itemId:"mpSortCombo",store:new Ext.data.SimpleStore({data:b,fields:["sortLabel","sortType"]}),valueField:"sortType",displayField:"sortLabel",typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true,allowBlank:true,forceSelection:true,width:125,listeners:{select:{scope:this,fn:function(j,g,i){var h={sorters:[]};switch(j.getValue()){case"releaseDate-asc":h.sorters.push({property:"releaseDate",direction:"asc"});break;case"releaseDate-desc":h.sorters.push({property:"releaseDate",direction:"desc"});break;case"title-desc":h.sorters.push({property:"title",direction:"desc"});break;case"title-asc":h.sorters.push({property:"title",direction:"asc"});break}Ozone.components.MPListingsAPI.loadStore(h,true)}}}});e.push("->");e.push({xtype:"searchbox",listeners:{searchchanged:function(i,h){var g=this.down("#mpMainPanel");if(g){g.layout.setActiveItem("mpSearchResultsPanel");this.searchByText(h)}},scope:this}});var a={itemId:"mpSearchResultsPanel",cls:"mpSearchResultsPanel",items:[this.mpSearchResults],autoScroll:true,autoHeight:false,bbar:Ext.widget("sortablepagingtoolbar",{itemId:"mpPagingToolbar",cls:"mpPagingToolbar",pageSize:this.mpSearchResults.pageSize,store:this.mpSearchResults.store,displayInfo:true})};this.mpMainPanel={itemId:"mpMainPanel",cls:"mpMainPanel",xtype:"panel",region:"center",activeItem:0,layout:"bufferedcard",flex:3,layoutConfig:{deferredRender:true,layoutOnCardChange:true},dockedItems:{xtype:"toolbar",dock:"top",layout:{type:"hbox",align:"stretchmax"},items:e},listeners:{afterlayout:{fn:function(g,h){this.resetCircularFocus()},scope:this}},items:[a,this.mpWidgetDetailPage]};this.mpPanel=Ext.create("Ext.panel.Panel",{itemId:"mpPanel",region:"center",layout:{type:"hbox",align:"stretch"},split:false,border:false,items:[this.mpNavigation,this.mpMainPanel]});var d=Ext.create("Ext.panel.Panel",{itemId:"mpLoginPanel",html:'<iframe id="mpLoginIFrame" src="'+Ozone.config.marketplaceLocation+'/about.gsp" height="100%" width="100%"></iframe>'});this.mpMainPanelContainer={itemId:"mpMainPanelContainer",cls:"mpMainPanelContainer",xtype:"panel",region:"center",activeItem:"mpLoginPanel",layout:"bufferedcard",layoutConfig:{deferredRender:true,layoutOnCardChange:true},items:[d]};this.mpProgressBar=Ext.create("Ext.ProgressBar",{itemId:"mpProgressBar",width:this.width-16});Ext.applyIf(this,{items:[this.mpMainPanelContainer],bbar:[this.mpProgressBar]});this.on("resize",this.onResize);this.callParent()},onResize:function(d,b,a){this.callParent(arguments);var c=this.down("#mpProgressBar");c.setWidth(b-16)},onShow:function(b){this.callParent(arguments);this.maxTimeout=30000;this.timeoutInterval=5000;if(!this.alreadyShownFlag){this.initialTimeoutInterval=Ozone.config.mpInitialPollingInterval}else{this.initialTimeoutInterval=this.timeoutInterval}this.alreadyShownFlag=true;var e=this.down("#mpProgressBar");var d=this.getComponent("mpMainPanelContainer");var a="Loading Marketplace Widget";if(d.layout.activeItem.itemId!="mpLoginPanel"){a="Refreshing Marketplace Widget"}e.wait({text:a,increment:(this.maxTimeout/1000)});var g=false;var f={pingMP:function(h){if(h.maxTimeout){h.maxTimeout=h.maxTimeout-h.timeoutInterval}else{a="Refreshing Marketplace Widget";e.updateText(a);e.wait({text:a,increment:(h.timeoutInterval/1000)})}try{Ozone.marketplace.util.getOwfCompatibleItems({useIndex:true,max:0,timeout:2000,success:function j(n){g=true;clearTimeout(h.timeout);document.getElementById("mpLoginIFrame").src=Ozone.config.marketplaceLocation+"/about.gsp";if(d){if(d.layout.activeItem.itemId=="mpLoginPanel"){d.add(h.mpPanel);d.layout.setActiveItem("mpPanel");Ozone.components.MPCategoryAPI.loadStore({start:0,limit:20,callback:function(){Ozone.components.MPListingsAPI.loadStore({countCategories:false,start:0,limit:this.mpSearchResults.pageSize,pageSize:this.mpSearchResults.pageSize,sorters:[{property:"title",direction:"asc"}]})},scope:h})}else{try{var m=Ozone.components.MPListingsAPI.getStore();Ozone.components.MPListingsAPI.loadStore(m.lastOptions.params,true)}catch(p){var o=p}if(h.down("#mpMainPanel").layout.activeItem.itemId=="mpWidgetDetailPage"){var l=h.down("#mpWidgetDetailPage");l.updateDetails()}}}e.reset();e.updateText("");h.timeoutInterval=Ozone.config.mpPollingInterval?Ozone.config.mpPollingInterval:300000;h.maxTimeout=h.timeoutInterval*2;h.timeout=setTimeout(owfdojo.hitch(f,"pingMP",h),h.timeoutInterval)},failure:function k(m,l){if(h.maxTimeout<=0){clearTimeout(h.timeout);e.reset();Ozone.Msg.alert(Ozone.util.ErrorMessageString.mpErrorTitle,Ozone.util.ErrorMessageString.mpErrorMsg);Ext.getCmp("mpWindow").hide()}else{if(!g&&d.layout.activeItem&&d.layout.activeItem.itemId!="mpLoginPanel"){document.getElementById("mpLoginIFrame").src=Ozone.config.marketplaceLocation+"/about.gsp";d.layout.setActiveItem("mpLoginPanel")}h.timeoutInterval=5000;if(h.maxTimeout>=30000){h.maxTimeout=30000}clearTimeout(h.timeout);h.timeout=setTimeout(owfdojo.hitch(f,"pingMP",h),h.timeoutInterval)}}})}catch(i){clearTimeout(h.timeout);e.reset();Ozone.Msg.alert(Ozone.util.ErrorMessageString.mpErrorTitle,Ozone.util.ErrorMessageString.mpErrorMsg);Ext.getCmp("mpWindow").hide()}}};if(this.timeout){clearTimeout(this.timeout)}this.timeout=setTimeout(owfdojo.hitch(f,"pingMP",this),this.initialTimeoutInterval);var c=Ext.get("mpShoppeIcon");if(c){c.removeAllListeners();c.on("click",function(i,k,j){var h=this.down("#mpMainPanel");if(h){h.layout.setActiveItem("mpSearchResultsPanel")}});c.on("mouseover",function(h,i){this.dom.style.cursor="pointer"});c.on("mouseout",function(h,i){this.dom.style.cursor="default"})}},resetCircularFocus:function(){this.tearDownCircularFocus();this.setupFocus(this.getEl().select(".category-all-selectable").first(),this.getEl().select("button").filter(function(a){return a.isVisible(true)}).last())}});