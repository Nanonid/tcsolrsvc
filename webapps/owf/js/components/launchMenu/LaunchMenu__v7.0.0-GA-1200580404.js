Ext.define("Ozone.components.launchMenu.LaunchMenu",{extend:"Ozone.components.window.ModalWindow",alias:"widget.launchMenu",closeAction:"hide",modal:true,modalAutoClose:true,shadow:false,ui:"widget-launcher",dashboardContainer:null,closable:true,preventHeader:true,iconCls:"widget-launcher-header-icon",resizable:false,draggable:true,mouseDownCounter:0,dontLoadWidgetStore:false,launchBtnCfg:{xtype:"button",text:"Launch",cls:"launch-btn",itemId:"launch"},initComponent:function(){var a=this;this.widgetStore=Ext.create("Ozone.data.WidgetStore");this.widgetStore.proxy.extraParams={visible:true,widgetTypes:["standard"]};this.widgetStore.on({datachanged:{fn:function(d,c,h,b,f){for(var e=0;e<c.length;e++){var g=this.dashboardContainer.widgetNames[c[e].data.widgetGuid];if(g){c[e].data.name=g}}},scope:this}});this.dashboardContainer.widgetStore.on({load:{fn:function(d,c,f,b,e){if(!this.dontLoadWidgetStore){this.widgetStore.widgetFiltered=false}},scope:this}});this.openedWidgetStore=Ext.create("Ozone.data.WidgetStore");this.widgetStore.on({datachanged:{fn:function(b,c){this.openedWidgetStore.clearFilter();this.openedWidgetStore.filter({filterFn:function(e,f){var d=e.get("widgetGuid");return b.findExact("widgetGuid",d)>-1}})},scope:this}});this.favStore=Ext.create("Ozone.data.WidgetStore",{sortOnFilter:false});this.favStoreUnFiltered=Ext.create("Ozone.data.WidgetStore");this.favStore.on({add:{fn:function(d,c,e,g){for(var f=0;f<c.length;f++){var b=c[f];if(this.favStoreUnFiltered.findExact("widgetGuid",b.get("widgetGuid"))<0){if(this.widgetStore.widgetFiltered){this.favStoreUnFiltered.add(b)}else{this.favStoreUnFiltered.insert(e+f,b)}}}},scope:this},remove:{fn:function(d,b,e,f){var c=this.favStoreUnFiltered.findExact("widgetGuid",b.get("widgetGuid"));if(c>-1){this.favStoreUnFiltered.removeAt(c)}},scope:this},clear:{fn:function(b,c){if(!this.widgetStore.widgetFiltered){this.favStoreUnFiltered.removeAll()}},scope:this}});this.widgetStore.on({datachanged:{fn:function(b,c){this.favStore.clearFilter();this.favStore.filter({filterFn:function(e,f){var d=e.get("widgetGuid");return b.findExact("widgetGuid",d)>-1}})},scope:this},clear:{fn:function(b,c){this.favStore.clearFilter();this.favStore.filter({filterFn:function(d,e){return false}})},scope:this}});Ext.apply(this,{layout:{type:"vbox",align:"stretch"},dockedItems:[{xtype:"toolbar",dock:"left",itemId:"advSearchBtnToolbar",cls:"advSearchBtnToolbar",layout:{type:"vbox",align:"stretchmax",pack:"center",clearInnerCtOnLayout:true},listeners:{afterlayout:{fn:function(b){Ext.FocusManager.unsubscribe(b)},scope:this}},items:[{xtype:"button",itemId:"advSearchBtn",cls:"advSearchBtn",iconCls:"advSearchBtnIcon",enableToggle:true,toggleHandler:function(c,f){this.openOrCloseAdvancedSearch(f);if(f){var d=this.searchPanel.down("#searchbox");var e=d.getFocusEl().dom;e.focus()}},scope:this}]}],items:[{xtype:"panel",layout:{type:"hbox",align:"stretchmax"},itemId:"infoPanel",cls:"info-panel",region:"north",padding:"10",items:[{xtype:"panel",itemId:"imagePanel",cls:"image-panel",items:[{xtype:"image",cls:"widget-icon",region:"west",itemId:"widgetImg",src:Ext.BLANK_IMAGE_URL,listeners:{afterrender:function(b){b.el.on({error:function(c,e,d){e.src="themes/common/images/settings/WidgetsIcon.png"}})}}},a.launchBtnCfg]},{xtype:"container",layout:{type:"vbox",align:"stretch"},flex:1,cls:"infoCenter",itemId:"infoCenter",items:[{xtype:"component",itemId:"htmlPanel",cls:"htmlPanel",flex:1},{xtype:"checkbox",hidden:true,itemId:"intentCheckBox",cls:"intentCheckBox",boxLabel:"Remember this decision"}]},{xtype:"panel",itemId:"toolbar-panel",cls:"toolbar-panel",layout:{type:"vbox",align:"stretch"},items:[{xtype:"toolbar",cls:"viewSwitch",flex:1,layout:"auto",items:[{xtype:"button",itemId:"iconViewBtn",cls:"iconViewBtn",text:null,scale:"large",iconCls:"iconViewBtnIcon-down",iconAlign:"top",handler:function(c,d){this.showIconView(c)},scope:this},{xtype:"button",itemId:"gridViewBtn",cls:"gridViewBtn",text:null,scale:"large",iconCls:"gridViewBtnIcon-up",iconAlign:"top",handler:function(c,d){this.showGridView(c)},scope:this}]},{xtype:"slider",itemId:"iconSlider",cls:"iconSlider",value:64,flex:1,increment:1,minValue:24,maxValue:128,plugins:[new Ozone.components.focusable.Focusable()],onKeyDown:function(d){var c=this,b,f;if(c.disabled||c.thumbs.length!==1){d.preventDefault();return}b=d.getKey();switch(b){case d.UP:case d.RIGHT:d.stopEvent();f=d.ctrlKey?c.maxValue:c.getValue(0)+c.keyIncrement;c.setValue(0,f,undefined,true);break;case d.DOWN:case d.LEFT:d.stopEvent();f=d.ctrlKey?c.minValue:c.getValue(0)-c.keyIncrement;c.setValue(0,f,undefined,true);break;default:break}},listeners:{change:function(e,f,b,c){var d={".thumb-wrap":{width:f,height:f},".":Ext.isIE7?{width:f}:null};a.view.setItemSize(d)},scope:this}},{xtype:"toolbar",cls:"searchBar",flex:1,items:[{xtype:"searchbox",itemId:"searchbox",flex:1,emptyText:"Search title",dynamic:true,listeners:{searchChanged:function(b,c){if(!this.dontLoadWidgetStore){if(c==""){this.widgetStore.widgetFiltered=false}else{this.widgetStore.widgetFiltered=true}this.searchPanel.search({customWidgetName:c})}},scope:this}}]}]}]},{xtype:"widgetviewcontainer",itemId:"view",cls:"widgetviewcontainer",region:"center",flex:1,widgetStore:this.widgetStore,openedWidgetStore:this.openedWidgetStore,listeners:{itemkeydown:{fn:function(d,c,g,e,b,f){if(b.getKey()==b.F){this.carousel.addWidget(c)}},scope:this},render:{fn:function(b){var c=new Ext.dd.DropZone(b.getEl(),{ddGroup:"carousel",onContainerOver:function(f,g,d){return Ext.dd.DropZone.prototype.dropAllowed},onContainerDrop:function(f,g,d){a.carousel.removeWidget(d.widgetModel)}})},scope:this}},plugins:{ptype:"instancevariablizer",container:a}},{xtype:"carousel",region:"south",id:"launchMenu-carousel",itemId:"carousel",height:96,store:a.favStore,plugins:{ptype:"instancevariablizer",container:a}}]});this.callParent();this.addEvents("noWidgetLaunched","refresh");a.carousel.on("render",function(c){var b=c.down("#carouselView");var d=new Ext.dd.DropZone(c.getEl(),{ddGroup:"widgets",getTargetFromEvent:function(f){return f.getTarget(b.itemSelector)},onNodeEnter:function(i,f,h,g){},onNodeOut:function(i,f,h,g){Ext.fly(i).removeCls(["drag-cls","x-view-drop-indicator-right","x-view-drop-indicator-left"])},onNodeOver:function(j,f,i,g){var h=b.getDropPoint(i,j,f);if(h=="before"){Ext.fly(j).replaceCls("x-view-drop-indicator-right","x-view-drop-indicator-left")}else{Ext.fly(j).replaceCls("x-view-drop-indicator-left","x-view-drop-indicator-right")}return Ext.dd.DropZone.prototype.dropAllowed},onNodeDrop:function(l,f,k,i){var j=b.getDropPoint(k,l,f);if(b==i.view){i.sourceStore.remove(i.widgetModel)}var m=b.store.findExact("widgetGuid",i.widgetModel.get("widgetGuid"));if(m>-1){b.store.removeAt(m)}var h=b.indexOf(l);var g=b.store.getAt(h);if(j=="after"){h++}b.store.insert(h,[i.widgetModel]);i.view.fireEvent("drag",b,g,l,h,k);return true},onContainerOver:function(g,h,f){return Ext.dd.DropZone.prototype.dropAllowed},onContainerDrop:function(g,h,f){a.carousel.addWidget(f.widgetModel)}});b.on({itemkeydown:{fn:function(g,f,j,h,e,i){if(e.getKey()==e.D||e.getKey()==e.DELETE){g.store.remove(f);if(g.store.getCount()>0){g.selModel.select(0)}else{a.el.focus()}}},scope:this}})});this.on({render:{fn:function(b){a.createSidePanel()},scope:this},afterrender:{fn:function(b){this.setupCircularFocus()},scope:this},close:{fn:this.onClose,scope:this},beforeshow:{fn:function(b){this.setSize(document.body.clientWidth*0.55,document.body.clientHeight*0.7);Ext.EventManager.un(window,"beforeunload",this.saveLauncherStateSync,this);Ext.EventManager.on(window,"beforeunload",this.saveLauncherStateSync,this)},scope:this},invalidDrop:{fn:function(){this.fireEvent("noWidgetLaunched")},scope:this},modalAutoClose:{fn:function(){this.fireEvent("noWidgetLaunched")},scope:this},selectionchange:{fn:function(d,c,e){if(c.length>0){var b=c[0];this.updateInfoPanel(b,(e&&e.favorite)||this.favStore.findRecord("widgetGuid",b.get("widgetGuid")))}},scope:this},itemdblclick:{fn:this.itemDblClick,scope:this},itemkeydown:{fn:this.itemKeyDown,scope:this}});a.on("afterrender",a.enableDraggingOut,a,{single:true})},refreshOpenedWidgets:function(){if(this.dashboardContainer.activeDashboard!=null){this.view.setOpenedWidgets(this.dashboardContainer.activeDashboard.stateStore)}},refresh:function(){if(this.rendered){this.showIntentCheckBox=false;this.clearSelections(true);this.showOpenedWidgetsView(false);this.dashboardContainer.widgetStore.on({load:{fn:function(c,b,e,a,d){if(this.searchPanel!=null){this.searchPanel.search();this.searchPanel.refresh();this.openOrCloseAdvancedSearch(false,true)}this.refreshOpenedWidgets();this.loadLauncherState()},scope:this,single:true}});this.dashboardContainer.widgetStore.load();this.updateInfoPanel(null,false,true);this.fireEvent("refresh")}else{this.dashboardContainer.widgetStore.load()}},enableDraggingOut:function(){var c,b=false;function a(){if(this.isDragging===true){this.close();if(!c.groups.widgets){b=true;c.addToGroup("widgets")}this.dashboardContainer.activeDashboard.enableWidgetDragAndDrop()}}this.on("dragStarted",function(d){c=d;var e=c.dragData.widgetModel;var f=e.get("disabled");this.isDragging=true;if(!f){Ext.getDoc().on("mousemove",a,this,{delegate:".x-mask"})}},this);this.on("dragEnd",function(d){if(b){b=false;c.removeFromGroup("widgets")}Ext.getDoc().un("mousemove",a,this,{delegate:".x-mask"});this.isDragging=false;this.dashboardContainer.activeDashboard.disableWidgetDragAndDrop()},this)},launchWidget:function(c,j,g){var k=this.dashboardContainer;var a=c.get("widgetGuid");var h=true;var i=k.widgetStore.queryBy(function(l,m){return l.data.widgetGuid==a});if(i&&i.getCount()>0){var d=i.get(0);if(d.get("disabled")!==true){if(d.get("singleton")){var b=k.storeContains(a);if(b){k.activeDashboard.handleAlreadyLaunchedWidget(b.data);h=false}}else{if(c.data.alreadyOpenedWidget){k.activeDashboard.handleAlreadyLaunchedWidget(c.data);h=false}}}else{Ozone.Msg.alert(Ozone.util.ErrorMessageString.errorTitle,Ozone.util.ErrorMessageString.widgetNotApproved,null,null,null,k.modalWindowManager);h=false}if(h){if(k.activeDashboard.configRecord.get("locked")){var f=d.get("uniqueId")||guid.util.guid();k.activeDashboard.panes[0].launchFloatingWidget(d,null,null,f)}else{j.stopEvent();var e=k.launchWidgets(d,j&&j.getKey()===Ext.EventObject.ENTER)}}}this.close()},itemDblClick:function(b,a,e,c,d){this.launchWidget(a,d)},updateInfoPanel:function(c,d,g,b,k){var r=this,e=r.down("#infoPanel"),i=e.getComponent("infoCenter"),f=e.getComponent("imagePanel"),a=f.getComponent("launch"),q=e.down("#htmlPanel"),l=e.down("#intentCheckBox"),j=f.getComponent("widgetImg"),p=function(t,s){r.launchWidget(c,s)};if(a){f.remove(a)}if(c==null){c=Ext.create("Ozone.data.WidgetDefinition",{name:"Please select a widget below",description:"Double click a widget to launch"})}var n=c.get("disabled");if(n){f.addCls("widget-disabled");i.addCls("widget-disabled")}else{f.removeCls("widget-disabled");i.removeCls("widget-disabled")}var o=c.get("description")!=null?c.get("description"):"";var h='<h1 class="launchMenuTitle">'+Ext.htmlEncode(c.get("name"))+"</h1><p>"+Ext.htmlEncode(o)+"</p>";j.setSrc(c.get("image")?c.get("image"):"images/launch-menu/launch-infoPanel-default.png");q.el.update(h);if(this.showIntentCheckBox){l.show()}else{l.hide()}if(k!==undefined){l.setValue(k)}var m=Ext.apply({},r.launchBtnCfg);if(g){m.disabled=true}f.add(Ext.applyIf({handler:p},m))},itemClick:function(b,a,f,c,e,d){this.updateInfoPanel(a,(d&&d.favorite)||this.favStore.findRecord("widgetGuid",a.get("widgetGuid")))},itemKeyDown:function(b,a,f,c,e,d){if(e.getKey()===Ext.EventObject.ENTER){e.preventDefault();this.launchWidget(a,e)}},loadFavStore:function(c){var f=this,g=f.favStore,e=[];c=Ext.JSON.decode(c);e=c.favStore||[];g.removeAll();for(var b=0;b<e.length;b++){var d=e[b];var a=f.dashboardContainer.widgetStore.findRecord("widgetGuid",d);if(a&&a.get("visible")&&!g.findRecord("widgetGuid",d)){g.add(a)}}if(g.isFiltered()){g.filter(f.favStore.filters.items)}f.favStoreLoaded=true},getGuidList:function(c){var a=[];var b=c.getRange();for(var d=0;d<b.length;d++){a.push(b[d].data.widgetGuid)}return a},saveLauncherStateSync:function(){this.saveLauncherState(true)},saveLauncherState:function(f){var e=this;if(e.favStoreLoaded){var d=e.getGuidList(e.favStoreUnFiltered);var h={favStore:d};Ozone.pref.PrefServer.setUserPreference({namespace:"owf",name:"widget_launcher",async:!f,value:Ozone.util.toString(h),onSuccess:function(i){},onFailure:function(){}})}if(!this.widgetStore.widgetFiltered){var c=[];var a=e.widgetStore.getRange();for(var b=0;b<a.length;b++){var g={guid:a[b].data.widgetGuid};if(a[b].data.name!==a[b].data.originalName){g.name=a[b].data.name}c.push(g)}Ozone.pref.PrefServer.updateAndDeleteWidgets({widgetsToUpdate:c,widgetGuidsToDelete:[],updateOrder:true,async:!f,onSuccess:function(i){},onFailure:function(){}})}},loadLauncherState:function(){var a=this;Ozone.pref.PrefServer.getUserPreference({namespace:"owf",name:"widget_launcher",onSuccess:function(b){if(b.value){a.loadFavStore(b.value)}else{a.favStoreLoaded=true}},onFailure:function(c,b){a.favStoreLoaded=true}})},clearSelections:function(a){if(this.view){this.view.deselectAll(a)}if(this.searchPanel){this.searchPanel.clearAllFilters(a)}if(this.carousel){this.carousel.clearSelection(a)}var b=this.down("#searchbox");if(b){b.reset()}var c=this.down("#intentCheckbox");if(c){c.reset()}},createSidePanel:function(){this.searchPanel=Ext.widget("advancedsearchpanel",{itemId:"search-panel",width:document.body.clientWidth*0.15,height:document.body.clientHeight*0.65,renderTo:this.el,dashboardContainer:this.dashboardContainer,widgetStore:this.widgetStore,hidden:true,listeners:{beforeshow:{fn:function(a){a.setSize(document.body.clientWidth*0.15,document.body.clientHeight*0.65)},scope:this},show:{fn:function(a){a.alignTo(this,"tr-tl",[0,10])},scope:this}}});this.searchPanel.show();this.searchPanel.alignTo(this,"tr-tl",[0,10])},openOrCloseAdvancedSearch:function(b,e){var d=this;if(!d.searchPanel){d.createSidePanel()}else{if(b){d.searchPanel.show();this.searchPanel.alignTo(this,"tr-tl",[0,10])}else{d.searchPanel.hide()}}var c=this.down("#advSearchBtn");c.toggle(b,true);var a=this.down("#searchbox");if(b){c.removeCls("advSearchBtn");c.addCls("advSearchBtn-clicked");if(a.getValue()!=""){a.reset();if(!e){a.onClear()}}a.disable()}else{c.removeCls("advSearchBtn-clicked");c.addCls("advSearchBtn");a.enable();d.searchPanel.clearAllFilters();if(!e){d.searchPanel.search()}}},onEsc:function(a,b){this.callParent(arguments);this.fireEvent("noWidgetLaunched")},showOpenedWidgetsView:function(a){this.view.showOpenedWidgetsView(a)},showIconView:function(a){var c=this.down("#view");c.showIconOrGridView(true);var d=this.down("#iconSlider");d.show();a=a||this.down("#iconViewBtn");a.setIconCls("iconViewBtnIcon-down");this.down("#gridViewBtn").setIconCls("gridViewBtnIcon-up")},showGridView:function(a){var c=this.down("#view");c.showIconOrGridView(false);var d=this.down("#iconSlider");d.hide();a=a||this.down("#gridViewBtn");a.setIconCls("gridViewBtnIcon-down");this.down("#iconViewBtn").setIconCls("iconViewBtnIcon-up")},getIntentCheckBoxValue:function(){var a=this.down("#intentCheckBox");return a.getValue()},disableWidgetStoreLoading:function(a){this.dontLoadWidgetStore=a;if(this.searchPanel!=null){this.searchPanel.dontLoadWidgetStore=a}},setupCircularFocus:function(){var a=this.down("#advSearchBtn");var b=Ext.DomHelper.append(this.el,'<div class="focus-catch" tabindex="0"></div>',true);this.setupFocus(a.getFocusEl(),b)},onClose:function(){this.openOrCloseAdvancedSearch(false,true);this.saveLauncherState();this.widgetStore.removeAll();this.openedWidgetStore.removeAll();this.favStore.removeAll();this.carousel.cleanUpScrollerTasks();Ext.EventManager.un(window,"beforeunload",this.saveLauncherStateSync,this)}});