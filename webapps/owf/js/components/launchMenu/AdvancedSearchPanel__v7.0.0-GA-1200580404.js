Ext.define("Ozone.components.launchMenu.AdvancedSearchPanel",{extend:"Ext.panel.Panel",alias:"widget.advancedsearchpanel",cls:"search-panel",autoScroll:true,widgetStore:null,dontLoadWidgetStore:false,initComponent:function(){var b=this;this.groupStore=Ext.create("Ozone.data.GroupStore");this.loadGroupStore();this.intentTreeStore=Ext.create("Ext.data.TreeStore");this.loadIntentTreeStore();this.tagGridStore=Ext.create("Ext.data.Store",{fields:[{name:"tag"}],data:[],proxy:{type:"memory",reader:{type:"array"}},listeners:{add:{fn:function(d){var c=this.down("#tagGrid");c.enable();c.show()},scope:this},remove:{fn:function(d){if(d.getCount()==0){var c=this.down("#tagGrid");c.disable();c.hide()}},scope:this},clear:{fn:function(d){if(d.getCount()==0){var c=this.down("#tagGrid");c.disable();c.hide()}},scope:this}}});this.tagCloudStore=Ext.create("Ext.data.Store",{fields:[{name:"tag"},{name:"uses",type:"int"}]});this.loadTagCloudStore();var a={xtype:"actioncolumn",width:25,items:[{icon:"themes/common/images/delete.png",tooltip:"Delete",handler:function(d,f,c){var e=d.getStore().getAt(f);d.getStore().remove(e);this.search()},scope:this}]};Ext.apply(this,{layout:{type:"vbox",align:"stretch"},items:[{xtype:"searchbox",itemId:"searchbox",width:this.width-25,listeners:{searchChanged:{fn:function(d,e){if(e!=""){var c=b.down("#termGrid");if(!(c.store.findRecord("term",Ext.htmlEncode(e)))){c.store.add({term:Ext.htmlEncode(e)});d.setRawValue("");this.search()}}},scope:this}}},{xtype:"grid",itemId:"termGrid",cls:"term-grid",autoScroll:true,hidden:true,disabled:true,flex:0.8,plugins:[new Ozone.components.focusable.FocusableGridPanel()],store:Ext.create("Ext.data.Store",{fields:[{name:"term"}],data:[],proxy:{type:"memory",reader:{type:"array"}},listeners:{add:{fn:function(d){var c=this.down("#termGrid");c.setDisabled(false);c.show()},scope:this},remove:{fn:function(d){if(d.getCount()==0){var c=this.down("#termGrid");c.setDisabled(true);c.hide()}},scope:this},clear:{fn:function(d){if(d.getCount()==0){var c=this.down("#termGrid");c.setDisabled(true);c.hide()}},scope:this}}}),hideHeaders:true,columns:[{header:"",dataIndex:"term",flex:1},a],viewConfig:{listeners:{itemkeydown:{fn:function(e,d,h,f,c){switch(c.getKey()){case c.SPACE:case c.ENTER:case c.DELETE:var g=this.down("#termGrid");g.getStore().remove(d);this.search();break;default:break}},scope:this}}}},{xtype:"grid",title:"Groups",itemId:"groupGrid",cls:"group-grid",store:this.groupStore,flex:1,hideHeaders:true,collapsible:true,plugins:[new Ozone.components.focusable.FocusableGridPanel()],selModel:Ext.create("Ext.selection.CheckboxModel",{checkOnly:true,listeners:{selectionchange:{fn:function(d,c){this.search()},scope:this}}}),columns:[{header:"",dataIndex:"displayName",renderer:function(c){return Ext.htmlEncode(c)},flex:1}]},{xtype:"nocollapsesplitter",collapsible:false},{xtype:"treepanel",title:"Intents",itemId:"intentsTree",plugins:[new Ozone.components.focusable.FocusableGridPanel()],columns:[{xtype:"simpletreecolumn",text:"Name",flex:1,dataIndex:"text",renderer:function(h,e,d,g,i,f,c){return Ext.htmlEncode(h)}}],cls:"group-grid",store:this.intentTreeStore,rootVisible:false,allowDeselect:true,flex:1,hideHeaders:true,collapsible:true,listeners:{selectionchange:{fn:function(c,e,d){this.search()},scope:this}},viewConfig:{listeners:{itemkeydown:{fn:function(e,d,g,f,c){switch(c.getKey()){case c.SPACE:case c.ENTER:e.selModel.selectWithEvent(d,c);break;default:break}},scope:this}}}},{xtype:"nocollapsesplitter",collapsible:false},{xtype:"panel",itemId:"tagPanel",title:"Tags",cls:"tag-grid",layout:{type:"vbox",align:"stretch"},collapsible:true,flex:1,autoScroll:true,items:[{xtype:"grid",itemId:"tagGrid",cls:"tag-grid",flex:0.8,hidden:true,plugins:[new Ozone.components.focusable.FocusableGridPanel()],store:this.tagGridStore,hideHeaders:true,anchor:"100%",columns:[{header:"",dataIndex:"tag",flex:1},{xtype:"actioncolumn",width:25,items:[{icon:"themes/common/images/delete.png",tooltip:"Delete",handler:function(d,f,c){var e=d.getStore().getAt(f);d.getStore().remove(e);this.search()},scope:this}]}],listeners:{afterrender:{fn:function(e){var c=e.getView();var d=c.getEl();d.dom.tabIndex=-1},scope:this}},viewConfig:{listeners:{itemkeydown:{fn:function(e,d,h,f,c){switch(c.getKey()){case c.SPACE:case c.ENTER:case c.DELETE:var g=this.down("#tagGrid");g.getStore().remove(d);this.search();break;default:break}},scope:this}}}},{xtype:"tagcloud",itemId:"tagCloud",cls:"tagCloud",itemSelector:".tag",selectedItemCls:"tag-selected",trackOver:true,overItemCls:"tag-over",flex:1,minHeight:100,autoScroll:true,store:this.tagCloudStore,listeners:{itemkeydown:{fn:function(e,d,h,f,c){switch(c.getKey()){case c.SPACE:case c.ENTER:var g=this.down("#tagGrid");if(!(g.store.findRecord("tag",Ext.htmlEncode(d.data.tag)))){g.store.add({tag:Ext.htmlEncode(d.data.tag)});this.search()}break;default:break}},scope:this},itemClick:{fn:function(d,c,i,e,h,g){var f=this.down("#tagGrid");if(!(f.store.findRecord("tag",Ext.htmlEncode(c.data.tag)))){f.store.add({tag:Ext.htmlEncode(c.data.tag)});this.search()}},scope:this}}}]}],bbar:{xtype:"toolbar",itemId:"reset-bar",items:[{xtype:"tbfill"},{xtype:"button",text:"Reset",handler:function(c,d){b.clearAllFilters();b.search()}}]}});this.callParent(arguments)},loadGroupStore:function(){this.groupStore.removeAll();for(var e=0,b=this.widgetStore.getCount();e<b;e++){var a=this.widgetStore.getAt(e).get("groups");if(a!=null&&a.length>0){for(var d=0,c=a.length;d<c;d++){if(this.groupStore.findExact("id",a[d].id)<0&&!a[d].stackDefault){this.groupStore.add(a[d])}}}}},loadIntentTreeStore:function(){var d={expanded:true,children:[]};var p={};var c={};for(var g=0,l=this.widgetStore.getCount();g<l;g++){var o=this.widgetStore.getAt(g).data;if(o.intents!=null&&o.intents.receive!=null){for(var f=0;f<o.intents.receive.length;f++){var b=o.intents.receive[f];if(b!=null){var a=p[b.action];if(a==null){a={text:b.action,expanded:true,expandable:false,children:[]};p[b.action]=a;d.children.push(a)}if(b.dataTypes!=null){for(var e=0;e<b.dataTypes.length;e++){var n=b.dataTypes[e],m=n+"\0"+b.action;var h=c[m];if(h==null){h={text:n,leaf:true};c[m]=h;a.children.push(h)}}}}}}}this.intentTreeStore.setRootNode(d)},refresh:function(a){this.clearAllFilters(a);this.loadGroupStore();this.loadIntentTreeStore();var b=this.down("#intentsTree");b.getSelectionModel().setLocked(false);this.loadTagCloudStore()},loadTagCloudStore:function(){var g={};var f=[];this.tagCloudStore.removeAll();for(var e=0;e<this.widgetStore.getCount();e++){var a=this.widgetStore.getAt(e);var c=a.data.tags;for(var b in c){var d=c[b].name;if(this.tagGridStore.findExact("tag",d)<0){if(g[d]==null){g[d]={tag:d,uses:1};f.push(g[d])}else{g[d].uses++}}}}this.tagCloudStore.add(f)},search:function(d){if(!this.dontLoadWidgetStore){var B=false;var w=this.down("#termGrid").getStore();var h=this.down("#tagGrid").getStore();var r=this.down("#groupGrid");var n=r.getSelectionModel().getSelection();var I={};var M=this.down("#intentsTree");var b=M.selModel.getSelection();if(b.length>0){B=true;if(b[0].isLeaf()){var g=b[0].parentNode;I.action=g.get("text");I.dataType=b[0].get("text")}else{I.action=b[0].get("text")}I.receive=true}if(d!=null){if(d.customWidgetName!=null&&d.customWidgetName!=""){w=Ext.create("Ext.data.Store",{fields:[{name:"term"}],data:[],proxy:{type:"memory",reader:{type:"array"}}});w.add({term:d.customWidgetName})}if(d.intent!=null){I=d.intent}}this.widgetStore.removeAll();var K=this.dashboardContainer.widgetStore;var s=[];for(var J=0,o=K.getCount();J<o;J++){var L=true;var C=K.getAt(J);L=C.get("visible")&&C.get("definitionVisible");if(L){var A=C.get("widgetTypes");if(A!=null){var e=false;for(var H=0;H<A.length;H++){var N=A[H];if(N.name=="standard"){e=true}}if(!e){L=false}}}if(L){for(var H=0;H<w.getCount();H++){var u=Ext.htmlDecode(w.getAt(H).get("term"));B=true;if(C.get("name")!=null&&!C.get("name").match(new RegExp(".*"+u+".*","i"))){L=false;break}}}if(L){var t=C.get("groups");for(var H=0;H<n.length;H++){B=true;var q=n[H].get("id");var z=false;for(var G=0;G<t.length;G++){var D=t[G].id;if(q==D){z=true}}if(!z){L=false;break}}}if(L){if(I.action!=null){var a=C.get("intents").receive;var x=false;for(var G=0;G<a.length;G++){var f=a[G];if(I.action==f.action){if(I.dataType!=null){var v=f.dataTypes;if(v!=null){x=false;for(var F=0;F<v.length;F++){var p=v[F];if(I.dataType==p){x=true}}}}else{x=true}}}if(!x){L=false}}}if(L){var m=C.get("tags");for(var H=0;H<h.getCount();H++){var E=Ext.htmlDecode(h.getAt(H).get("tag"));var c=false;for(var G=0;G<m.length;G++){B=true;var y=m[G].name;if(E==y){c=true}}if(!c){L=false;break}}}if(L){s.push(C.copy())}}this.widgetStore.add(s);this.widgetStore.widgetFiltered=B;this.loadTagCloudStore()}},clearAllFilters:function(b){var f=this.down("#tagGrid");f.store.removeAll();var e=this.down("#termGrid");e.store.removeAll();var a=this.down("#groupGrid");a.getSelectionModel().deselectAll(b);var h=this.down("#intentsTree");var g=h.getSelectionModel();var d=g.isLocked();if(!d){g.deselectAll(b)}var c=this.down("#searchbox");c.reset()}});