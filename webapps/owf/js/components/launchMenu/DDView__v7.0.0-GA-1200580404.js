Ext.define("Ozone.components.view.DDView",{extend:"Ozone.components.focusable.FocusableView",alias:"widget.ddview",store:null,ddGroup:null,disableDragAndDrop:false,disableDragLaunching:false,indicatorHtml:'<div class="x-view-drop-indicator-left"></div><div class="x-view-drop-indicator-right"></div>',indicatorCls:"x-view-drop-indicator",dragImgSelector:"img",initComponent:function(){this.disabledItems=Ext.create("Ext.util.MixedCollection");this.defaultFilterFunction=function(a,b){return a.get("visible")&&a.get("definitionVisible")};this.filterFunction=this.defaultFilterFunction;this.on("render",this.setupDragZone);this.callParent(arguments);this.addEvents(["dragStarted","dragEnd","invalidDrop"]);this.enableBubble(["dragStarted","dragEnd","invalidDrop"])},refresh:function(){this.callParent(arguments);if(this.sizeCfg){this.setItemSize(this.sizeCfg)}},setupDragZone:function(){var a=this;if(!this.disableDragAndDrop){var b=Ext.create("Ext.dd.StatusProxy",{shadow:false});a.dragZone=new Ext.dd.DragZone(a.getEl(),{ddGroup:this.ddGroup,proxy:b,getDragData:function(g){var c=g.getTarget(a.itemSelector);if(c){var f=a.indexOf(c);var h=a.dragImgSelector==="."?Ext.fly(c).dom.cloneNode(true):Ext.fly(c).down(a.dragImgSelector).dom.cloneNode(true);Ext.fly(h).addCls("widget-drag-proxy");return{ddel:h,sourceEl:c,repairXY:Ext.fly(c).getXY(),sourceStore:a.store,view:a,origIdx:f,lastIdx:f,widgetModel:a.getRecord(c)}}},getRepairXY:function(){return this.dragData.repairXY},onStartDrag:function(c,d){a.fireEvent("dragStarted",a.dragZone,this.disableDragLaunching)},endDrag:function(){a.fireEvent("dragEnd",a.dragZone)},afterInvalidDrop:function(c,d){a.fireEvent("invalidDrop")}});a.dropZone=new Ext.dd.DropZone(a.getEl(),{ddGroup:this.ddGroup,getTargetFromEvent:function(c){return c.getTarget(a.itemSelector)},onNodeEnter:function(g,c,f,d){},onNodeOut:function(g,c,f,d){Ext.fly(g).removeCls(["drag-cls","x-view-drop-indicator-right","x-view-drop-indicator-left"])},onNodeOver:function(h,c,g,d){var f=a.getDropPoint(g,h,c);if(f=="before"){Ext.fly(h).replaceCls("x-view-drop-indicator-right","x-view-drop-indicator-left")}else{Ext.fly(h).replaceCls("x-view-drop-indicator-left","x-view-drop-indicator-right")}return Ext.dd.DropZone.prototype.dropAllowed},onNodeDrop:function(j,c,i,g){var h=a.getDropPoint(i,j,c);if(a==g.view){g.sourceStore.remove(g.widgetModel)}var k=a.store.findExact("widgetGuid",g.widgetModel.get("widgetGuid"));if(k>-1){a.store.removeAt(k)}var f=a.indexOf(j);var d=a.store.getAt(f);if(h=="after"){f++}a.store.insert(f,[g.widgetModel]);g.view.fireEvent("drag",a,d,j,f,i);return true}})}},onItemKeyDown:function(b,d,c,a){if(a.getKey()==219){if(c>0){this.store.removeAt(c);this.store.insert(c-1,b);this.select(b)}}else{if(a.getKey()==221){if(c<this.store.getCount()){this.store.removeAt(c);this.store.insert(c+1,b);this.select(b)}}}},getDropPoint:function(h,g,d){if(g==this.el.dom){return"before"}var f=Ext.fly(g).getX(),a=f+g.offsetWidth;var j=f+(a-f)/2;var i=h.getX();if(i<=j){return"before"}else{return"after"}},defaultFilter:function(){this.filterFunction=this.defaultFilterFunction;this.store.filter({filterFn:this.filterFunction})},enableAllItems:function(){if(this.rendered){for(var b=0;b<this.disabledItems.getCount();b++){var c=this.el.down("#"+this.disabledItems.getAt(b));if(c!=null){var a=c.down("img");if(a!=null){a.applyStyles("zoom: 1; filter: alpha(opacity=100);opacity:1.0;")}}}}},enableItem:function(b){if(this.rendered){var c=this.el.down("#"+b);if(c!=null){this.disabledItems.removeAtKey(b);var a=c.down("img");if(a!=null){a.applyStyles("zoom: 1; filter: alpha(opacity=100);opacity:1.0;")}}}},disableItem:function(b){if(this.rendered){var c=this.el.down("#"+b);if(c!=null){this.disabledItems.add(b,b);var a=c.down("img");if(a!=null){a.applyStyles("zoom: 1;filter: alpha(opacity=20);opacity: 0.2;")}}}},searchByText:function(c,d,a,b,e){a=(a!==null)?a:true;b=(b!==null)?b:false;e=(e!==null)?e:false;if(a){this.store.clearFilter(true)}if(d===""||d===null){this.filterFunction=this.defaultFilterFunction;c.loadViewStore();c.widgetSelect(c.lastSelected);return this.filterFunction}else{if(b){this.filterFunction=Ext.bind(function(f,g){return this.searchByTagFilter(d,f,g)},this)}else{this.filterFunction=Ext.bind(function(f,g){return this.searchByTextFilter(d,f,g,e)},this)}}this.store.filter({filterFn:this.filterFunction});return this.filterFunction},searchByTextFilter:function(b,d,e,c){var a=new RegExp(b,"i");if((d.get("name").match(a))&&d.get("visible")&&d.get("definitionVisible")){return d}},searchByTagFilter:function(d,e,f){var a=e.get("tags");var c=false;for(var b=0;b<a.length;b++){d=d.replace("_"," ");if(a[b].name==d){c=true}}if(c&&e.get("visible")&&e.get("definitionVisible")){return e}},setItemSize:function(a){this.sizeCfg=a;Ext.Object.each(a,function(c,b){if(b){this.setElementSize(b.width,b.height,c)}},this)},setElementSize:function(e,b,a){var d=new Ext.CompositeElementLite(this.getNodes());if(typeof a==="undefined"){a=this.sizeElSelector}if(a!=="."){var c=d;d=new Ext.CompositeElementLite();c.each(function(f){d.add(f.select(a))},this)}if(e){d.setWidth(e)}if(b){d.setHeight(b)}}});