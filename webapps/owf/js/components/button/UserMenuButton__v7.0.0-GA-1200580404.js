Ext.define("Ozone.components.button.UserMenuButton",{extend:"Ext.button.Button",alias:["widget.usermenubutton","widget.Ozone.components.button.UserMenuButton"],iconAlign:"right",iconCls:"userMenuIcon",scale:"banner-large",user:null,logoutText:"Sign Out",menuHidden:true,hideMenu:false,hideDelay:100,showDelay:800,initComponent:function(){var e=this;e.text=Ext.htmlEncode(e.user.userRealName);var f=(function(){var g;return function h(){if(!g||g.isDestroyed){g=Ext.create("Ozone.components.window.ModalWindow",{id:"about-window",ui:"system-window",cls:"system-window",modalAutoClose:true,preventHeader:true,width:550,draggable:false,resizable:false,shadow:false,dashboardContainer:e.dashboardContainer});Ext.Ajax.request({url:Ozone.util.contextPath()+"/about.jsp",success:function(i){var k=i.responseText;function j(){Ext.DomHelper.append(g.body,k);g.setupFocus();g.center()}if(g.isVisible()){j()}else{g.on("show",function(){j()})}}})}if(!g.isVisible()){g.show();g.center()}else{g.hide()}}})();e.items=[{text:"Previous Sign In "+e.user.prettyPrevLogin,id:"prevLogin",clickable:false},{text:"Profile",id:"profile",handler:Ext.bind(function(){if(this.profileWindow==null||this.profileWindow.isDestroyed){this.profileWindow=Ext.widget("profileWindow",{ownerCt:this.dashboardContainer,dashboardContainer:this.dashboardContainer,user:this.user})}this.profileWindow.show()},this)},{text:"About",id:"about",handler:f}];if(Ozone.config.logoutURL!=null){e.items.push({spacer:true},{text:e.logoutText,id:"logout",handler:b})}for(var c=0,a=e.items.length;c<a;c++){var d=e.items[c];Ext.applyIf(d,{spacer:false,clickable:true});if(d.spacer){d.clickable=false}}function b(){window.location.href=Ozone.util.contextPath()+Ozone.config.logoutURL}Ozone.KeyMap.addBinding([Ext.apply({scope:this,fn:b},Ozone.components.keys.HotKeys.LOGOUT)]);e.userMenu=new Ext.XTemplate('<ul id="userMenu">','<tpl for=".">','<tpl if="spacer">',"<hr/>","</tpl>",'<tpl if="!spacer">','<li id="{id}" ','<tpl if="clickable">','class="clickable"',"</tpl>","><span>","{text}","</span>","</li>","</tpl>","</tpl>","</ul>");e.on("afterrender",e.onAfterRender,this);e.on("click",e.onClick,this);e.callParent(arguments)},getClickables:(function(){var a;return function(){if(!a){a=this.userMenu.el.select(".clickable")}return a}})(),setupFocusBridge:function(){var b=Ext.apply({},this.getClickables().first()),a=this.getFocusEl();this.mon(a,"keydown",function(c){if(c.keyCode===Ext.EventObject.TAB&&c.shiftKey===false){c.preventDefault();b.focus()}});this.mon(b,"keydown",function(c){if(c.keyCode===Ext.EventObject.TAB&&c.shiftKey===true){c.preventDefault();a.focus()}})},onAfterRender:function(e){var f;e.userMenu.el=Ext.get(e.userMenu.append(Ext.getBody(),e.items));e.userMenu.el.setVisibilityMode(Ext.Element.DISPLAY);e.userMenu.el.setVisible(false);e.setupFocusBridge();f=e.getClickables();e.addMenuShowHideHandlers();f.each(function(g){g.addClsOnOver("over");g.addClsOnOver(g.id+"-over");g.addClsOnFocus(g.id+"-focus");Ozone.components.focusable.Focusable.setupFocus(g.dom,e)});for(var b=0,a=e.items.length;b<a;b++){var d=e.items[b];if(d.clickable){var c=Ext.get(d.id);c.handler=d.handler;e.mon(c,"click",c.handler)}}e.setupMenuNav();Ext.widget("tooltip",{id:"prevLoginToolTip",target:Ext.get("prevLogin"),html:"Previous Sign In "+this.formatLoginDate(this.user.prevLogin),listeners:{show:{fn:function(h,g){h.setZIndex(100000001)}}}})},onClick:function(){if(this.menuHidden){this.hideMenu=false;this._showMenu()}else{this.hideMenu=true;this._hideMenu()}},setupMenuNav:function(){var b=this,c;function a(g,d){var e=Ext.get(g),f=d?"previousSibling":"nextSibling";while((e=Ext.get(e.dom[f]))&&!e.hasCls("clickable")){}if(e){e.focus()}}var c=new Ext.util.KeyNav(this.userMenu.el,{up:function(d){a(d.getTarget(),true)},down:function(d){a(d.getTarget())},esc:Ext.bind(b.hideUserMenu,b),enter:function(d){Ext.get(d.getTarget()).handler.call()}});b.on("destroy",function(){this.destroy()},c)},formatLoginDate:function(b){var a=new Date();if(b){a.setUTCFullYear(b.substring(0,4));a.setUTCMonth(b.substring(5,7)-1);a.setUTCDate(b.substring(8,10));a.setUTCHours(b.substring(11,13),b.substring(14,16))}return Ext.util.Format.date(a,Ozone.config.lastLoginDateFormat)},addMenuShowHideHandlers:function(){var b=this,a=b.userMenu.el,c=b.getClickables();b.mon(a,"mouseover",b.keepMenuOpen,b);b.mon(a,"mouseout",b.hideUserMenu,b);b.on("mouseout",b.hideUserMenu,b);b.on("mouseover",b.showUserMenu,b);b.mon(b.getFocusEl(),"focus",b.showUserMenu,b);b.mon(c,"focus",b.keepMenuOpen,b);b.mon(c,"blur",b.hideUserMenu,b);b.mon(b.getFocusEl(),"blur",b.hideUserMenu,b)},keepMenuOpen:function(){this.hideMenu=false},showUserMenu:function(){var b=this,a=b.userMenu.el;b.hideMenu=false;if(!b.showTask){b.showTask=Ext.create("Ext.util.DelayedTask",function(){b._showMenu()})}b.showTask.delay(Ext.isNumber(b.showDelay)?b.showDelay:800,null)},hideUserMenu:function(){var a=this;a.hideMenu=true;if(!a.hideTask){a.hideTask=Ext.create("Ext.util.DelayedTask",function(){a._hideMenu()})}a.hideTask.delay(Ext.isNumber(a.hideDelay)?a.hideDelay:100,null)},_showMenu:function(){var b=this,a=b.userMenu.el;if(b.hideTask){b.hideTask.cancel()}b.menuHidden=false;a.stopAnimation();a.setVisible(true);a.alignTo(b.getEl(),"tr-br");a.fadeIn()},_hideMenu:function(){var a=this;if(a.showTask){a.showTask.cancel()}if(a.menuHidden){return}if(a.hideMenu===true&&a.userMenu&&a.userMenu.el){a.menuHidden=true;a.userMenu.el.fadeOut({listeners:{afteranimate:{fn:function(){if(a.userMenu.el.contains(document.activeElement)){document.activeElement.blur()}this.userMenu.el.setVisible(false)},scope:a}}})}}});