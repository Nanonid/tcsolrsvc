Ext.define("Ozone.components.admin.IntentsTabPanel",{extend:"Ext.panel.Panel",alias:["widget.intentstabpanel"],initComponent:function(){Ext.apply(this,{layout:"fit",itemId:"intents-tab",cls:"widgeteditintentstab",iconCls:"intents-tab",title:"Intents",editor:"Widget",componentId:"intent_id",preventHeader:true,border:true,padding:5,items:[{xtype:"intentsgrid",itemId:"intentsGrid",preventHeader:true,border:false}],dockedItems:[{xtype:"toolbar",itemId:"tbIntentsGridHdr",cls:"tbIntentsGridHdr",dock:"top",items:[{xtype:"tbtext",itemId:"lblIntentsGrid",cls:"tbIntentsGridHdr",text:"Intents"},"->",{xtype:"searchbox",listeners:{searchChanged:{fn:function(b,c){var a=this.getComponent("intentsGrid");if(a!=null){if(!c){a.clearFilters()}else{a.applyFilter(c)}}},scope:this}}}]},{xtype:"toolbar",itemId:"tbDashboardsGridFtr",dock:"bottom",ui:"footer",defaults:{minWidth:80},items:[{xtype:"button",text:"Create",itemId:"btnCreate",handler:this.onCreateOrEdit,disabled:true,scope:this},{xtype:"button",text:"Edit",itemId:"btnEdit",handler:this.onCreateOrEdit,disabled:true,scope:this},{xtype:"button",text:"Delete",itemId:"btnDelete",handler:this.onDelete,disabled:true,scope:this}]}]});this.callParent(arguments);this.on({activate:{scope:this,fn:function(d,c){var b=d.ownerCt;if(b.record.data){var a=Ext.htmlEncode(Ext.util.Format.ellipsis(b.record.get("title"),25))||"Intents";var e=d.getDockedItems('toolbar[dock="top"]')[0].getComponent("lblIntentsGrid");e.setText(a)}},single:true}});this.on({activate:{fn:function(b){var a=b.getComponent("intentsGrid");if(a){a.on({itemdblclick:{fn:function(){var d=this.down("#btnEdit");if(!d.isDisabled()){var c=this.getComponent("intentsGrid").getSelectionModel().getSelection()[0];this.onCreateOrEdit(d)}},scope:this}})}},single:true},afterrender:{fn:function(a){this.ownerCt.on({recordupdated:{fn:function(o){var d=this.getComponent("intentsGrid");var r=d.getStore();var p=o?o.intents:null;var b=[];if(p){for(var n=0;p.send&&n<p.send.length;n++){var c=p.send[n];var h=c.action;for(var m=0;c.dataTypes&&m<c.dataTypes.length;m++){b.push({action:h,dataType:c.dataTypes[m],send:true,receive:false})}}for(var n=0;p.receive&&n<p.receive.length;n++){var c=p.receive[n];var h=c.action;for(var m=0;c.dataTypes&&m<c.dataTypes.length;m++){var q=false;for(var g=0;g<b.length;g++){if(b[g].action==h&&b[g].dataType==c.dataTypes[m]){b[g].receive=true;q=true}}if(!q){b.push({action:h,dataType:c.dataTypes[m],send:false,receive:true})}}}}if(r){r.loadData(b);var f=d.getEl().query(".x-grid-group-hd");if(f){for(var n=0;n<f.length;n++){var e=new Ext.Element(f[n]);var l=e.down(".x-grid-cell-inner");if(l){Ozone.components.focusable.Focusable.setupFocus(l,this);new Ext.util.KeyMap(l,{key:[Ext.EventObject.ENTER,Ext.EventObject.SPACE],fn:function(j,i){i.preventDefault();i.stopPropagation();var k=d.features[0];k.onGroupClick(d.getView(),this)},scope:e.dom});new Ext.util.KeyMap(l,{key:[Ext.EventObject.UP,Ext.EventObject.DOWN],fn:function(t,k){k.preventDefault();k.stopPropagation();var u=(t==Ext.EventObject.UP)?this.previousSibling:this.nextSibling;if(u){var s=Ext.fly(u);var v=s.select(".x-grid-row");if(v){var j=d.getView();var i=j.getRecord(v.elements[0]);j.focus();j.focusRow(i);j.select(i.index);j.addCls("x-grid-view-focus")}}},scope:e.dom})}}}}},scope:this}})},scope:this}})},onCreateOrEdit:function(b,a){var c=this;var e=false,d=null;if(b==c.down("#btnEdit")){e=true;d=this.getComponent("intentsGrid").getSelectionModel().getSelection()[0]}if(!e||(e&&d)){a&&a.stopPropagation();Ext.create("Ozone.components.admin.EditIntentWindow",{title:"Create Intent",action:e?d.get("action"):null,dataType:e?d.get("dataType"):null,send:e?d.get("send"):null,receive:e?d.get("receive"):null,width:Math.round(Ext.getBody().getViewSize().width*0.9),height:260,scope:this,callback:function(h){if(h!=undefined){var l={action:h.action,dataTypes:[h.dataType]},k=c.ownerCt,g=k.store.getById(k.recordId),i=g.get("intents");if(e){var j={action:d.get("action"),dataTypes:[d.get("dataType")]};c.removeIntentFromArray(j,i.send);c.removeIntentFromArray(j,i.receive)}c.removeIntentFromArray(l,i.send);c.removeIntentFromArray(l,i.receive);var f=function(o,n){if(n){for(var m=0;m<n.length;m++){if(n[m].action.toLowerCase()===l.action.toLowerCase()){return n[m].action}}}return o};l.action=f(f(l.action,i.send),i.receive);if(h.send){!i.send&&(i.send=[]);i.send.push(l)}if(h.receive){!i.receive&&(i.receive=[]);i.receive.push(l)}g.beginEdit();g.set("intents",i);g.setDirty();g.endEdit();k.store.save();k.fireEvent("recordupdated",{intents:i});k.down("#widgeteditproperties").getComponent("intents").setValue(Ext.JSON.encode(i))}}}).show()}else{c.editPanel.showAlert("Error","You must select an intent to edit.")}},onDelete:function(b,a){var c=this,d=this.getComponent("intentsGrid").getSelectionModel().getSelection()[0];if(d){c.editPanel.showConfirmation("Delete Intent","This action will permanently delete intent <b>"+Ext.htmlEncode(d.get("action"))+"</b> with data type <b>"+Ext.htmlEncode(d.get("dataType"))+"</b> from this widget.",function(g,k,h){if(g=="ok"){var j={action:d.get("action"),dataTypes:[d.get("dataType")]},i=c.ownerCt,e=i.store.getById(i.recordId),f=e.get("intents");c.removeIntentFromArray(j,f.send);c.removeIntentFromArray(j,f.receive);e.beginEdit();e.set("intents",f);e.setDirty();e.endEdit();i.store.save();i.fireEvent("recordupdated",{intents:f});i.down("#widgeteditproperties").getComponent("intents").setValue(Ext.JSON.encode(f))}})}else{c.editPanel.showAlert("Error","You must select an intent to delete.")}},removeIntentFromArray:function(d,c){if(c){for(var b=0;b<c.length;b++){if(c[b].action.toLowerCase()===d.action.toLowerCase()){if(c[b].dataTypes){for(var a=0;a<c[b].dataTypes.length;a++){if(c[b].dataTypes[a].toLowerCase()==d.dataTypes[0].toLowerCase()){Ext.Array.remove(c[b].dataTypes,c[b].dataTypes[a]);if(c[b].dataTypes.length==0){Ext.Array.remove(c,c[b])}break}}}}}}}});