Ext.define("Ozone.components.PropertiesPanel",{extend:"Ext.form.Panel",alias:["widget.propertiespanel","widget.Ozone.components.PropertiesPanel"],layout:"anchor",bodyCls:"properties-body",border:false,bodyBorder:true,preventHeader:true,padding:5,autoScroll:true,editPanel:null,initComponent:function(){var b=this;b.buttonAlign=b.buttonAlign||"left";b.buttons=[{text:"Apply",itemId:"apply",handler:b.onApply,scope:b}];b.defaults=Ext.apply(b.defaults||{},{labelSeparator:"",margin:"5 5 0 5",msgTarget:"side",anchor:"100%",listeners:{blur:{fn:b.handleBlur},change:{fn:b.handleChange},afterrender:{fn:function(e,c){var d=e.getComponentLayout();if(d.errorStrategies!=null){d.previousBeforeLayout=d.beforeLayout;d.beforeLayout=function(g,f){return this.previousBeforeLayout()||!this.owner.preventMark};d.errorStrategies.side={prepare:function(f){var h=f.findParentByType("widgeteditpropertiestab");var g=h?h.loadedFromDescriptor:false;var j=f.errorEl;var i=f.fieldLabel.indexOf("required-label")<0?false:true;if((f.hasActiveError()&&f.changed)||(i&&Ext.isEmpty(f.getValue())&&g)){j.removeCls(["owf-form-valid-field","x-form-warning-icon","owf-form-unchanged-field"]);j.addCls(Ext.baseCSSPrefix+"form-invalid-icon");d.tip=d.tip?d.tip:Ext.create("Ext.tip.QuickTip",{baseCls:Ext.baseCSSPrefix+"form-invalid-tip",renderTo:Ext.getBody()});d.tip.tagConfig=Ext.apply({},{attribute:"errorqtip"},d.tip.tagConfig);j.dom.setAttribute("data-errorqtip",f.getActiveError()||"");if(i&&Ext.isEmpty(f.getValue())){j.setDisplayed(true)}else{j.setDisplayed(f.hasActiveError())}}else{if(f.hasActiveWarning&&f.hasActiveWarning()&&f.changed){j.removeCls([Ext.baseCSSPrefix+"form-invalid-icon","owf-form-valid-field","owf-form-unchanged-field"]);j.addCls("x-form-warning-icon");d.tip=d.tip?d.tip:Ext.create("Ext.tip.QuickTip",{iconCls:"x-form-warning-icon",renderTo:Ext.getBody()});d.tip.tagConfig=Ext.apply({},{attribute:"errorqtip"},d.tip.tagConfig);j.dom.setAttribute("data-errorqtip",f.getActiveWarning()||"");j.setDisplayed(f.hasActiveWarning())}else{if(f.changed&&!g){if(d.tip){d.tip.unregister(j)}j.removeCls([Ext.baseCSSPrefix+"form-invalid-icon","x-form-warning-icon","owf-form-unchanged-field"]);j.addCls("owf-form-valid-field");j.dom.setAttribute("data-errorqtip","");j.setDisplayed(true)}else{j.removeCls([Ext.baseCSSPrefix+"form-invalid-icon","x-form-warning-icon","owf-form-valid-field"]);j.dom.setAttribute("data-errorqtip","");j.setDisplayed(false)}}}},adjustHorizInsets:function(f,g){if(f.autoFitErrors){g.insets.right+=f.errorEl.getWidth()}},adjustVertInsets:Ext.emptyFn,layoutHoriz:function(f,g){f.errorEl.setStyle("left",g.width-g.insets.right+"px")},layoutVert:function(f,g){f.errorEl.setStyle("top",g.insets.top+"px")},onFocus:Ext.emptyFn}}},scope:b}}});b.on("afterrender",function(d){var e=d.ownerCt;if(e.record){d.initFieldValues(e.record)}else{e.on("initialdataloaded",d.initFieldValues,d)}if(e.store){e.store.on("write",function(g,f,i){var h=f.getRecords();if(h){var j=h[0];if(j){var k=j.get("id");if(k){e.recordId=k}}}e.enableTabs();b.showApplyAlert("Your changes have been saved.")});if(e.store.proxy){var c=d;e.store.proxy.on("exception",function(j,g,f,i){if("create"==f.action){e.store.removeAll();if(Ext.isFunction(c.initFieldValues)){c.initFieldValues({})}}var h;try{h=(typeof g)=="string"?Ext.JSON.decode(g):g}catch(k){h={errorMsg:g}}b.editPanel.showAlert("Server Error!",Ext.htmlEncode(h.errorMsg))})}}});if(Ozone.config.freeTextEntryWarningMessage!=null&&Ozone.config.freeTextEntryWarningMessage!=""){var a=Ozone.config.freeTextEntryWarningMessage;this.items=this.items||[];this.items.splice(0,0,{xtype:"component",renderTpl:'<div id="{id}" class="{cls}"><div class="headerSpacer"></div>{message}</div>',renderData:{cls:(a&&a.length>0)?"dialogHeader":"",message:a?a:""}})}this.widgetStateHandler=Ozone.state.WidgetStateHandler.getInstance();b.callParent()},initFieldValues:Ext.emptyFn,handleBlur:function(a){a.changed=true;a.doComponentLayout();if(a.getXType()=="textfield"){a.setValue(Ext.String.trim(a.getValue()))}},handleChange:function(d,c,a,b){if(!d.changed&&d.isDirty()){d.changed=true}},refreshWidgetLaunchMenu:function(){if(this.widgetStateHandler){this.widgetStateHandler.handleWidgetRequest({fn:"refreshWidgetLaunchMenu"})}},onApply:function(){this.validateFields();if(!this.getForm().hasInvalidField()){var b=this;var c=b.ownerCt;var e=this.getValues();if(c.store.data.length>0){var a=c.store.getById(c.recordId);a.beginEdit();for(var d in e){if(!Ext.isFunction(d)){a.set(d,e[d])}}a.endEdit()}else{c.store.add(e);c.store.data.items[0].phantom=true;if(Ext.isFunction(b.initFieldValues)){b.initFieldValues(c.store.data.items[0])}}if(c.store.getNewRecords().length===0&&c.store.getUpdatedRecords().length===0){b.showApplyAlert("Your changes have been saved.")}c.store.save()}else{this.showApplyAlert("Invalid field, changes cannot be saved.",3000)}},showApplyAlert:function(d,c){var b=this,a=this.getDockedItems()[0];if(!a.getComponent(b.applyAlert)){b.applyAlert=Ext.widget("displayfield",{itemId:"applyAlert",name:"applyAlert",cls:"applyAlert",width:450,html:d});a.add(b.applyAlert);Ext.defer(function(){a.remove(b.applyAlert)},c?c:2000)}},validateFields:function(){var a=this.query("textfield");for(var b=0;b<a.length;b++){var c=a[b];if(!Ext.isFunction(c)){c.isValid();this.handleBlur(c)}}}});