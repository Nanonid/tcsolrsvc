Ext.define("Ozone.components.admin.UsersTabPanel",{extend:"Ext.panel.Panel",alias:["widget.userstabpanel"],layout:{type:"fit"},preventHeader:true,border:true,padding:5,initDisabled:true,editPanel:null,initComponent:function(){var a=this;Ext.apply(this,{dockedItems:[{xtype:"toolbar",itemId:"usersHeader",cls:"tbUsersGridHdr",dock:"top",items:[{xtype:"tbtext",itemId:"usersHeaderLabel",cls:"tbUsersGridHdr",text:"Users"},"->",{xtype:"searchbox",listeners:{searchChanged:{fn:function(c,d){var b=this.getComponent("usersgrid");if(b!=null){b.applyFilter(d,b.quickSearchFields)}},scope:this}}}]},{xtype:"toolbar",dock:"bottom",ui:"footer",itemId:"usersFooter",defaults:{minWidth:80},items:[{xtype:"button",text:"Add",itemId:"add",handler:function(){this.onAddClicked()},scope:this},{xtype:"button",text:"Remove",itemId:"remove",handler:function(){var d=this.getComponent("usersgrid");var c=d.getStore();var b=d.getSelectionModel().getSelection();if(b&&b.length>0){c.remove(b);c.save()}else{a.editPanel.showAlert("Error","You must select at least one user to remove.")}},scope:this}]}],items:[{xtype:"usersgrid",itemId:"usersgrid",preventHeader:true,border:false}]});this.widgetStateHandler=Ozone.state.WidgetStateHandler.getInstance();this.on({activate:{scope:this,fn:function(j,b){var c=j.getComponent("usersgrid");var h=j.ownerCt;var l=-1;var i=j.getDockedComponent("usersFooter");var e=i.getComponent("add");var m=i.getComponent("remove");var g=h.store.getAt(h.store.findExact("id",h.recordId));if(g.data.automatic){e.setDisabled(true);m.setDisabled(true)}OWF.Preferences.getUserPreference({namespace:"owf.admin.UserEditCopy",name:"guid_to_launch",onSuccess:function(o){j.guid_EditCopyWidget=o.value},onFailure:function(o){a.editPanel.showAlert("Preferences Error","Error looking up User Editor: "+o)}});c.setStore(Ext.create("Ozone.data.UserStore",j.storeCfg));var f=function(o){if(o.action=="destroy"||o.action=="create"){var p=c.getBottomToolbar();p.doRefresh()}};c.store.proxy.callback=f;c.store.on("write",function(r,s,o,q,p){OWF.Eventing.publish(this.ownerCt.channel,{action:s,domain:this.ownerCt.domain,records:o})},this);if(c&&h){if(Ext.isNumeric(h.recordId)){h.record=h.recordId>-1?h.store.getAt(h.store.findExact("id",h.recordId)):undefined;l=h.recordId>-1?h.recordId:-1}else{h.record=h.recordId?h.store.getAt(h.store.findExact("id",h.recordId)):undefined;l=h.recordId?h.recordId:-1}var d={tab:"users"};d[j.componentId]=l;c.setBaseParams(d);c.on({itemdblclick:{fn:function(){var o=c.getSelectionModel().getSelection();if(o&&o.length>0){for(var p=0;p<o.length;p++){j.doEdit(o[p].data.id,o[p].data.userRealName)}}else{a.editPanel.showAlert("Error","You must select at least one user to edit.")}},scope:this}})}if(h.record){var n=Ext.htmlEncode(Ext.util.Format.ellipsis(h.record.get("title"),25));if(!n){n=Ext.htmlEncode(Ext.util.Format.ellipsis(h.record.get("name"),25))||"Users"}var k=j.getDockedItems('toolbar[dock="top"]')[0].getComponent("usersHeaderLabel");k.setText(n)}},single:true}});this.on({activate:{fn:function(){var c=this.getComponent("usersgrid");var b=c.getStore();if(b){b.load({params:{offset:0,max:b.pageSize}})}},scope:this}});this.callParent(arguments)},refreshWidgetLaunchMenu:function(){if(this.widgetStateHandler){this.widgetStateHandler.handleWidgetRequest({fn:"refreshWidgetLaunchMenu"})}},onAddClicked:function(a,d){var b=this.ownerCt.record.get("title");if(!b){b=this.ownerCt.record.get("name")}var c=Ext.widget("admineditoraddwindow",{addType:"User",itemName:b,editor:this.editor,focusOnClose:this.down(),existingItemsStore:this.getComponent("usersgrid").getStore(),grid:Ext.widget("usersgrid",{itemId:"usersaddgrid",border:false,enableColumnHide:false,sortableColumns:false})});c.show()},doEdit:function(c,b){var a=Ozone.util.toString({id:c,copyFlag:false});OWF.Launcher.launch({title:"$1 - "+b,titleRegex:/(.*)/,guid:this.guid_EditCopyWidget,launchOnlyIfClosed:false,data:a},function(d){if(d.error){this.editPanel.showAlert("Launch Error","User Editor Launch Failed: "+d.message)}})}});