Ext.define("Ozone.components.admin.widget.WidgetManagementPanel",{extend:"Ozone.components.admin.ManagementPanel",alias:["widget.widgetmanagement","widget.widgetmanagementpanel","widget.Ozone.components.admin.widget.WidgetManagementPanel"],dragAndDrop:true,launchesWidgets:true,channel:"AdminChannel",defaultTitle:"Widgets",minButtonWidth:80,cls:"widgetmanagementpanel",detailsAutoOpen:true,initComponent:function(){var a=this;OWF.Preferences.getUserPreference({namespace:"owf.admin.WidgetEditCopy",name:"guid_to_launch",onSuccess:function(b){a.guid_EditCopyWidget=b.value},onFailure:function(b){a.showAlert("Preferences Error","Error looking up Widget Editor: "+b)}});Ext.applyIf(this,{xtype:"panel",itemId:"main",layout:{type:"border"},items:[{xtype:"widgetsgrid",itemId:"grid",border:false,region:"center"},{xtype:"widgetdetailpanel",itemId:"widgetdetailpanel",region:"east",preventHeader:true,collapseMode:"mini",collapsible:true,collapsed:true,split:true,border:false,width:300}],dockedItems:[{xtype:"toolbar",dock:"top",layout:{type:"hbox",align:"stretchmax"},items:[{itemId:"tbtext",xtype:"tbtext",text:'<span class="heading-bold">'+this.defaultTitle+" </span>"},"->",{xtype:"searchbox",listeners:{searchChanged:function(c,d){var b=a.down("#grid");if(b!=null){b.applyFilter(d,["displayName","universalName"])}}}}]},{xtype:"toolbar",dock:"bottom",ui:"footer",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"button",text:"Create",itemId:"create",handler:function(c,b){b.stopPropagation();this.doCreate()},scope:this},{xtype:"splitbutton",text:"Edit",itemId:"editButton",handler:function(){var d=this.down("#grid");var b=d.getSelectionModel().getSelection();if(b&&b.length>0){for(var c=0;c<b.length;c++){this.doEdit(b[c].data.id,b[c].data.name)}}else{a.showAlert("Error","You must select at least one widget to edit.")}},menu:{xtype:"menu",plain:true,hideMode:"display",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"owfmenuitem",text:"Export",handler:function(c){var b=a.down("#grid").getSelectionModel().getSelection();if(b&&b.length===1){a.doExport("widget",b[0])}else{if(b&&b.length>1){a.showAlert("Error","You must select only one widget to export.")}else{a.showAlert("Error","You must select a widget to export.")}}}}]},scope:this},{xtype:"button",text:"Delete",itemId:"deleteButton",handler:function(){var c=this.down("#grid");var b=c.getSelectionModel().getSelection();if(b&&b.length>0){this.createDeleteWindow(b)}else{a.showAlert("Error","You must select at least one widget to delete.")}},scope:this}]}]});this.callParent();OWF.Eventing.subscribe("AdminChannel",owfdojo.hitch(this,function(b,d,c){if(d.domain==="Widget"){this.down("#grid").getBottomToolbar().doRefresh()}}));this.on({render:{fn:function(){var b=this.down("#grid");if(b!=null){b.on({itemdblclick:{fn:function(){var c=b.getSelectionModel().getSelection();if(c&&c.length>0){for(var d=0;d<c.length;d++){this.doEdit(c[d].data.id,c[d].data.name)}}else{a.showAlert("Error","You must select at least one widget to edit.")}},scope:this},select:{fn:function(g,c,d,e){var f=this.down("#widgetdetailpanel");if(f!=null){f.load(c);if(this.detailsAutoOpen){f.expand()}}},scope:this}});b.getView().on({itemkeydown:{scope:this,fn:function(e,d,g,f,c){switch(c.getKey()){case c.SPACE:case c.ENTER:this.doEdit(d.data.id,d.data.name)}}}});b.load();b.store.on({datachanged:{fn:function(){var c=this.down("#widgetdetailpanel");if(c!=null){c.collapse();c.clear()}if(!this.disableLaunchMenuRefresh){this.refreshWidgetLaunchMenu()}},scope:this}})}},scope:this},afterrender:{fn:function(){var b=this.el.down(".x-collapse-el");b.on("click",function(){var c=this.el.down(".x-splitter-collapsed");if(c){this.detailsAutoOpen=true}else{this.detailsAutoOpen=false}},this)},scope:this}})},createDeleteWindow:function(e){var c=this;var d=Ext.getBody().getViewSize();var a=[];if(e!=null){for(var b=0;b<e.length;b++){a.push(e[b].data.widgetGuid)}}OWF.Preferences.getDependentWidgets({content:{ids:a},onSuccess:Ext.bind(function(g){var f=g.data;if(f!=null&&f.length>0){var h=Ext.create("Ext.window.Window",{title:"Warning",itemId:"deletewidgetwindow",minWidth:250,minHeight:200,width:d.width*0.8,height:d.height*0.75,layout:"fit",modal:true,items:[{xtype:"deletewidgetspanel",itemId:"deletewidgetspanel",delWidgets:e,requiredWidgets:f,listeners:{"delete":{fn:function(j){if(j!=null&&j.widgetGuidsToDelete!=null){OWF.Preferences.deleteWidgetDefs({content:{id:j.widgetGuidsToDelete,_method:"delete"},onSuccess:Ext.bind(function(k){var l=this.down("#grid");if(l!=null){l.refresh()}h.close()},this),onFailure:function(){c.showAlert(Ozone.util.ErrorMessageString.saveUpdatedWidgets,Ozone.util.ErrorMessageString.saveUpdatedWidgetsMsg)}})}},scope:this},cancel:{fn:function(){h.close()},scope:this}}}]});h.show()}else{var i="This action will permanently delete ";if(e.length==1){i+='<span class="heading-bold">'+Ext.htmlEncode(e[0].data.name)+"</span>."}else{i+='the selected <span class="heading-bold">'+e.length+" widgets</span>."}this.showConfirmation("Warning",i,function(n,p,o){if(n=="ok"){var m=c.down("#grid");var k=m.store;var j=k.autoSave;k.autoSave=false;k.remove(e);var l=k.getTotalCount()-e.length;k.on({write:{fn:function(t,q,v){if(k.data.items.length==0&&k.currentPage>1){var u=k.getPageFromRecordIndex(l-1);var r=(u>=k.currentPage)?k.currentPage:u;k.loadPage(r)}m.getBottomToolbar().doRefresh()},scope:this,single:true}});k.save()}})}},this),onFailure:function(){c.showAlert("Error","Error deleting the selected widget(s).")}})}});