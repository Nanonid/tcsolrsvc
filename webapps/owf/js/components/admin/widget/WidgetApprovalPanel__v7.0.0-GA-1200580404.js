Ext.define("Ozone.components.admin.widget.WidgetApprovalPanel",{extend:"Ozone.components.admin.ManagementPanel",alias:["widget.WidgetApprovalPanel","widget.widgetapprovalpanel","widget.Ozone.components.admin.widget.WidgetApprovalPanel"],dragAndDrop:true,launchesWidgets:true,channel:"AdminChannel",defaultTitle:"Widget Requests",minButtonWidth:80,cls:"widgetapprovalpanel",detailsAutoOpen:true,initComponent:function(){var a=this;Ext.apply(this,{xtype:"panel",itemId:"main",layout:{type:"border"},items:[{xtype:"widgetapprovalsgrid",itemId:"grid",border:false,region:"center"},{xtype:"widgetdetailpanel",itemId:"widgetdetailpanel",store:Ext.create("Ozone.data.stores.WidgetApprovalStore"),region:"east",preventHeader:true,collapseMode:"mini",collapsible:true,collapsed:true,split:true,border:false,width:300}],dockedItems:[{xtype:"toolbar",dock:"top",layout:{type:"hbox",align:"stretchmax"},items:[{itemId:"tbtext",xtype:"tbtext",text:'<span class="heading-bold">'+this.defaultTitle+" </span>"},"->",{xtype:"searchbox",listeners:{searchChanged:function(c,d){var b=a.down("#grid");if(b!=null){b.applyFilter(d,["name","userId","userRealName"])}}}}]},{xtype:"toolbar",dock:"bottom",ui:"footer",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"button",text:"Approve",itemId:"approveButton",handler:function(){var c=this.down("#grid");var b=c.getSelectionModel().getSelection();if(b&&b.length>0){this.approve(b)}else{a.showAlert("Error","You must select at least one widget to approve.")}},scope:this},{xtype:"button",text:"Reject",itemId:"rejectButton",handler:function(){var c=this.down("#grid");var b=c.getSelectionModel().getSelection();if(b&&b.length>0){this.reject(b)}else{a.showAlert("Error","You must select at least one widget to reject.")}},scope:this}]}]});this.callParent();this.on({render:{fn:function(){var b=this.down("#grid");if(b!=null){b.on({select:{fn:function(g,c,d,e){var f=this.down("#widgetdetailpanel");if(f!=null){f.load(c);if(this.detailsAutoOpen){f.expand()}}},scope:this}});b.load();b.store.on({datachanged:{fn:function(){var c=this.down("#widgetdetailpanel");if(c!=null){c.collapse();c.clear()}if(!this.disableLaunchMenuRefresh){this.refreshWidgetLaunchMenu()}},scope:this}})}},scope:this},afterrender:{fn:function(){var b=this.el.down(".x-collapse-el");b.on("click",function(){var c=this.el.down(".x-splitter-collapsed");if(c){this.detailsAutoOpen=true}else{this.detailsAutoOpen=false}},this)},scope:this}})},createApprovalWindow:function(g){var h=this;var b=Ext.create("Ext.util.MixedCollection");b.getKey=function(i){return i};var f=Ext.create("Ext.util.MixedCollection");b.getKey=function(i){return i};var e=Ext.create("Ext.util.MixedCollection");e.getKey=function(i){return i.userId+"-"+i.widgetGuid};if(g!=null){for(var d=0;d<g.length;d++){var a=g[d].data;b.add(a.widgetGuid);e.add({userId:a.userId,widgetGuid:a.widgetGuid});if(a.allRequired!=null&&a.allRequired.length>0){for(var c=0;c<a.allRequired.length;c++){f.add(a.allRequired[c]);e.add({userId:a.userId,widgetGuid:a.allRequired[c]})}}}}Ext.Ajax.request({url:Ozone.util.contextPath()+"/widget",params:{id:f.getRange(),_method:"GET"},success:function(l,j){var r=Ext.decode(l.responseText);if(r){var m=r.data;if(m!=null&&m.length>0){var o=[];if(m){for(var n=0;n<m.length;n++){var q={id:m[n].id,name:m[n].value.namespace,version:m[n].value.widgetVersion,url:m[n].value.url,headerIcon:m[n].value.headerIcon,image:m[n].value.image,width:m[n].value.width,height:m[n].value.height,widgetGuid:m[n].path,maximized:m[n].value.maximized,minimized:m[n].value.minimized,x:m[n].value.x,y:m[n].value.y,visible:m[n].value.visible,tags:m[n].value.tags,userId:m[n].value.userId,userRealName:m[n].value.userRealName,totalUsers:m[n].value.totalUsers,totalGroups:m[n].value.totalGroups,singleton:m[n].value.singleton};if(!b.containsKey(q.widgetGuid)){o.push(q)}}}var k="You have selected to approve ";var p=g.length;k+=p>1?('<span class="heading-bold">'+p+"</span> widgets"):('<span class="heading-bold">'+g[0].data.name+"</span>");k+=". <br/><br/> "+(p>1?"These widgets require":"This widget requires")+" other widget(s) in OWF. Approving "+(p>1?"these widgets":"this widget ")+" will automatically approve "+(p>1?"their":"its")+" required widget(s).";this.showConfirmation("Warning",k,function(i,t,s){if(i=="ok"){this.doApproveReject(e.getRange())}})}}},failure:function(i,j){h.showAlert("Error","Error retrieving required widgets.")},scope:this})},approve:function(c){var a=false;if(c!=null){for(var b=0;b<c.length;b++){if(c[b].data.allRequired!=null&&c[b].data.allRequired.length>0){a=true;break}}if(a){this.createApprovalWindow(c)}else{this.doApproveReject(c)}}},reject:function(a){this.doApproveReject(null,a)},doApproveReject:function(b,e){var j=[];var g=[];var a=new Date();var h=Ext.Date.format(a,"Y-m-d");if(b){for(var d=0,f=b.length;d<f;d++){var c=b[d].data!=null?b[d].data:b[d];j.push({userId:c.userId,widgetGuid:c.widgetGuid})}}if(e){for(var d=0,f=e.length;d<f;d++){var c=e[d].data!=null?e[d].data:e[d];g.push({userId:c.userId,widgetGuid:c.widgetGuid})}}Ext.Ajax.request({url:Ozone.util.contextPath()+"/widget/approve",method:"POST",timeout:30000,autoAbort:false,disableCaching:true,params:{toApprove:Ext.encode(j),toDelete:Ext.encode(g)},scope:this,success:function(){var i=this.down("#grid");i.refresh();var k=Ext.getCmp("approvewindow");if(k){k.close()}},failure:function(){me.showAlert("Error","Server Error during approve or reject.");var i=Ext.getCmp("approvewindow");if(i){i.close()}}})}});