Ext.define("Ozone.components.admin.widget.WidgetEditPropertiesTab",{extend:"Ozone.components.PropertiesPanel",alias:["widget.widgeteditproperties","widget.widgeteditpropertiestab","widget.Ozone.components.admin.widget.WidgetEditPropertiesTab"],widgetTypeStore:null,cls:"widgeteditpropertiestab",record:null,xhr:null,initComponent:function(){var b=this;var a=guid.util.guid();this.widgetTypeStore=Ext.create("Ozone.data.WidgetTypeStore");Ext.applyIf(this,{layout:"fit",title:"Properties",iconCls:"properties-tab",defaults:{labelWidth:150},items:[{xtype:"component",itemId:"descriptorUrlInfo",name:"descriptorUrlInfo",cls:"descriptorUrlInfo",renderTpl:'<div class="descriptorUrlHeader"><div class="descriptorUrlTitle">{descriptorUrlTitle}</div><button class="descriptorUrlInfoIcon" ></button></div>',renderData:{descriptorUrlTitle:"Import Widget from Descriptor URL"},renderSelectors:{iconEl:".descriptorUrlInfoIcon",titleEl:".descriptorUrlTitle"},listeners:{afterrender:function(c){c.iconEl.on("click",function(){var d=c.ownerCt.getComponent("descriptorUrlInfoMsg");if(d.isVisible()){d.hide()}else{d.show()}},this);Ozone.components.focusable.Focusable.setupFocus(c.iconEl,this);new Ext.util.KeyMap(c.iconEl,{key:[Ext.EventObject.ENTER],fn:function(e,d){d.stopEvent();var f=this.ownerCt.getComponent("descriptorUrlInfoMsg");if(f.isVisible()){f.hide()}else{f.show()}},scope:c})}}},{xtype:"component",itemId:"descriptorUrlInfoMsg",name:"descriptorUrlInfoMsg",cls:"descriptorUrlInfoMsg",hidden:true,html:"Enter the URL of a Widget Descriptor and click the Load button. Widget data is automatically retrieved from a Web-accessible location. To create the Widget Definition in OWF, click Apply."},{xtype:"urlfield",itemId:"descriptorUrl",name:"descriptorUrl",cls:"descriptorUrlField",allowBlank:true,maxLength:2083,enableKeyEvents:true,preventMark:true,emptyText:"https://mycompany.com/widget/descriptor.html",usePlaceholderIfAvailable:false,value:"",rawValue:"",anchor:"100%",listeners:{change:{fn:this.handleDescriptorUrlChange,scope:this},specialkey:{fn:function(d,c){if(c.getKey()==c.ENTER){this.loadDescriptor(this)}},scope:this}}},{xtype:"toolbar",dock:"bottom",itemId:"descriptorUrlToolbar",name:"descriptorUrlToolbar",cls:"descriptorUrlToolbar",ui:"footer",defaults:{minWidth:75},items:[{text:"<u>Don't have a descriptor URL?</u>",itemId:"manualEntryLinkBtn",cls:"manualEntryLinkBtn",handler:function(c){var d=this.getComponent("descriptorUrl");d.setValue("");this.showProperties(true);this.getComponent("descriptorUrlErrorMsg").hide()},scope:this},"->",{text:"Load",itemId:"descriptorUrlBtn",name:"descriptorUrlBtn",cls:"descriptorUrlBtn",margin:0,disabled:true,handler:function(c){var d=c.getText();if(d=="Load"){this.loadDescriptor(this)}else{var f=this.getComponent("descriptorUrlLoading");var e=this.getComponent("descriptorUrl");if(this.xhr){this.xhr.cancel()}f.hide();e.enable();c.setText("Load")}},scope:this}]},{xtype:"component",itemId:"descriptorUrlLoading",name:"descriptorUrlLoading",cls:"descriptorUrlLoading",hidden:true,html:'<img src="../themes/common/images/shared/large-loading.gif" /><br />Loading...'},{xtype:"component",itemId:"descriptorUrlErrorMsg",name:"descriptorUrlErrorMsg",cls:"descriptorUrlErrorMsg",hidden:true,html:"Unable to retrieve widget information. Please check your descriptor and try again."},{xtype:"component",name:"horizontalRule",itemId:"horizontalRule",cls:"horizontalRule",hidden:true,html:"<hr>"},{xtype:"component",itemId:"manualEntryTitle",name:"manualEntryTitle",cls:"manualEntryTitle",hidden:true,html:"Enter Widget Description"},{xtype:"hidden",name:"widgetGuid",itemId:"widgetGuid",value:a,preventMark:true},{xtype:"textfield",itemId:"name",name:"name",hidden:true,allowBlank:false,blankText:Ozone.layout.DialogMessages.widgetDefinition_displayNameField_blankText,maxLength:256,emptyText:"MyWidget",usePlaceholderIfAvailable:false,fieldLabel:Ozone.util.createRequiredLabel("Name")},{xtype:"textarea",itemId:"description",name:"description",hidden:true,allowBlank:true,maxLength:4000,emptyText:"Describe the widget",usePlaceholderIfAvailable:false,fieldLabel:"Description"},{xtype:"textfield",name:"version",itemId:"version",hidden:true,allowBlank:true,blankText:Ozone.layout.DialogMessages.widgetDefinition_widgetVersionField_blankText,maxLength:256,emptyText:"1.0",usePlaceholderIfAvailable:false,fieldLabel:"Version"},{xtype:"textfield",name:"universalName",itemId:"universalName",hidden:true,allowBlank:true,emptyText:"MyWidget.mycompany.com",usePlaceholderIfAvailable:false,fieldLabel:"Universal Name"},{xtype:"displayfield",fieldLabel:"GUID",itemId:"guid",hidden:true,value:a,preventMark:true},{xtype:"urlfield",name:"url",itemId:"url",hidden:true,allowBlank:false,blankText:Ozone.layout.DialogMessages.widgetDefinition_widgetUrlField_blankText,fieldLabel:Ozone.util.createRequiredLabel("URL"),emptyText:"https://mycompany.com/widget/MyWidget.html",usePlaceholderIfAvailable:false,maxLength:2083},{xtype:"urlfield",name:"headerIcon",itemId:"headerIcon",hidden:true,allowBlank:false,blankText:Ozone.layout.DialogMessages.widgetDefinition_imageUrlSmallField_blankText,maxLength:2083,emptyText:"https://mycompany.com/widget/images/containerIcon.png",usePlaceholderIfAvailable:false,fieldLabel:Ozone.util.createRequiredLabel("Container Icon URL")},{xtype:"urlfield",name:"image",itemId:"image",hidden:true,allowBlank:false,blankText:Ozone.layout.DialogMessages.widgetDefinition_imageLargeUrlField_blankText,maxLength:2083,emptyText:"https://mycompany.com/widget/images/launchMenuIcon.png",usePlaceholderIfAvailable:false,fieldLabel:Ozone.util.createRequiredLabel("Launch Menu Icon URL")},{xtype:"numberfield",name:"width",itemId:"width",hidden:true,allowBlank:false,blankText:Ozone.layout.DialogMessages.widgetDefinition_widthNumberField_blankText,fieldLabel:Ozone.util.createRequiredLabel("Width"),value:200,minValue:200,maxValue:2000},{xtype:"numberfield",name:"height",itemId:"height",hidden:true,allowBlank:false,blankText:Ozone.layout.DialogMessages.widgetDefinition_heightNumberField_blankText,fieldLabel:Ozone.util.createRequiredLabel("Height"),value:200,minValue:200,maxValue:2000},{xtype:"textfield",name:"_tags",itemId:"_tags",hidden:true,emptyText:"geo, map, tracking",usePlaceholderIfAvailable:false,fieldLabel:"Default Tags"},{xtype:"combobox",name:"_types",itemId:"_types",hidden:true,fieldLabel:Ozone.util.createRequiredLabel("Widget Type"),valueNotFoundText:"invalid widget type",forceSelection:true,allowBlank:false,editable:false,store:this.widgetTypeStore,displayField:"name",valueField:"id",autoSelect:true,queryMode:"local"},{xtype:"checkbox",name:"singleton",itemId:"singleton",hidden:true,submitValue:true,fieldLabel:"Singleton",preventMark:true},{xtype:"checkbox",name:"visible",itemId:"visible",hidden:true,submitValue:true,checked:true,fieldLabel:"Visible",preventMark:true},{xtype:"checkbox",name:"background",itemId:"background",hidden:true,submitValue:true,checked:false,fieldLabel:"Background",preventMark:true},{xtype:"hidden",name:"intents",itemId:"intents",value:null,preventMark:true}]});this.addEvents("recordupdated");this.callParent(arguments);this.on("afterrender",function(){var e=this.getDockedItems('toolbar[dock="bottom"]');var c=e[0].getComponent("apply");c.disable();if(this.ownerCt.launchData&&this.ownerCt.launchData.id){this.showProperties(true)}var d=this.getComponent("_types");if(!d.value){this.widgetTypeStore.load({callback:function(){d.setRawValue(d.store.findRecord("name","standard").get("name"));b.setWidgetType()}})}},this,{single:true})},initFieldValues:function(c){var h=this;var z=c?c.data:c;this.record=z;if(z){var y="";var a=(z&&z.widgetGuid)?z.widgetGuid:p.util.guid();var u=h.getComponent("widgetGuid"),A=h.getComponent("name"),r=h.getComponent("description"),d=h.getComponent("version"),w=h.getComponent("universalName"),p=h.getComponent("guid"),e=h.getComponent("url"),g=h.getComponent("headerIcon"),n=h.getComponent("image"),o=h.getComponent("width"),m=h.getComponent("height"),l=h.getComponent("_tags"),k=h.getComponent("singleton"),b=h.getComponent("visible"),t=h.getComponent("background"),f=h.getComponent("_types"),x=h.getComponent("descriptorUrl"),q=h.getComponent("intents");for(var s=0;z&&z.tags&&s<z.tags.length;s++){y+=z.tags[s].name;if(s<z.tags.length-1){y+=", "}}y=Ext.util.Format.htmlDecode(y);u.setValue(a).originalValue=a;A.setValue(z.name).originalValue=z.name;r.setValue(z.description).originalValue=z.description;d.setValue(z.version).originalValue=z.version;w.setValue(z.universalName).originalValue=z.universalName;p.setValue(a).originalValue=a;e.setValue(z.url).originalValue=z.url;g.setValue(z.headerIcon).originalValue=z.headerIcon;n.setValue(z.image).originalValue=z.image;o.setValue(z.width).originalValue=z.width;m.setValue(z.height).originalValue=z.height;l.setValue(y).originalValue=y;k.setValue(z.singleton).originalValue=z.singleton;b.setValue(z.visible).originalValue=z.visible;t.setValue(z.background).originalValue=z.background;if(!x.getValue()){x.setValue(z.descriptorUrl).originalValue=z.descriptorUrl}var j=Ext.JSON.encode(z.intents);q.setValue(j).originalValue=j;this.setWidgetType();h.getComponent("descriptorUrlInfo").titleEl.dom.innerHTML="Update Widget from Descriptor URL";h.getComponent("descriptorUrlInfoMsg").update("Click Load to update the widget. If the widget descriptor file changed since it was added to your instance of OWF, clicking Load will retrieve the latest widget data. To upload it to your OWF, click Apply.");var v=h.ownerCt.down("#intents-tab");v.down("#btnCreate").enable();v.down("#btnEdit").enable();v.down("#btnDelete").enable();this.getForm().isValid()}this.ownerCt.fireEvent("recordupdated",this.record)},loadDescriptor:function(a){var e=a.getComponent("descriptorUrl"),g=a.getComponent("descriptorUrlLoading"),f=Ext.String.trim(e.getValue()),c=a.getComponent("descriptorUrlToolbar").getComponent("descriptorUrlBtn"),b=this.getDockedItems('toolbar[dock="bottom"]')[0].getComponent("apply"),d=descriptorUrlToolbar.getComponent("manualEntryLinkBtn");a.getComponent("descriptorUrlErrorMsg").hide();e.disable();a.showProperties(false);g.show();a.xhr=Ozone.util.Transport.send({url:f,method:"GET",forceXdomain:true,onSuccess:Ext.bind(a.updatePropertiesFromDescriptor,a),onFailure:function(h){if(a.record){a.showProperties(true)}else{d.show()}g.hide();e.enable();c.setText("Load");a.getComponent("descriptorUrlErrorMsg").show()},autoSendVersion:false});c.setText("Cancel");b.disable()},updatePropertiesFromDescriptor:function(B){this.loadedFromDescriptor=true;this.showProperties(true);var l=this;var e=this.getComponent("descriptorUrlLoading");e.hide();var j=this.getComponent("descriptorUrlToolbar").getComponent("descriptorUrlBtn");j.setText("Load");var z=l.getComponent("descriptorUrl");z.enable();this.loadedDecriptorUrl=z.getValue();this.record=B;if(B){var A="";var a=(B&&B.widgetGuid)?B.widgetGuid:this.generateNewGuid();var x=l.getComponent("widgetGuid"),C=l.getComponent("name"),u=l.getComponent("description"),d=l.getComponent("version"),y=l.getComponent("universalName"),s=l.getComponent("guid"),f=l.getComponent("url"),k=l.getComponent("headerIcon"),p=l.getComponent("image"),r=l.getComponent("width"),o=l.getComponent("height"),n=l.getComponent("_tags"),m=l.getComponent("singleton"),b=l.getComponent("visible"),w=l.getComponent("background"),h=l.getComponent("_types"),t=l.getComponent("intents");for(var v=0;B&&B.defaultTags&&v<B.defaultTags.length;v++){A+=B.defaultTags[v];if(v<B.defaultTags.length-1){A+=", "}}A=Ext.util.Format.htmlDecode(A);if(!this.ownerCt.recordId){x.setValue(Ext.String.trim(a));s.setValue(Ext.String.trim(a))}C.setValue(Ext.String.trim(B.displayName));u.setValue(Ext.String.trim(B.description||""));d.setValue(Ext.String.trim(B.widgetVersion||""));y.setValue(Ext.htmlEncode(B.universalName)||"");f.setValue(Ext.String.trim(B.widgetUrl));k.setValue(Ext.String.trim(B.imageUrlSmall));p.setValue(Ext.String.trim(B.imageUrlLarge));r.setValue(B.width);o.setValue(B.height);n.setValue(Ext.String.trim(A));m.setValue(B.singleton);b.setValue(B.visible);w.setValue(B.background);t.setValue(Ext.JSON.encode(B.intents||""));this.record.intents=B.intents||{};var c=B.widgetTypes[0];if(!Ext.isNumeric(c)){h.setRawValue(h.store.findRecord("name","standard").get("name"));c=this.widgetTypeStore.getAt(this.widgetTypeStore.find("name",c)).get("id")}this.getComponent("_types").setValue(c);B.title=Ext.String.trim(B.displayName);this.ownerCt.record=new Ozone.data.WidgetDefinition(B);this.ownerCt.record.phantom=true;var q=this.getDockedItems('toolbar[dock="bottom"]');var g=q[0].getComponent("apply");g.enable()}this.getForm().isValid();this.ownerCt.fireEvent("recordupdated",this.record)},showProperties:function(v){var o=this.getComponent("descriptorUrlToolbar");var q=o.getComponent("manualEntryLinkBtn");q.hide();var g=this;var u=g.getComponent("horizontalRule"),s=g.getComponent("manualEntryTitle"),w=g.getComponent("name"),p=g.getComponent("description"),b=g.getComponent("version"),t=g.getComponent("universalName"),n=g.getComponent("guid"),c=g.getComponent("url"),f=g.getComponent("headerIcon"),k=g.getComponent("image"),m=g.getComponent("width"),j=g.getComponent("height"),i=g.getComponent("_tags"),h=g.getComponent("singleton"),a=g.getComponent("visible"),r=g.getComponent("background"),e=g.getComponent("_types");if(v){var l=this.getDockedItems('toolbar[dock="bottom"]');var d=l[0].getComponent("apply");d.enable();u.show();s.show();w.show();p.show();b.show();t.show();n.show();c.show();f.show();k.show();m.show();j.show();i.show();h.show();a.show();r.show();e.show()}else{u.hide();s.hide();w.hide();p.hide();b.hide();t.hide();n.hide();c.hide();f.hide();k.hide();m.hide();j.hide();i.hide();h.hide();a.hide();r.hide();e.hide()}},handleDescriptorUrlChange:function(f,e,a,b){var d=this,c=this.getForm();descriptorUrlToolbar=this.getComponent("descriptorUrlToolbar");descriptorUrlBtn=descriptorUrlToolbar.getComponent("descriptorUrlBtn");if(!f.changed&&f.isDirty()){f.changed=true}if(f.isValid()&&f.getValue()){descriptorUrlBtn.enable()}else{descriptorUrlBtn.disable()}},onApply:function(){this.validateFields();if(!this.getForm().hasInvalidField()){var b=this;var h=b.ownerCt;var k=null;var d=["widgetGuid","name","description","version","universalName","guid","url","headerIcon","image","width","height","_tags","singleton","visible","background","_types","intents"];var l={};for(var g=0;g<d.length;g++){var o=d[g];var n=this.getComponent(o);var q=n.getValue();if(Ext.isEmpty(q)||(n.inputEl&&n.inputEl.hasCls(n.emptyCls))){if(o in ["singleton","visible","background"]){l[o]=false}else{l[o]=""}}else{if(o=="intents"&&q){l[o]=Ozone.util.parseJson(q)}else{l[o]=q}}}if(b.loadedDecriptorUrl){l.descriptorUrl=b.loadedDecriptorUrl}if(h.store.data.length>0){k=h.store.getById(h.recordId);k.beginEdit();for(o in l){k.set(o,l[o])}k.endEdit()}else{h.store.add(l);k=h.store.data.items[0];k.phantom=true}var r=[];var e=l._tags;if(e&&e.length>0&&e!=""){var p=e.split(",");for(var f=0;f<p.length;f++){var c=Ext.String.trim(p[f]);if(c!=""){r.push({name:c,visible:true,position:-1,editable:true})}}}var m=[];var a=l._types;if(!Ext.isNumeric(a)){a=this.widgetTypeStore.getAt(this.widgetTypeStore.find("name",a)).get("id")}m.push({id:a,name:this.widgetTypeStore.getById(a).get("name")});k.beginEdit();k.set("title",l.name);k.set("tags",r);k.set("widgetTypes",m);k.endEdit();h.record=k;h.store.on({write:{fn:function(){if(Ext.isFunction(b.initFieldValues)){b.showProperties(true);b.initFieldValues(h.record)}this.refreshWidgetLaunchMenu()},scope:this,single:true}});h.store.save()}else{this.showApplyAlert("Invalid field, changes cannot be saved.",3000)}},setWidgetType:function(){var a=this.getComponent("_types");if(a){if(this.record&&this.record.widgetTypes){var b=this.record.widgetTypes[0];if(b){a.setValue(b.id).originalValue=b.id}}}},generateNewGuid:function(){return guid.util.guid()}});