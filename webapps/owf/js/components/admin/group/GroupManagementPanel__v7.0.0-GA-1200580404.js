Ext.define("Ozone.components.admin.group.GroupManagementPanel",{extend:"Ozone.components.admin.ManagementPanel",alias:["widget.groupmanagement"],layout:"fit",gridGroups:null,pnlGroupDetail:null,txtHeading:null,lastAction:null,guid_EditCopyWidget:null,widgetStateHandler:null,dragAndDrop:true,launchesWidgets:true,channel:"AdminChannel",defaultTitle:"Groups",minButtonWidth:80,detailsAutoOpen:true,initComponent:function(){var a=this;OWF.Preferences.getUserPreference({namespace:"owf.admin.GroupEditCopy",name:"guid_to_launch",onSuccess:function(b){a.guid_EditCopyWidget=b.value},onFailure:function(b){a.showAlert("Preferences Error","Error looking up Group Editor: "+b)}});this.gridGroups=Ext.create("Ozone.components.admin.GroupsGrid",{preventHeader:true,region:"center",border:false});this.gridGroups.store.load({params:{offset:0,max:this.pageSize}});this.relayEvents(this.gridGroups,["datachanged","select","deselect","itemdblclick"]);this.pnlGroupDetail=Ext.create("Ozone.components.admin.group.GroupDetailPanel",{layout:{type:"fit",align:"stretch"},region:"east",preventHeader:true,collapseMode:"mini",collapsible:true,collapsed:true,split:true,border:false,width:200});this.txtHeading=Ext.create("Ext.toolbar.TextItem",{text:'<span class="heading-bold">'+this.defaultTitle+"</span>"});this.searchBox=Ext.widget("searchbox");this.items=[{xtype:"panel",layout:"border",border:false,items:[this.gridGroups,this.pnlGroupDetail]}];this.dockedItems=[{xtype:"toolbar",dock:"top",layout:{type:"hbox",align:"stretchmax"},items:[this.txtHeading,{xtype:"tbfill"},this.searchBox]},{xtype:"toolbar",dock:"bottom",ui:"footer",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"button",text:"Create",handler:function(c,b){b.stopPropagation();a.doCreate()}},{xtype:"splitbutton",text:"Edit",itemId:"btnEdit",handler:function(){var b=a.gridGroups.getSelectionModel().getSelection();if(b&&b.length>0){for(var c=0;c<b.length;c++){a.doEdit(b[c].data.id,b[c].data.displayName)}}else{a.showAlert("Error","You must select at least one group to edit.")}},menu:{xtype:"menu",plain:true,hideMode:"display",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"owfmenuitem",text:"Activate",handler:function(b){a.doActivate()}},{xtype:"owfmenuitem",text:"Deactivate",handler:function(b){a.doDeactivate()}}]}},{xtype:"button",text:"Delete",itemId:"btnDelete",handler:function(b){a.doDelete()}}]}];this.on("datachanged",function(b,c){if(this.pnlGroupDetail!=null){this.pnlGroupDetail.collapse();this.pnlGroupDetail.removeData()}if(!this.disableLaunchMenuRefresh){this.refreshWidgetLaunchMenu()}},this);this.on("select",function(e,b,c,d){this.pnlGroupDetail.loadData(b);if(this.pnlGroupDetail.collapsed&&this.detailsAutoOpen){this.pnlGroupDetail.expand()}this.updateDeleteButton(e.selected)},this);this.on("deselect",function(e,b,c,d){this.updateDeleteButton(e.selected)},this);this.searchBox.on("searchChanged",function(b,c){this.gridGroups.applyFilter(c,["name","description","displayName"])},this);this.on("itemdblclick",function(d,c,g,e,b,f){this.doEdit(c.data.id,c.data.displayName)},this);this.gridGroups.getView().on("itemkeydown",function(d,c,f,e,b){switch(b.getKey()){case b.SPACE:case b.ENTER:this.doEdit(c.data.id,c.data.displayName)}},this);this.callParent(arguments);OWF.Eventing.subscribe("AdminChannel",owfdojo.hitch(this,function(b,d,c){if(d.domain==="Group"){this.gridGroups.getBottomToolbar().doRefresh()}}));this.on("afterrender",function(){var b=this.el.down(".x-collapse-el");b.on("click",function(){var c=this.el.down(".x-splitter-collapsed");if(c){this.detailsAutoOpen=true}else{this.detailsAutoOpen=false}},this)},this)},launchFailedHandler:function(a){if(a.error){this.showAlert("Launch Error","Group Editor Launch Failed: "+a.message)}},doEdit:function(c,b){var a=Ozone.util.toString({id:c,copyFlag:false});OWF.Launcher.launch({title:"$1 - "+b,titleRegex:/(.*)/,guid:this.guid_EditCopyWidget,launchOnlyIfClosed:false,data:a},this.launchFailedHandler)},doActivate:function(){var b=this.gridGroups.getSelectionModel().getSelection();if(b&&b.length>0){for(var c=0;c<b.length;c++){var d=b[c];if(d){d.set("status","active")}}var a=this.gridGroups.getStore();a.save();this.refreshWidgetLaunchMenu()}else{this.showAlert("Error","You must select at least one group to activate.")}},doDeactivate:function(){var b=this.gridGroups.getSelectionModel().getSelection();if(b&&b.length>0){for(var c=0;c<b.length;c++){var d=b[c];if(d){d.set("status","inactive")}}var a=this.gridGroups.getStore();a.save();this.refreshWidgetLaunchMenu()}else{this.showAlert("Error","You must select at least one group to deactivate.")}},doDelete:function(){var b=this.gridGroups.getSelectionModel().getSelection();if(b&&b.length>0){var a=false;for(var c=0;c<b.length;c++){if((b[c].get("name")=="OWF Users"||b[c].get("name")=="OWF Administrators")&&b[c].get("automatic")==true){a=true;break}}var e="This action will permanently delete the selected group(s).";if(a){var d=[];for(var c=0;c<b.length;c++){if((b[c].get("name")=="OWF Users"||b[c].get("name")=="OWF Administrators")&&b[c].get("automatic")==true){d.push(b[c].get("name"))}}if(d.length==1){e='You have chosen to delete <span class="heading-bold">'+b.length+' groups</span>.<br>However, the <span class="heading-bold">'+d[0]+"</span> group cannot be deleted.<br>Pressing OK will permanently delete your other selection(s)."}else{if(d.length==2){e='You have chosen to delete <span class="heading-bold">'+b.length+' groups</span>.<br>However, the <span class="heading-bold">'+d[0]+'</span> and <span class="heading-bold">'+d[1]+"</span> groups cannot be deleted.<br>Pressing OK will permanently delete your other selection(s)."}}for(var c=0;c<b.length;c++){if((b[c].get("name")=="OWF Users"||b[c].get("name")=="OWF Administrators")&&b[c].get("automatic")==true){b[c]=null}}b=Ext.Array.clean(b)}else{if(b.length==1){e='This action will permanently delete <span class="heading-bold">'+Ext.htmlEncode(b[0].data.name)+"</span>."}else{e='This action will permanently delete the selected <span class="heading-bold">'+b.length+" groups</span>."}}this.showConfirmation("Warning",e,function(h,j,i){if(h=="ok"){var f=this.gridGroups.getStore();f.remove(b);var g=f.getTotalCount()-b.length;f.on({write:{fn:function(m,k,o){if(f.data.items.length===0&&f.currentPage>1){var n=f.getPageFromRecordIndex(g-1);var l=(n>=f.currentPage)?f.currentPage:n;f.loadPage(l)}this.gridGroups.getBottomToolbar().doRefresh();this.refreshWidgetLaunchMenu()},single:true,scope:this}});f.save()}})}else{this.showAlert("Error","You must select at least one group to delete.")}},updateDeleteButton:function(a){var d=this.down("#btnDelete");if(a.length==1){if((a.get(0).get("name")=="OWF Users"||a.get(0).get("name")=="OWF Administrators")&&a.get(0).get("automatic")==true){d.disable()}else{d.enable()}}else{if(a.length==2){var b=0;for(var c=0;c<2;c++){if((a.get(c).get("name")=="OWF Users"||a.get(c).get("name")=="OWF Administrators")&&a.get(c).get("automatic")==true){b++}}if(b==2){d.disable()}else{d.enable()}}else{d.enable()}}}});