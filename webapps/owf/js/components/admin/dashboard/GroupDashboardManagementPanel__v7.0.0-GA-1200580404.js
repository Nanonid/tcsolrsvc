Ext.define("Ozone.components.admin.dashboard.GroupDashboardManagementPanel",{extend:"Ozone.components.admin.ManagementPanel",alias:["widget.groupdashboardmanagement","widget.groupdashboardmanagementpanel","widget.Ozone.components.admin.GroupDashboardManagementPanel"],layout:"fit",cls:"groupdashboardmanagementpanel",gridDashboards:null,pnlDashboardDetail:null,txtHeading:null,lastAction:null,guid_EditCopyWidget:null,widgetStateHandler:null,dragAndDrop:true,launchesWidgets:true,channel:"AdminChannel",defaultTitle:"Group Dashboards",minButtonWidth:80,detailsAutoOpen:true,initComponent:function(){var a=this;OWF.Preferences.getUserPreference({namespace:"owf.admin.DashboardEditCopy",name:"guid_to_launch",onSuccess:function(b){a.guid_EditCopyWidget=b.value},onFailure:function(b){a.showAlert("Preferences Error","Error looking up Dashboard Editor: "+b)}});this.gridDashboards=Ext.create("Ozone.components.admin.grid.DashboardGroupsGrid",{preventHeader:true,region:"center",border:false});this.gridDashboards.setBaseParams({adminEnabled:true,isGroupDashboard:true,isStackDashboard:false});this.gridDashboards.store.load({params:{offset:0,max:this.pageSize}});this.relayEvents(this.gridDashboards,["datachanged","select","deselect","itemdblclick"]);this.pnlDashboardDetail=Ext.create("Ozone.components.admin.dashboard.DashboardDetailPanel",{layout:{type:"fit",align:"stretch"},region:"east",preventHeader:true,collapseMode:"mini",collapsible:true,collapsed:true,split:true,border:false,width:266});this.txtHeading=Ext.create("Ext.toolbar.TextItem",{text:'<span class="heading-bold">'+this.defaultTitle+"</span>"});this.searchBox=Ext.widget("searchbox");this.items=[{xtype:"panel",layout:"border",border:false,items:[this.gridDashboards,this.pnlDashboardDetail]}];this.dockedItems=[{xtype:"toolbar",dock:"top",layout:{type:"hbox",align:"stretchmax"},items:[this.txtHeading,{xtype:"tbfill"},this.searchBox]},{xtype:"toolbar",dock:"bottom",ui:"footer",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"button",text:"Create",handler:function(c,b){b.stopPropagation();a.doCreate()}},{xtype:"button",text:"Edit",handler:function(){a.doEdit()}},{xtype:"button",text:"Delete",handler:function(b){a.doDelete()}}]}];this.gridDashboards.store.on("load",function(e,c,d){if((this.pnlDashboardDetail!=null)&&(!this.pnlDashboardDetail.collapsed)&&(this.pnlDashboardDetail.loadedRecord!=null)){for(var b=0;b<c.length;b++){if(c[b].id==this.pnlDashboardDetail.loadedRecord.id){this.pnlDashboardDetail.loadData(c[b]);break}}}},this);this.on("datachanged",function(b,c){if(this.pnlDashboardDetail!=null){this.pnlDashboardDetail.collapse();this.pnlDashboardDetail.removeData()}if(!this.disableLaunchMenuRefresh){this.refreshWidgetLaunchMenu()}},this);this.on("select",function(e,b,c,d){this.pnlDashboardDetail.loadData(b);if(this.pnlDashboardDetail.collapsed&&this.detailsAutoOpen){this.pnlDashboardDetail.expand()}},this);this.searchBox.on("searchChanged",function(b,d){var c=this.gridDashboards;if(c){if(!d){this.gridDashboards.clearFilters()}else{this.gridDashboards.applyFilter(d,["name","description"])}}},this);this.on({itemdblclick:{scope:this,fn:this.doEdit}});this.gridDashboards.getView().on({itemkeydown:{scope:this,fn:function(d,c,f,e,b){switch(b.getKey()){case b.SPACE:case b.ENTER:this.doEdit()}}}});this.callParent(arguments);OWF.Eventing.subscribe("AdminChannel",owfdojo.hitch(this,function(b,d,c){if(d.domain==="Dashboard"){this.gridDashboards.getBottomToolbar().doRefresh()}}));this.on("afterrender",function(){var b=this.el.down(".x-collapse-el");b.on("click",function(){var c=this.el.down(".x-splitter-collapsed");if(c){this.detailsAutoOpen=true}else{this.detailsAutoOpen=false}},this)},this)},onLaunchFailed:function(a){if(a.error){this.showAlert("Launch Error","Dashboard Editor Launch Failed: "+a.message)}},doCreate:function(){var a=Ozone.util.toString({copyFlag:false,isCreate:true,isGroupDashboard:true});OWF.Launcher.launch({guid:this.guid_EditCopyWidget,launchOnlyIfClosed:false,data:a},this.onLaunchFailed)},doEdit:function(){var a=this.gridDashboards.getSelectedDashboards();if(a&&a.length>0){for(var b=0;b<a.length;b++){var d=a[b].getId();var c=Ozone.util.toString({id:d,copyFlag:false,isCreate:false,isGroupDashboard:true});OWF.Launcher.launch({title:"$1 - "+a[b].get("name"),titleRegex:/(.*)/,guid:this.guid_EditCopyWidget,launchOnlyIfClosed:false,data:c},this.onLaunchFailed)}}else{this.showAlert("Error","You must select at least one dashboard to edit")}},doDelete:function(){var a=this.gridDashboards.getSelectionModel().getSelection();if(a&&a.length>0){var b="This action will permanently delete ";if(a.length==1){b+='<span class="heading-bold">'+Ext.htmlEncode(a[0].data.name)+"</span>."}else{b+='the selected <span class="heading-bold">'+a.length+" dashboards</span>."}this.showConfirmation("Warning",b,function(e,g,f){if(e=="ok"){var c=this.gridDashboards.getStore();c.remove(a);var d=c.getTotalCount()-a.length;c.on({write:{fn:function(){if(c.data.items.length==0&&c.currentPage>1){var i=c.getPageFromRecordIndex(d-1);var h=(i>=c.currentPage)?c.currentPage:i;c.loadPage(h)}this.gridDashboards.getBottomToolbar().doRefresh();this.pnlDashboardDetail.removeData();if(!this.pnlDashboardDetail.collapsed){this.pnlDashboardDetail.collapse()}this.refreshWidgetLaunchMenu()},scope:this,single:true}});c.save()}})}else{this.showAlert("Error","You must select at least one dashboard to delete")}}});