Ext.define("Ozone.components.admin.user.UserEditDashboardsTab",{extend:"Ozone.components.admin.DashboardsTabPanel",alias:["widget.usereditdashboards","widget.usereditdashboardstab","widget.Ozone.components.admin.user.UserEditDashboardsTab"],cls:"usereditdashboardstab",editor:"User",initComponent:function(){Ext.apply(this,{layout:"fit",itemId:"tabDashboards",title:"Dashboards",iconCls:"dashboard-tab",componentId:"user_id",storeCfg:{api:{read:"/dashboard",create:"/dashboard",update:"/dashboard",destroy:"/dashboard"},methods:{read:"GET",load:"GET",create:"PUT",update:"PUT",save:"POST",destroy:"DELETE"},updateActions:{destroy:"remove",create:"add"}}});this.callParent(arguments);this.addDocked({xtype:"toolbar",itemId:"tbDashboardsGridFtr",dock:"bottom",ui:"footer",defaults:{minWidth:80},items:[{xtype:"button",text:"Create",itemId:"btnCreate",handler:function(b,a){a.stopPropagation();this.doCreate()},scope:this},{xtype:"splitbutton",text:"Edit",handler:function(){this.doEdit()},scope:this,menuAlign:"bl-tl?",menu:{xtype:"menu",plain:true,defaults:{minWidth:80},items:[{xtype:"owfmenuitem",text:"Copy To Group",handler:function(){this.doCopy()},scope:this}]}},{xtype:"button",text:"Delete",itemId:"btnDelete",handler:function(){this.doDelete()},scope:this}]})},doCreate:function(d,f){var c=this.getComponent("dashboardsgrid");var a=this.ownerCt;var b=a.recordId?a.recordId:-1;Ext.create("Ozone.components.admin.EditDashboardWindow",{title:"Dashboard Editor",width:Ext.getBody().getViewSize().width*0.9,height:Ext.getBody().getViewSize().height*0.9,scope:this,callback:function(h,i){if(h!=undefined){var j=Ext.decode(h.definition);if(j){j.guid=guid.util.guid();if(h.name){j.name=h.name}if(h.description){j.description=h.description}}var g=Ext.StoreMgr.lookup({type:"admindashboardstore"});g.proxy.extraParams.user_id=b;g.add(j);var e=g.data.items[0];e.phantom=true;g.on({write:{fn:function(n,o,k,m,l){if(c&&c.store){OWF.Eventing.publish(this.ownerCt.channel,{action:o,domain:this.ownerCt.domain,records:k});c.store.load()}},scope:this}});if(g.proxy){g.proxy.on({exception:{fn:this.onStoreException,scope:this}})}g.sync()}}}).show()},doEdit:function(i,d,k,g,h){var a=this.getComponent("dashboardsgrid");var b=a.getSelectedDashboards();var f=this.ownerCt.recordId;if(b&&b.length>0){var d=b[0];var c=d?d.data:d;var j=null;if(c){j=owfdojo.toJson(c,true)}Ext.create("Ozone.components.admin.EditDashboardWindow",{title:"Dashboard Editor - "+c.name?Ext.htmlEncode(c.name):"",guid:c.guid?c.guid:"",name:c.name?c.name:"",description:c.description?c.description:"",definition:j?j:"",width:Ext.getBody().getViewSize().width*0.9,height:Ext.getBody().getViewSize().height*0.9,scope:this,callback:function(m,n){if(m!=undefined){var o=Ext.decode(m.definition);if(o){if(m.guid){o.guid=m.guid}if(m.name){o.name=m.name}if(m.description){o.description=m.description}}var l=Ext.StoreMgr.lookup({type:"admindashboardstore"});l.proxy.extraParams.user_id=f;l.add(o);var e=l.data.items[0];e.phantom=true;l.on({write:{fn:function(q,p,r){if(a&&a.store){a.store.load()}},scope:this}});if(l.proxy){l.proxy.on({exception:{fn:this.onStoreException,scope:this}})}l.sync()}}}).show()}else{this.editPanel.showAlert("Error","You must select at least one dashboard to edit.")}},doCopy:function(d,g){var c=this.getComponent("dashboardsgrid");var a=c.getSelectedDashboards();if(a&&a.length>0){var f=[];for(var b=0;b<a.length;b++){f.push(Ozone.util.cloneDashboard(a[b].data,false,true))}this.openCopyWindow(f)}else{this.editPanel.showAlert("Error","You must select at least one dashboard to copy.")}},openCopyWindow:function(c){var a=this;var d="Select one or more groups and click 'OK':";if(a.editor){d="To copy the selected dashboards, select one or more groups and click 'OK':"}var b=Ext.widget("admineditoraddwindow",{addType:"Group",itemName:c.length===1?c[0].name:"Dashboards",editor:this.editor,focusOnClose:this.down(),instructions:d,searchFields:["name","description"],grid:Ext.widget("groupsgrid",{itemId:"groupsaddgrid",preventHeader:true,border:false,enableColumnHide:false,sortableColumns:false}),okFn:function(){var h=b.down("#groupsaddgrid");if(h){var e=h.getSelectionModel().getSelection();if(e&&e.length>0){var f=[];for(var g=0;g<e.length;g++){f.push(e[g].data)}Ozone.util.Transport.send({url:Ozone.util.contextPath()+"/group/copyDashboard",method:"POST",onSuccess:Ext.bind(function(j){var i=this.down("#dashboardsgrid");if(i){i.refresh()}},this),onFailure:function(i){a.editPanel.showAlert("Error","Error while copying dashboard(s): "+i)},autoSendVersion:false,content:{isGroupDashboard:true,groups:Ext.encode(f),dashboards:Ext.encode(c)}})}}}});b.show()},doDelete:function(c,f){var b=this.getComponent("dashboardsgrid"),a=b.getStore();records=b.getSelectedDashboards();if(records&&records.length>0){var g="This action will permanently delete the selected dashboard(s)";if(records.length==1){g='This action will permanently delete <span class="heading-bold">'+Ext.htmlEncode(records[0].data.name)+"</span>."}else{g='This action will permanently delete the selected <span class="heading-bold">'+records.length+" dashboards</span>."}var d=function(e,i,h){if(e=="ok"){a.remove(records);a.save()}};this.editPanel.showConfirmation("Warning",g,d)}else{this.editPanel.showAlert("Error","You must select at least one dashboard to delete.")}}});