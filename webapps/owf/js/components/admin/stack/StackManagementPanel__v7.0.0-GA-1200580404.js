Ext.define("Ozone.components.admin.stack.StackManagementPanel",{extend:"Ozone.components.admin.ManagementPanel",alias:["widget.stackmanagement"],layout:"fit",gridStacks:null,pnlStackDetail:null,txtHeading:null,lastAction:null,guid_EditCopyWidget:null,widgetStateHandler:null,dragAndDrop:true,launchesWidgets:true,channel:"AdminChannel",defaultTitle:"Stacks",minButtonWidth:80,detailsAutoOpen:true,initComponent:function(){var a=this;OWF.Preferences.getUserPreference({namespace:"owf.admin.StackEditCopy",name:"guid_to_launch",onSuccess:function(b){a.guid_EditCopyWidget=b.value},onFailure:function(b){a.showAlert("Preferences Error","Error looking up Stack Editor: "+b)}});this.gridStacks=Ext.create("Ozone.components.admin.StacksGrid",{preventHeader:true,region:"center",border:false});this.gridStacks.store.proxy.extraParams={adminEnabled:true};this.gridStacks.store.load({params:{offset:0,max:this.pageSize}});this.relayEvents(this.gridStacks,["datachanged","select","deselect","itemdblclick"]);this.pnlStackDetail=Ext.create("Ozone.components.admin.stack.StackDetailPanel",{layout:{type:"fit",align:"stretch"},region:"east",preventHeader:true,collapseMode:"mini",collapsible:true,collapsed:true,split:true,border:false,width:200});this.txtHeading=Ext.create("Ext.toolbar.TextItem",{text:'<span class="heading-bold">'+this.defaultTitle+"</span>"});this.searchBox=Ext.widget("searchbox");this.items=[{xtype:"panel",layout:"border",border:false,items:[this.gridStacks,this.pnlStackDetail]}];this.dockedItems=[{xtype:"toolbar",dock:"top",layout:{type:"hbox",align:"stretchmax"},items:[this.txtHeading,{xtype:"tbfill"},this.searchBox]},{xtype:"toolbar",dock:"bottom",ui:"footer",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"button",text:"Create",handler:function(c,b){b.stopPropagation();a.doCreate()}},{xtype:"splitbutton",text:"Edit",itemId:"btnEdit",handler:function(){var b=a.gridStacks.getSelectionModel().getSelection();if(b&&b.length>0){for(var c=0;c<b.length;c++){a.doEdit(b[c].data.id,b[c].data.name)}}else{a.showAlert("Error","You must select at least one stack to edit.")}},menu:{xtype:"menu",plain:true,hideMode:"display",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"owfmenuitem",text:"Export",handler:function(c){var b=a.gridStacks.getSelectionModel().getSelection();if(b&&b.length===1){a.doExport("stack",b[0])}else{if(b&&b.length>1){a.showAlert("Error","You must select only one stack to export.")}else{a.showAlert("Error","You must select a stack to export.")}}}}]}},{xtype:"button",text:"Delete",itemId:"btnDelete",handler:function(b){a.doDelete()}}]}];this.on("datachanged",function(b,c){if(this.pnlStackDetail!=null){this.pnlStackDetail.collapse();this.pnlStackDetail.removeData()}if(!this.disableLaunchMenuRefresh){this.refreshWidgetLaunchMenu()}},this);this.on("select",function(e,b,c,d){this.pnlStackDetail.loadData(b);if(this.pnlStackDetail.collapsed&&this.detailsAutoOpen){this.pnlStackDetail.expand()}},this);this.searchBox.on("searchChanged",function(b,c){this.gridStacks.applyFilter(c,["name","description","stackContext"])},this);this.on("itemdblclick",function(d,c,g,e,b,f){this.doEdit(c.data.id,c.data.name)},this);this.gridStacks.getView().on("itemkeydown",function(d,c,f,e,b){switch(b.getKey()){case b.SPACE:case b.ENTER:this.doEdit(c.data.id,c.data.name)}},this);this.callParent(arguments);OWF.Eventing.subscribe("AdminChannel",owfdojo.hitch(this,function(b,d,c){if(d.domain==="Stack"){this.gridStacks.getBottomToolbar().doRefresh()}}));this.on("afterrender",function(){var b=this.el.down(".x-collapse-el");b.on("click",function(){var c=this.el.down(".x-splitter-collapsed");if(c){this.detailsAutoOpen=true}else{this.detailsAutoOpen=false}},this)},this)},launchFailedHandler:function(a){if(a.error){this.showAlert("Launch Error","Stack Editor Launch Failed: "+a.message)}},doEdit:function(c,b){var a=Ozone.util.toString({id:c,copyFlag:false});OWF.Launcher.launch({title:"$1 - "+b,titleRegex:/(.*)/,guid:this.guid_EditCopyWidget,launchOnlyIfClosed:false,data:a},this.launchFailedHandler)},doDelete:function(){var a=this.gridStacks.getSelectionModel().getSelection();if(a&&a.length>0){var b="This action will permanently delete ";if(a.length===1){b+='<span class="heading-bold">'+Ext.htmlEncode(a[0].data.name)+"</span>."}else{b+='the selected <span class="heading-bold">'+a.length+" stacks</span>."}this.showConfirmation("Warning",b,function(e,g,f){if(e=="ok"){var c=this.gridStacks.getStore();c.remove(a);var d=c.getTotalCount()-a.length;c.on({write:{fn:function(){if(c.data.items.length==0&&c.currentPage>1){var i=c.getPageFromRecordIndex(d-1);var h=(i>=c.currentPage)?c.currentPage:i;c.loadPage(h)}this.gridStacks.getBottomToolbar().doRefresh();this.pnlStackDetail.removeData();if(!this.pnlDashboardDetail.collapsed){this.pnlDashboardDetail.collapse()}this.refreshWidgetLaunchMenu()},scope:this,single:true}});c.save()}})}else{this.showAlert("Error","You must select at least one stack to delete.")}}});