Ext.define("Ozone.components.admin.group.StackEditPropertiesTab",{extend:"Ozone.components.PropertiesPanel",alias:["widget.stackeditproperties","widget.stackeditpropertiestab","widget.Ozone.components.admin.stack.StackEditPropertiesTab"],cls:"stackeditpropertiestab",initComponent:function(){var a=this;Ext.applyIf(this,{layout:"fit",title:"Properties",iconCls:"properties-tab",defaults:{labelWidth:140},items:[{xtype:"component",itemId:"descriptorUrlInfo",name:"descriptorUrlInfo",cls:"descriptorUrlInfo",renderTpl:'<div class="descriptorUrlHeader"><div class="descriptorUrlTitle">{descriptorUrlTitle}</div><button class="descriptorUrlInfoIcon" ></button></div>',renderData:{descriptorUrlTitle:"Import Stack from Descriptor URL"},renderSelectors:{iconEl:".descriptorUrlInfoIcon",titleEl:".descriptorUrlTitle"},listeners:{afterrender:function(b){b.iconEl.on("click",function(){var c=b.ownerCt.getComponent("descriptorUrlInfoMsg");if(c.isVisible()){c.hide()}else{c.show()}},this);Ozone.components.focusable.Focusable.setupFocus(b.iconEl,this);new Ext.util.KeyMap(b.iconEl,{key:[Ext.EventObject.ENTER],fn:function(d,c){c.stopEvent();var e=this.ownerCt.getComponent("descriptorUrlInfoMsg");if(e.isVisible()){e.hide()}else{e.show()}},scope:b})}}},{xtype:"component",itemId:"descriptorUrlInfoMsg",name:"descriptorUrlInfoMsg",cls:"descriptorUrlInfoMsg",hidden:true,html:"Enter the URL of a Stack Descriptor and click the Load button. Stack data, including dashboard and widget definitions, is automatically retrieved from a Web-accessible location. To create the stack in OWF, click Apply."},{xtype:"urlfield",itemId:"descriptorUrl",name:"descriptorUrl",cls:"descriptorUrlField",allowBlank:true,maxLength:2083,enableKeyEvents:true,preventMark:true,emptyText:"https://mycompany.com/stack/descriptor.html",usePlaceholderIfAvailable:false,value:"",rawValue:"",anchor:"100%",listeners:{change:{fn:this.handleDescriptorUrlChange,scope:this},specialkey:{fn:function(c,b){if(b.getKey()==b.ENTER){this.loadDescriptor(this)}},scope:this}}},{xtype:"toolbar",dock:"bottom",itemId:"descriptorUrlToolbar",name:"descriptorUrlToolbar",cls:"descriptorUrlToolbar",ui:"footer",defaults:{minWidth:75},items:[{text:"<u>Don't have a stack descriptor?</u>",itemId:"manualEntryLinkBtn",cls:"manualEntryLinkBtn",handler:function(b){var c=this.getComponent("descriptorUrl");c.setValue("");this.showProperties(true);this.getComponent("descriptorUrlErrorMsg").hide()},scope:this},"->",{text:"Load",itemId:"descriptorUrlBtn",name:"descriptorUrlBtn",cls:"descriptorUrlBtn",margin:0,disabled:true,handler:function(b){var c=b.getText();if(c=="Load"){this.loadDescriptor(this)}else{var e=this.getComponent("descriptorUrlLoading");var d=this.getComponent("descriptorUrl");if(this.xhr){this.xhr.cancel()}e.hide();d.enable();b.setText("Load")}},scope:this}]},{xtype:"component",itemId:"descriptorUrlLoading",name:"descriptorUrlLoading",cls:"descriptorUrlLoading",hidden:true,html:'<img src="../themes/common/images/shared/large-loading.gif" /><br />Loading...'},{xtype:"component",itemId:"descriptorUrlErrorMsg",name:"descriptorUrlErrorMsg",cls:"descriptorUrlErrorMsg",hidden:true,html:"Unable to retrieve stack information. Please check your descriptor and try again."},{xtype:"component",name:"horizontalRule",itemId:"horizontalRule",cls:"horizontalRule",hidden:true,html:"<hr>"},{xtype:"component",itemId:"manualEntryTitle",name:"manualEntryTitle",cls:"manualEntryTitle",hidden:true,html:"Enter Stack Description"},{xtype:"textfield",name:"name",itemId:"name",fieldLabel:Ozone.util.createRequiredLabel("Title"),hidden:true,allowBlank:false,maxLength:256},{xtype:"textfield",name:"stackContext",itemId:"stackContext",fieldLabel:Ozone.util.createRequiredLabel("URL Name"),hidden:true,allowBlank:false,maxLength:200,regex:/^[a-zA-Z\d\-\_]+$/,regexText:"Invalid characters! The URL Name may only contain letters, numbers, dashes, and underscores.",listeners:{blur:{fn:a.handleBlur},change:{fn:function(b){a.handleChange(b);a.down("#stackUrl").setValue(Ext.htmlEncode(OWF.getContainerUrl()+"/#stack="+this.getValue()))}}}},{xtype:"displayfield",name:"stackUrl",itemId:"stackUrl",fieldLabel:"Stack URL",hidden:true,value:OWF.getContainerUrl()+"/",disabled:true},{xtype:"textarea",name:"description",itemId:"description",fieldLabel:"Description",hidden:true,height:100,allowBlank:true,maxLength:4000}]});this.callParent(arguments);this.on("afterrender",function(){var c=this.getDockedItems('toolbar[dock="bottom"]');var b=c[0].getComponent("apply");b.disable();if(this.ownerCt.launchData&&this.ownerCt.launchData.id){this.showProperties(true)}},this,{single:true})},initFieldValues:function(a){var f=a?a.data:a;this.record=f;if(f){var c=this.getComponent("name"),d=this.getComponent("description"),e=this.getComponent("stackContext"),b=this.getComponent("descriptorUrl");c.setValue(f.name).originalValue=f.name;d.setValue(f.description).originalValue=f.description;e.setValue(f.stackContext).originalValue=f.stackContext;if(!b.getValue()){b.setValue(f.descriptorUrl).originalValue=f.descriptorUrl}this.getComponent("descriptorUrlInfo").titleEl.dom.innerHTML="Update Stack from Descriptor URL";this.getComponent("descriptorUrlInfoMsg").update("Click Load to update the stack. If the stack descriptor file changed since it was added to your instance of OWF, clicking Load will retrieve the latest stack data. To upload it to your OWF, click Apply.");if(f.descriptorUrl&&this.getComponent("descriptorUrlErrorMsg").isHidden()){this.loadedFromDescriptor=true}this.getForm().isValid()}},loadDescriptor:function(a){var e=a.getComponent("descriptorUrl"),g=a.getComponent("descriptorUrlLoading"),f=Ext.String.trim(e.getValue()),c=a.getComponent("descriptorUrlToolbar").getComponent("descriptorUrlBtn"),b=this.getDockedItems('toolbar[dock="bottom"]')[0].getComponent("apply"),d=descriptorUrlToolbar.getComponent("manualEntryLinkBtn");a.getComponent("descriptorUrlErrorMsg").hide();e.disable();a.showProperties(false);g.show();a.xhr=Ozone.util.Transport.send({url:f,method:"GET",forceXdomain:true,onSuccess:Ext.bind(a.updatePropertiesFromDescriptor,a),onFailure:function(h){if(a.record){a.showProperties(true)}else{d.show()}g.hide();e.enable();c.setText("Load");a.getComponent("descriptorUrlErrorMsg").show()},autoSendVersion:false});c.setText("Cancel");b.disable()},updatePropertiesFromDescriptor:function(d){this.loadedFromDescriptor=true;this.showProperties(true);var g=this;var c=this.getComponent("descriptorUrlLoading");c.hide();var b=this.getComponent("descriptorUrlToolbar").getComponent("descriptorUrlBtn");b.setText("Load");var i=g.getComponent("descriptorUrl");i.enable();this.loadedDecriptorUrl=i.getValue();this.descriptorData=d;if(d){var e="";var a=g.getComponent("name"),h=g.getComponent("description"),f=g.getComponent("stackContext");a.setValue(Ext.String.trim(d.name));h.setValue(Ext.String.trim(d.description||""));f.setValue(Ext.String.trim(d.stackContext));var j=this.getDockedItems('toolbar[dock="bottom"]');var k=j[0].getComponent("apply");k.enable()}this.getForm().isValid()},showProperties:function(i){var c=this.getComponent("descriptorUrlToolbar");var a=c.getComponent("manualEntryLinkBtn");a.hide();var h=this;var d=h.getComponent("horizontalRule"),e=h.getComponent("manualEntryTitle"),b=h.getComponent("name"),g=h.getComponent("stackContext"),j=h.getComponent("description"),f=h.getComponent("stackUrl");if(i){var k=this.getDockedItems('toolbar[dock="bottom"]');var l=k[0].getComponent("apply");l.enable();d.show();e.show();b.show();g.show();j.show();f.show()}else{d.hide();e.hide();b.hide();g.hide();j.hide();f.hide()}},handleDescriptorUrlChange:function(f,e,a,b){var d=this,c=this.getForm();descriptorUrlToolbar=this.getComponent("descriptorUrlToolbar");descriptorUrlBtn=descriptorUrlToolbar.getComponent("descriptorUrlBtn");if(!f.changed&&f.isDirty()){f.changed=true}if(f.isValid()&&f.getValue()){descriptorUrlBtn.enable()}else{descriptorUrlBtn.disable()}},onApply:function(){var g=this;this.validateFields();if(!this.getForm().hasInvalidField()){if(this.loadedFromDescriptor&&!this.record){var h=g.descriptorData.dashboards;var a=true;for(var d in h){var e=h[d];if(!Ozone.util.validateDashboardJSON(e)){a=false}}var b=g.getComponent("name"),j=g.getComponent("description"),f=g.getComponent("stackContext");g.descriptorData.name=b.getValue();g.descriptorData.description=j.getValue();g.descriptorData.stackContext=f.getValue();var c=g.ownerCt;if(a){Ozone.util.Transport.send({url:Ozone.util.contextPath()+"/stack/import",method:"POST",onSuccess:Ext.bind(function(i){g.showApplyAlert("Your changes have been saved.");c.store.load({callback:function(l,k,m){c.record=c.store.getById(i.id);c.recordId=c.record.get("id");g.initFieldValues(c.record);c.enableTabs();OWF.Eventing.publish(c.channel,{action:"created",domain:c.domain,records:c.record})}})},g),onFailure:function(i){g.editPanel.showAlert("Server Error!",Ext.JSON.decode(i).errorMsg)},content:{data:Ext.encode(g.descriptorData),descriptorUrl:g.loadedDecriptorUrl}})}else{g.editPanel.showAlert("Error","Error while creating stack: invalid dashboard json.")}}else{this.callParent()}}else{this.showApplyAlert("Invalid field, changes cannot be saved.",3000)}}});