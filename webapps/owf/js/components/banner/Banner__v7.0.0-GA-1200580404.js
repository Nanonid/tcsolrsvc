Ext.define("Ozone.components.banner.Banner",{extend:"Ext.toolbar.Toolbar",alias:["widget.owfbanner","widget.Ozone.components.banner.Banner"],itemId:"banner",cls:"banner",mixins:{focus:"Ozone.components.focusable.CircularFocus"},plugins:[new Ozone.components.focusable.Focusable(),new Ozone.plugins.Banner()],state:"docked",dashboardContainer:null,toolbarButtons:null,noItemsToShow:2,collapseDelay:5000,marketplaceButtonIndex:3,hasMarketplaceButton:false,hasMetricButton:false,openLaunchMenu:function(){if(this.dashboardContainer.activeDashboard.configRecord.get("locked")===true){return}if(this.launchMenu.isVisible()){this.launchMenu.close()}else{this.launchMenu.show();this.launchMenu.refresh()}},disableLaunchMenu:function(){if(this.launchMenu.isVisible()){this.launchMenu.close()}this.getComponent("launchMenuBtn").disable();if(this.popOutToolbar){this.popOutToolbar.getComponent("launchMenuBtn").disable()}},enableLaunchMenu:function(){this.getComponent("launchMenuBtn").enable();if(this.popOutToolbar){this.popOutToolbar.getComponent("launchMenuBtn").enable()}},openSettingsWindow:function(){if(!this.settingsWindow||this.settingsWindow.isDestroyed){this.settingsWindow=Ext.widget("settingswindow",{dashboardContainer:this.dashboardContainer})}if(this.settingsWindow.isVisible()){this.settingsWindow.close()}else{this.settingsWindow.show()}},openAdministrationWindow:function(){if(!this.administrationWindow||this.administrationWindow.isDestroyed){this.administrationWindow=Ext.widget("admintoolswindow",{dashboardContainer:this.dashboardContainer})}if(this.administrationWindow.isVisible()){this.administrationWindow.hide()}else{this.administrationWindow.show()}},openMarketplaceWindow:function(){if(this.hasMarketplaceButton){if(!this.mpWindow){this.mpWindow=Ext.widget("marketplace")}if(this.mpWindow.isVisible()){this.mpWindow.close()}else{this.mpWindow.show()}}else{Ozone.components.keys.KeyMap.reset()}},openMarketplaceModalWindow:function(b,c){if(this.hasMarketplaceButton){if(this.marketplaceWidget){var a=("keyup"==c.type)?true:false;c.stopEvent();this.dashboardContainer.launchWidgets(this.marketplaceWidget,a)}else{if(!this.mpModalWindow||this.mpModalWindow.isDestroyed){this.mpModalWindow=Ext.widget("marketplacewindow",{dashboardContainer:this.dashboardContainer})}if(this.mpModalWindow.isVisible()){this.mpModalWindow.close()}else{this.mpModalWindow.show()}}}else{Ozone.components.keys.KeyMap.reset()}},openMetricWindow:function(){if(this.hasMetricButton){if(!this.metricWindow||this.metricWindow.isDestroyed){this.metricWindow=Ext.widget("metricwindow",{dashboardContainer:this.dashboardContainer})}if(this.metricWindow.isVisible()){this.metricWindow.close()}else{this.metricWindow.show()}}else{Ozone.components.keys.KeyMap.reset()}},openHelpWindow:function(){if(!this.helpWindow||this.helpWindow.isDestroyed){this.helpWindow=Ext.widget("helpwindow",{constrainHeader:true,dashboardContainer:this.dashboardContainer})}if(this.helpWindow.isVisible()){this.helpWindow.close()}else{this.helpWindow.show()}},addKeyBindings:function(){Ozone.KeyMap.addBinding([Ext.apply(Ozone.components.keys.HotKeys.LAUNCH_MENU,{scope:this,fn:this.openLaunchMenu}),Ext.apply(Ozone.components.keys.HotKeys.SETTINGS,{scope:this,fn:this.openSettingsWindow}),Ext.apply(Ozone.components.keys.HotKeys.DASHBOARD_SWITCHER,{scope:this.dashboardContainer,fn:this.dashboardContainer.showDashboardSwitcher}),Ext.apply(Ozone.components.keys.HotKeys.MARKETPLACE,{scope:this,fn:this.openMarketplaceModalWindow}),Ext.apply(Ozone.components.keys.HotKeys.METRIC,{scope:this,fn:this.openMetricWindow}),Ext.apply(Ozone.components.keys.HotKeys.HELP,{scope:this,fn:this.openHelpWindow})]);if(this.user.isAdmin){Ozone.KeyMap.addBinding(Ext.apply(Ozone.components.keys.HotKeys.ADMINISTRATION,{scope:this,fn:this.openAdministrationWindow}))}},initComponent:function(){var b=this;b.addKeyBindings();b.addEvents({docked:true,undocked:true});b.launchMenu=Ext.widget("launchMenu",{id:"widget-launcher",dashboardContainer:b.dashboardContainer,hidden:true,listeners:{hide:{fn:function(){this.down("#launchMenuBtn").toggle(false,true)},scope:b},show:{fn:function(){this.down("#launchMenuBtn").toggle(true,true)},scope:b}}});b.items=[];b.items.push({xtype:"button",id:"launchMenuBtn",itemId:"launchMenuBtn",scale:"launchmenu-banner-large",iconAlign:"top",text:null,tooltip:{title:Ozone.layout.tooltipString.addWidgetsTitle,text:Ozone.layout.tooltipString.addWidgetsContent,width:500,maxWidth:500},cls:"bannerBtn launchMenuBtn",iconCls:"launchMenuBtnIcon",enableToggle:true,clickCount:0,handler:this.openLaunchMenu,scope:this},"-");b.items.push([{xtype:"button",id:"dashMenuBtn",text:null,tooltip:{title:Ozone.layout.tooltipString.dashboardSwitcherTitle,text:Ozone.layout.tooltipString.dashboardSwitcherContent,width:500,maxWidth:500},cls:"bannerBtn dashMenuBtn",iconCls:"dashMenuBtnIcon",iconAlign:"top",scale:"banner-large",enableToggle:true,scope:this.dashboardContainer,handler:this.dashboardContainer.showDashboardSwitcher},"-",{xtype:"button",itemId:"settingsBtn",cls:"bannerBtn  settingsBtn",iconCls:"settingsBtnIcon",scale:"banner-large",iconAlign:"top",text:null,tooltip:{title:Ozone.layout.tooltipString.settingsTitle,text:Ozone.layout.tooltipString.settingsContent,width:500,maxWidth:500},enableToggle:true,scope:this,toggleHandler:this.openSettingsWindow}]);if(this.user.isAdmin){b.items.push(["-",{xtype:"button",itemId:"adminBtn",cls:"bannerBtn  adminBtn",iconCls:"adminBtnIcon",scale:"banner-large",iconAlign:"top",text:null,tooltip:{title:Ozone.layout.tooltipString.adminToolsTitle,text:Ozone.layout.tooltipString.adminToolsContent,width:500,maxWidth:500},enableToggle:true,scope:this,toggleHandler:this.openAdministrationWindow}])}b.items.push(["-",{xtype:"button",itemId:"helpBtn",cls:"bannerBtn  helpBtn",iconCls:"helpBtnIcon",scale:"banner-large",iconAlign:"top",text:null,tooltip:{title:Ozone.layout.tooltipString.helpTitle,text:Ozone.layout.tooltipString.helpContent,width:500,maxWidth:500},handler:this.openHelpWindow,scope:this},"-",{xtype:"button",id:"popOutBannerBtn",cls:"popOutBannerBtn ",iconCls:"popOutBannerBtnIcon",iconAlign:"top",scale:"banner-large",width:10,text:null,tooltip:{title:Ozone.layout.tooltipString.bannerUndockTitle,text:Ozone.layout.tooltipString.bannerUndockContent,width:280,maxWidth:280},handler:this.popOutDockedBanner,scope:this},{xtype:"component",itemId:"logoImg",flex:1,cls:"logo-img"},{xtype:"usermenubutton",id:"userMenuBtn",user:this.user,dashboardContainer:this.dashboardContainer}]);function a(){var c=this.items.get(0).getFocusEl(),e=this.getComponent("userMenuBtn"),d=this.getComponent("userMenuBtn").getClickables().last();function f(){e.showUserMenu()}this.setupFocus(c,d,undefined,f)}b.on("afterrender",function(c){a.call(c);Ozone.components.focusable.Focusable.clearOutline(this.getEl())});b.callParent(arguments);this.on({render:{fn:function(){if(Ozone.config.banner.state==="mini"){b.popOutDockedBanner(false,Ozone.config.banner.position)}else{if(Ozone.config.banner.state==="collapsed"){b.popOutDockedBanner(true,Ozone.config.banner.position)}}},scope:this}})},getBanner:function(){if(this.popOutToolbar&&this.popOutToolbar.isVisible()){return this.popOutToolbar}else{return this}},getPopOutBanner:function(){var b=this,c=[],a=this.getComponent("launchMenuBtn");if(b.popOutToolbar){return b.popOutToolbar}c.push({id:"gripper",xtype:"component"},{id:"popout_logo",xtype:"component"});c.push(a.cloneConfig({id:"popWidgetButton",clickCount:a.clickCount,disabled:this.getComponent("launchMenuBtn").disabled}),"-",this.getComponent("dashMenuBtn").cloneConfig(),"-");if(this.hasMarketplaceButton){c.push(this.getComponent("marketBtn").cloneConfig(),"-")}if(this.hasMetricButton){c.push(this.getComponent("metricBtn").cloneConfig(),"-")}c.push(this.getComponent("settingsBtn").cloneConfig(),"-");if(this.user.isAdmin){c.push(this.getComponent("adminBtn").cloneConfig(),"-")}c.push(this.getComponent("helpBtn").cloneConfig(),"-",{xtype:"button",id:"popInBannerBtn",cls:"popInBannerBtn",iconCls:"popInBannerBtnIcon",iconAlign:"top",scale:"banner-large",width:10,text:null,tooltip:{title:Ozone.layout.tooltipString.bannerDockTitle,text:Ozone.layout.tooltipString.bannerDockContent,width:200,maxWidth:200},handler:this.dockPopOutBanner,scope:this});b.popOutToolbar=Ext.create("Ext.toolbar.Toolbar",{id:"popOutBanner",cls:"banner",constrain:true,ownerCt:b.dashboardContainer,floating:true,draggable:true,state:"full",plugins:[new Ozone.components.keys.KeyMoveable(),new Ozone.components.focusable.Focusable()],bindMovementKeys:function(){var i=this,h={},g=Ozone.components.keys.MoveHotKeys,e,f;function d(j,k){return Ext.copyTo({handler:function(m,l){l.stopPropagation();k()},scope:i},j,Ext.Array.difference(Ext.Object.getKeys(j),["fn","handler","scope"]))}h.MOVE_UP=d(g.MOVE_UP,Ext.bind(i.moveUp,i));h.MOVE_DOWN=d(g.MOVE_DOWN,Ext.bind(function(){this.moveDown(Ext.getCmp("mainPanel").getHeight())},i));h.MOVE_LEFT=d(g.MOVE_LEFT,Ext.bind(i.moveLeft,i));h.MOVE_RIGHT=d(g.MOVE_RIGHT,Ext.bind(function(){this.moveRight(Ext.getCmp("mainPanel").getWidth())},i));e=Ext.Object.getValues(h);e.push({key:[Ext.EventObject.LEFT,Ext.EventObject.RIGHT],handler:function(k,j){if(!j.ctrlKey){var m=j.getKey()===j.LEFT?"previousSibling":"nextSibling",n=this.getChildByElement(document.activeElement),l=n?n[m](".button"):null;if(l){l.focus()}}},scope:this});f=new Ext.util.KeyMap(this.getFocusEl(),e);this.on("destroy",function(){this.destroy()},f);this.on("show",function(){Ext.FocusManager.unsubscribe(this)},this)},items:[c]});b.popOutToolbar.on("move",function(){this.saveState()},b,{buffer:500});b.popOutToolbar.on("afterrender",function(g){var d=g.items.items,e=d[d.length-1].getEl(),f=e.getOffsetsTo(g.getEl())[0]+e.getWidth();g.originalWidth=f+5;g.originalHeight=g.getHeight();g.setWidth(g.originalWidth);g.setHeight(g.originalHeight);g.getEl().on("mouseout",b.startCollapseTimer,b);g.getEl().on("blur",b.startCollapseTimer,b);g.getEl().on("mouseover",b.clearCollapseTimer,b);g.getEl().on("focus",function(){b.clearCollapseTimer();b.expandBanner()},b);Ozone.components.focusable.Focusable.clearOutline(g.getFocusEl());g.bindMovementKeys();g.items.firstFocusable=function(){return this.findBy(function(h){return(h.getFocusEl&&h.getFocusEl().focusable())})};Ext.apply(g,new Ozone.components.focusable.CircularFocus());g.setupFocus(g.items.firstFocusable().getFocusEl(),g.items.last().getFocusEl());if(Ext.isIE){Ext.defer(function(){this.getEl().select(".x-toolbar-separator, #gripper, #popout_logo").each(function(h){h.dom.tabIndex=-1})},100,g)}},null,{single:true});b.popOutToolbar.on("show",function(){b.dashboardContainer.bannerManager.register(b.popOutToolbar);b.dashboardContainer.bannerManager.bringToFront(b.popOutToolbar);if(this.height<this.originalHeight){this.setHeight(this.originalHeight)}});return b.popOutToolbar},popOutDockedBanner:function(d,a){var c=this,b=c.getPopOutBanner();c.hide();if(b.rendered){b.setHeight(b.originalHeight)}c.state="mini";b.show();c.fireEvent(OWF.Events.Banner.UNDOCKED);if(a&&a.length==2){b.setPosition(a[0],a[1])}d===true?c.collapseMiniBanner(0):c.startCollapseTimer();c.resizePopOutBanner();if(this.popOutToolbar.width<50){c.resizePopOutBanner()}this.saveState()},dockPopOutBanner:function(){var a=this;a.state="docked";a.fireEvent(OWF.Events.Banner.DOCKED);a.clearCollapseTimer();a.setHeight(34);a.setVisible(true);a.popOutToolbar.hide();a.focus();this.saveState()},startCollapseTimer:function(){var a=this;if(!a.collapseTask){a.collapseTask=Ext.create("Ext.util.DelayedTask",function(){if(a.popOutToolbar.getEl().contains(document.activeElement)){a.startCollapseTimer()}else{a.collapseMiniBanner()}})}a.collapseTask.delay(Ext.isNumber(a.collapseDelay)?a.collapseDelay:5000,null,a)},clearCollapseTimer:function(){var a=this;if(a.collapseTask){a.collapseTask.cancel();a.collapseTask=null;a.expandBanner()}},collapseMiniBanner:function(d){var c=this,b=this.getPopOutBanner(),a=b.items.items;if(!b.miniWidth){b.miniWidth=a[c.noItemsToShow].getEl().getOffsetsTo(b.getEl())[0]}b.animate({easing:"elasticIn",duration:Ext.isNumber(d)?d:500,to:{width:b.miniWidth},listeners:{afteranimate:function(){if(c.state!="docked"){c.state="collapsed"}}}})},expandBanner:function(){var c=this,b=this.getPopOutBanner(),a=b.items.items;if(b.originalWidth&&b.originalWidth!==b.getSize().width){b.animate({easing:"backOut",duration:500,to:{width:b.originalWidth},listeners:{afteranimate:function(){if(c.state!="docked"){c.state="mini"}}}})}},resizePopOutBanner:function(){var a=this.getPopOutBanner(),b=a.items.items,c=b[b.length-1].getEl(),d=c.getOffsetsTo(a.getEl())[0]+c.getWidth();a.originalWidth=d+5;a.setWidth(a.originalWidth)},saveState:function(a){var b=this,c={state:b.state,position:b.isVisible()||!b.popOutToolbar?[0,0]:b.popOutToolbar.getPosition()};Ozone.pref.PrefServer.setUserPreference({namespace:"owf.banner",name:"state",value:Ozone.util.toString(c),onSuccess:function(d){if(a!=null){a()}},onFailure:function(){}})},addMarketplaceButton:function(b){this.marketplaceWidget=b;if(!this.hasMarketplaceButton){var a=this,c=0;a.insert(this.marketplaceButtonIndex+c,{xtype:"tbseparator",itemId:"mpSeparator"});a.insert(this.marketplaceButtonIndex+1+c,{xtype:"button",itemId:"marketBtn",cls:"bannerBtn  marketBtn",iconCls:"marketplaceBtnIcon",scale:"banner-large",iconAlign:"top",text:null,tooltip:{title:Ozone.layout.tooltipString.marketplaceWindowTitle,text:Ozone.layout.tooltipString.marketplaceWindowContent,width:500,maxWidth:500},scope:this,handler:this.openMarketplaceModalWindow});if(this.popOutToolbar){if(!this.popOutToolbar.getComponent("marketBtn")){this.popOutToolbar.insert(this.marketplaceButtonIndex+2,{xtype:"tbseparator",itemId:"mpSeparator"});this.popOutToolbar.insert(this.marketplaceButtonIndex+3,this.getComponent("marketBtn").cloneConfig());this.resizePopOutBanner()}}this.hasMarketplaceButton=true}},removeMarketplaceButton:function(){if(this){var a=this.items.indexOf(this.getComponent("marketBtn"));this.remove(a);this.remove(a-1)}if(this.popOutToolbar){var a=this.popOutToolbar.items.indexOf(this.popOutToolbar.getComponent("marketBtn"));this.popOutToolbar.remove(a);this.popOutToolbar.remove(a-1);this.resizePopOutBanner()}this.hasMarketplaceButton=false},addMetricButton:function(){var b=this.hasMarketplaceButton?this.marketplaceButtonIndex+2:this.marketplaceButtonIndex;if(!this.hasMetricButton){var a=this,c=0;a.insert(b+c,{xtype:"tbseparator",itemId:"metricSeparator"});a.insert(b+1+c,{xtype:"button",itemId:"metricBtn",cls:"bannerBtn  metricBtn",iconCls:"metricBtnIcon",scale:"banner-large",iconAlign:"top",text:null,tooltip:{title:Ozone.layout.tooltipString.metricWindowTitle,text:Ozone.layout.tooltipString.metricWindowContent,width:250},scope:this,handler:this.openMetricWindow})}if(this.popOutToolbar){if(!this.popOutToolbar.getComponent("metricBtn")){this.popOutToolbar.insert(b+2,{xtype:"tbseparator",itemId:"metricSeparator"});this.popOutToolbar.insert(b+3,this.getComponent("metricBtn").cloneConfig());this.resizePopOutBanner()}}this.hasMetricButton=true},removeMetricButton:function(){if(this){var a=this.items.indexOf(this.getComponent("metricBtn"));this.remove(a);this.remove(a-1)}if(this.popOutToolbar){var a=this.popOutToolbar.items.indexOf(this.popOutToolbar.getComponent("metricBtn"));this.popOutToolbar.remove(a);this.popOutToolbar.remove(a-1);this.resizePopOutBanner()}this.hasMetricButton=false}});