Ext.define("Ozone.components.dashboard.Dashboard",{extend:"Ext.panel.Panel",alias:["widget.dashboard","widget.Ozone.components.dashboard.Dashboard"],activeWidget:null,plugins:[new Ozone.plugins.Dashboard()],dashboardContainer:null,eventingContainer:null,widgetLauncher:null,addWidgetContainer:null,widgetStateHandler:null,windowGroup:null,widgetStateContainer:null,type:null,configRecord:null,config:{name:"Default Dashboard",alteredByAdmin:"false",user:null,isdefault:false,locked:false,guid:null,state:null},hideMode:"visibility",cls:"dashboard",saveLock:false,hasChanged:false,dontSave:false,stateStore:null,widgetStore:null,widgetIframeDelay:200,panes:null,layout:"fit",widgetCls:"widgetwindow",buildItemsArray:function(b){if(!b||!b.items){return}if(b.items.length===0){if(!b.paneType){b.paneType="tabbedpane"}b.xtype=b.paneType}else{if(b.xtype==="dashboarddesignerpane"){b.xtype="container";b.layout="fit"}for(var c=0,a=b.items.length;c<a;c++){this.buildItemsArray(b.items[c])}}return b},initComponent:function(){var a=this;if(!a.configRecord.get("layoutConfig")){a.configRecord.set("layoutConfig",{cls:null,height:"100%",items:[],paneType:null,xtype:"desktoppane"})}a.items=a.buildItemsArray(a.configRecord.get("layoutConfig"))||[];if(this.stateStore!=null&&this.stateStore.storeId==null){this.stateStore.storeId=this.guid;Ext.data.StoreManager.register(this.stateStore)}this.callParent(arguments);this.addEvents("beforeserversave","serversave","widgetStartDrag","widgetStopDrag",OWF.Events.Widget.BEFORE_LAUNCH,OWF.Events.Widget.AFTER_LAUNCH);this.enableBubble([OWF.Events.Widget.BEFORE_LAUNCH,OWF.Events.Widget.AFTER_LAUNCH]);this.on("activate",this.onActivate,this);this.on("deactivate",this.onDeActivate,this);if(!this.stateStore){this.stateStore=Ext.create("Ozone.data.StateStore")}this.stateStore.on({add:{fn:function(){if(this.rendered){this.hasChanged=true}},scope:this},update:{fn:function(){if(this.rendered){this.hasChanged=true}},scope:this},remove:{fn:function(){if(this.rendered){this.hasChanged=true}},scope:this},clear:{fn:function(){if(this.rendered){this.hasChanged=true}},scope:this}});a.on(OWF.Events.Widget.BEFORE_LAUNCH,a.onBeforeWidgetLaunch,a);a.on("afterlayout",a.afterDashboardLayout,a,{single:true});a.on("beforedestroy",a.cleanup,a)},afterDashboardLayout:function(){var c=this,e,d=[];this.panes=this.query("pane");for(var b=0,a=this.panes.length;b<a;b++){e=this.panes[b];e.widgetStateContainer=this.widgetStateContainer;d.push.apply(d,e.launchPreviouslyOpenedWidgets())}$.when(d).then(function(){c.fireEvent(OWF.Events.Dashboard.COMPLETE_RENDER,c);if(OWF.Mask){OWF.Mask.hide();OWF.Mask=null}var o=c.stateStore.data.items;for(var m=0,n=o.length;m<n;m++){var h=o[m];var p=h.get("intentConfig");for(var f in p){var q=p[f];var k=[];for(var l=0;l<q.length;l++){var g=Ozone.util.parseJson(q[l]).id;if(c.stateStore.findExact("uniqueId",g)>-1){k.push(q[l])}}if(k.length>0){p[f]=k}else{delete p[f]}}}console.timeEnd("initload")})},enableWidgetDragAndDrop:function(){this.dropZone=this.dropZone||new Ext.dd.DropZone(this.getEl(),{ddGroup:"widgets",getTargetFromEvent:function(a){return a.getTarget(".paneshim")},onNodeEnter:function(d,a,c,b){Ext.fly(d).addCls("highlight-dashboard-designer-drop")},onNodeOut:function(d,a,c,b){Ext.fly(d).removeCls("highlight-dashboard-designer-drop")},onNodeOver:function(d,a,c,b){return Ext.dd.DropZone.prototype.dropAllowed},onNodeDrop:this.launchWidgets});this.enableWidgetMove()},disableWidgetDragAndDrop:function(){this.disableWidgetMove();this.cleanup()},cleanup:function(){if(this.dropZone){this.dropZone.unreg();delete this.dropZone}},launchWidgets:function(f,j,i,d){var a=f.id,b,c,e=Ext.getCmp(a),h,g;if(i){h=i.x?i.x:i.getX();g=i.y?i.y:i.getY()}if(!e||!e.isXType("pane")){b=Ext.get(f).up(".pane");if(b){e=Ext.getCmp(b.id)}}if(e&&e.isXType("pane")){e=Ext.getCmp(e.id);if(i){c=e.el.getOffsetsTo(Ext.getBody());e.launchWidgets(d.widgetModel,h-c[0],g-c[1],0)}else{e.launchWidgets(d.widgetModel)}return true}return false},onBeforeWidgetLaunch:function(e,g,d){var h=this.stateStore,j=g.get("uniqueId")||guid.util.guid(),a=g.get("singleton"),k=g.get("background"),b=h.findRecord("widgetGuid",g.get("widgetGuid")),c=!!b,i;if(a&&c){e.activateWidget(Ext.getCmp(b.get("uniqueId")));return false}if(k){i=this.add({xtype:"widgetiframe",style:"display: none",isWidget:true,iframeProperties:OWF.Container.Eventing.getIframeProperties(g.get("url"),j,g.data,e.id,d,this.configRecord.get("locked"))});var l={uniqueId:j,dashboardGuid:this.id,paneGuid:e.id,widgetGuid:g.get("widgetGuid"),statePosition:++e.statePositionCount,name:g.get("name"),active:false,width:g.get("width"),height:g.get("height"),x:0,y:0,zIndex:0,minimized:false,maximized:false,pinned:false,collapsed:false,columnPos:0,columnOrder:"",buttonId:null,buttonOpened:false,region:"",singleton:g.get("singleton"),background:g.get("background")};var f=e.stateStore.findExact("uniqueId",j);if(f!==-1){e.stateStore.removeAt(f)}e.stateStore.add(l);e.fireEvent(OWF.Events.Widget.AFTER_LAUNCH,i,g);return false}if(!e._launchingPreviouslyOpenedWidgets&&!e._reorderingWidgets&&e.dashboard.configRecord.get("locked")){e.launchFloatingWidget(g,null,null,j,d);return false}return true},moveWidgetToPane:function(j,b,e,d){var g=this,c=d.model,i=j.getX(),h=j.getY();if(!b||!e||b===e||this.configRecord.get("locked")){return}c=this.widgetStore.findRecord("widgetGuid",c.get("widgetGuid"));function f(){if(e.isXType("fitpane")&&e.items.length>0){e.confirmReplaceWidget(d.id,d.title,function(){e.clearWidgets(false);e.items.clear();a()})}else{a()}}function a(){var l=e,k=l.cloneWidgetDataForTransfer(d);d.on("destroy",function(){g.launchWidgets(l,null,{x:i,y:h},{widgetModel:k})});d.destroy()}d.isFloating()?setTimeout(f,500):f()},onDestroy:function(){if(this.stateStore!=null){this.stateStore.destroyStore();this.stateStore=null}this.callParent(arguments)},launchWidgetInstance:function(h,o){var c=null,n=null,e,d=Ext.getCmp(h.id).pane;if(o.guid!=null){n=this.widgetStore.getById(o.guid)}else{if(o.universalName!=null){var l=this.widgetStore.findExact("universalName",o.universalName);if(l>-1){n=this.widgetStore.getAt(l)}}}if(n==null){e={error:true,newWidgetLaunched:false,message:"The specified widget wasn't found."}}else{n=n.copy();if(o.title!=null){if(o.titleRegex==null){n.data.name=o.title}else{var j=o.titleRegex.match(/^\/(.*)\/(.*)$/);if(j!=null&&j[1]!=""){n.data.name=n.data.name.replace(new RegExp(j[1],j[2]),o.title)}}}if(!d.isXType("fitpane")){if(this.panes&&this.panes.length>1){var r,f,q;for(var g=0,k=this.panes.length;g<k;g++){var b=this.panes[g];if(!b.isXType("fitpane")){if(b.defaultSettings&&b.defaultSettings.widgetStates){r=b.defaultSettings.widgetStates[n.data.widgetGuid];if(r&&r.timestamp){if(!f||r.timestamp>f){f=r.timestamp;q=b}}}}}if(q){d=q}}}o.guid=n.data.widgetGuid;if(o.launchOnlyIfClosed){for(var g=0,k=this.stateStore.getCount();g<k;g++){var a=this.stateStore.getAt(g);if(a!=null&&a.get("widgetGuid")==o.guid){c=a;if(!n.get("background")){this.handleAlreadyLaunchedWidget(a.data)}e={error:false,newWidgetLaunched:false,message:"An instance of the specified widget already exists.",uniqueId:a.get("uniqueId")};break}}}if(c==null){var m=guid.util.guid();if(d.fireEvent(OWF.Events.Widget.BEFORE_LAUNCH,d,n,o.data)!==false){d.launchWidget(n,null,null,m,o.data,true)}e={error:false,newWidgetLaunched:true,uniqueId:m}}}return e},handleWidgetRequest:function(a){switch(a.fn){case"getWidgetState":return this.getWidgetState(a.params.guid);case"getWidgetStateEvents":return this.getWidgetStateEvents(a.params.guid);case"addStateEventListeners":return this.addWidgetStateEvents("listen",a.params.guid,a.params.events);case"addStateEventOverrides":return this.addWidgetStateEvents("override",a.params.guid,a.params.events);case"removeStateEventListeners":return this.removeWidgetStateEvents("listen",a.params.guid,a.params.events);case"removeStateEventOverrides":return this.removeWidgetStateEvents("override",a.params.guid,a.params.events);case"closeWidget":return this.closeWidget(a.params.guid);case"activateWidget":return this.activateWidget(a.params.guid);case"getWidgetConfig":var b=this.getWidgetState(a.params.guid);return Ext.JSON.encode(b);case"refreshWidgetLaunchMenu":return this.refreshWidgetLaunchMenu();default:break}},getWidgetStateEvents:function(d){var c=Ext.getCmp(d);var b=[];if(c){for(var a in c.events){b.push(a)}return b.sort()}return b},addWidgetStateEvents:function(f,c,e){var g=Ext.getCmp(c),b;function h(k,j,i){return function(){return k.handleStateEvent(j,i)}}if(g){if(e==null||e==undefined||e.length==0){e=this.getWidgetStateEvents(c)}for(var d=0,a=e.length;d<a;d++){b=e[d];if(g.tab&&b.indexOf("close")>-1){if(f==="override"){g.tab.purgeListener(b)}g["on_"+b]=h(g,f,b);g.tab.on(b,g["on_"+b])}else{if(f==="override"){g.purgeListener(b)}g["on_"+b]=h(g,f,b);g.on(b,g["on_"+b])}}return true}return false},removeWidgetStateEvents:function(e,b,d){var g=Ext.getCmp(b),a,f;if(g){if(d==null||d==undefined||d.length==0){d=this.getWidgetStateEvents(b)}for(var c=0;c<d.length;c++){a=d[c];f=g;if(g.tab&&a.indexOf("close")>-1){f=g.tab}if(f.hasListener(a)){f.un(a,g["on_"+a])}if(e=="override"){f.restoreListener(a)}}return true}return false},activateWidget:function(a){var b=Ext.getCmp(a);if(b){if(b.floatingWidget){b.minimized===true?b.restoreFromMinimize(true):b.focus(false,false,true,true);this.updateActiveWidget(b);return true}else{return b.pane.activateWidget(b)}}return false},closeWidget:function(a){var b=Ext.getCmp(a);if(b!==undefined){b.close();return true}return false},refreshWidgetLaunchMenu:function(){var a=Ext.getCmp("widget-launcher");a.refresh()},handleAlreadyLaunchedWidget:function(b){var a=Ext.getCmp(b.uniqueId);this.fireEvent(OWF.Events.Widget.AFTER_LAUNCH,a,a.model,true);Ext.getCmp(b.paneGuid).activateWidget(a)},getWidgetConfig:function(a){var b=this.widgetStore.getById(a);return b?b.data:null},getWidgetState:function(b){var e=Ext.getCmp(b),d,a,c;if(e){c=e.getSize();d=e.getState();if(e.maximized){Ext.apply(d,{height:c.height,width:c.width})}}else{a=this.stateStore.getById(b);d=a?a.data:{}}delete d.launchData;return d},removeState:function(a){this.stateStore.remove(this.stateStore.getById(a))},initNewWidget:function(a){a.on("close",function(){this.updateActiveWidget(null,false)},this);a.on("statesave",function(){this.defaultSettings.widgetStates=this.defaultSettings.widgetStates||{};var d=this.stateStore.data.items;for(var e=0,b=d.length;e<b;e++){var c=d[e];this.defaultSettings.widgetStates[c.data.widgetGuid]={x:c.data.x,y:c.data.y,height:c.data.height,width:c.data.width,columnPos:c.data.columnPos}}},this)},initDashboard:function(){this.widgetLauncher.registerWindowManager(this);this.addWidgetContainer.registerWindowManager(this);this.widgetStateContainer.registerWindowManager(this);var a=Ext.state.Manager.getProvider();if(a.setStore&&typeof a.setStore==="function"){a.setStore(this.stateStore)}document.title=this.config.name},onRender:function(b,a){this.initDashboard();this.callParent(arguments)},onActivate:function(e){var b=this.dashboardContainer.getBanner();this.initDashboard();if(this.configRecord.get("locked")){b.disableLaunchMenu()}else{b.enableLaunchMenu()}var c=this.stateStore.data.items;for(var d=0,a=c.length;d<a;d++){var f=c[d],h=f.get("uniqueId"),e=Ext.getCmp(h);var g;if(e&&(g=e.on_show)){g()}}},onDeActivate:function(e){this.saveToServer();var c=this.stateStore.data.items;for(var d=0,a=c.length;d<a;d++){var f=c[d],g=f.get("uniqueId"),e=Ext.getCmp(g);var b;if(e&&(b=e.on_hide)){b()}}},getJson:function(){var d=this.configRecord.data,f,e=this.query("pane"),b;for(var c=0,a=e.length;c<a;c++){f=e[c];f.initialConfig.widgets=f.getStatesOfAllWidgets();f.initialConfig.defaultSettings=f.defaultSettings}d.state=[];d=Ext.clone(d);return d},saveToServer:function(c,d,b,a,f){if(this.configRecord&&this.stateStore&&!this.dontSave){if(this.hasChanged||this.configRecord.dirty||d){var e=this;if(this.fireEvent("beforeserversave",this)!==false){if(!this.saveLock){this.saveLock=true;Ozone.pref.PrefServer.createOrUpdateDashboard({json:this.getJson(),saveAsNew:(b===true),onSuccess:function(){e.configRecord.commit();e.hasChanged=false;e.fireEvent("serversave",e,true);e.saveLock=false;if(a){a()}},onFailure:function(){e.fireEvent("serversave",e,false);e.saveLock=false;if(f){f()}},async:!c})}}}}},shimPanes:function(){var c=this.panes;for(var b=0,a=c.length;b<a;b++){c[b].shim()}},unshimPanes:function(){var c=this.panes;for(var b=0,a=c.length;b<a;b++){c[b].unshim()}},enableWidgetMove:function(d){var c=this.panes;for(var b=0,a=c.length;b<a;b++){if(this.configRecord.get("locked")===true){c[b].disableWidgetMove()}else{if(d){if(c[b].id!==d.id){c[b].enableWidgetMove()}else{c[b].shim()}}else{c[b].enableWidgetMove()}}}},disableWidgetMove:function(){var c=this.panes;if(!c){return}for(var b=0,a=c.length;b<a;b++){c[b].disableWidgetMove()}},getViewPort:function(){return Ext.getCmp(this.viewportId)},getSite:function(){var c=window.location.pathname;var a=/^(\/[^\/]+\/).*$/i;var b=c.match(a);if(b&&b[1]&&b[1].length>0){c=b[1];c=c.substring(0,c.length-1)}else{c=""}return window.location.protocol+"//"+window.location.host+(c.charAt(0)!="/"?("/"+c):c)},updateActiveWidget:function(c,b){if(!c){this.activeWidget=null;return}if(this.activeWidget===c&&c.iframeReady){gadgets.rpc.call(c.getIframeId(),"_widget_activated")}if(this.activeWidget&&this.activeWidget!==c){this.activeWidget.active=false;this.activeWidget.removeCls(this.activeWidget.focusCls);if(this.activeWidget.iframeReady&&b!==false){this.activeWidget._activated=false;var a=this.activeWidget.getIframeId();if(a){gadgets.rpc.call(a,"_widget_deactivated")}}}this.activeWidget=c;if(c&&b!==false&&this.activeWidget.iframeReady&&!c._activated){c.active=true;c._activated=true;gadgets.rpc.call(c.getIframeId(),"_widget_activated")}},getActiveWidget:function(a){return Ext.getCmp(a)||this.activeWidget},getViewHeight:function(){return Ext.getCmp("dashboardCardPanel").getHeight()},getViewWidth:function(){return Ext.getCmp("dashboardCardPanel").getWidth()},moveWidgetUp:function(b){var a=this.getActiveWidget(b);if(a&&a.initialConfig.floatingWidget){a.pane.moveFloatingWidgetUp(a)}else{a&&a.pane.moveWidgetUp(a)}},moveWidgetRight:function(b){var a=this.getActiveWidget(b);if(a&&a.initialConfig.floatingWidget){a.pane.moveFloatingWidgetRight(a)}else{a&&a.pane.moveWidgetRight(a)}},moveWidgetDown:function(b){var a=this.getActiveWidget(b);if(a&&a.initialConfig.floatingWidget){a.pane.moveFloatingWidgetDown(a)}else{a&&a.pane.moveWidgetDown(a)}},moveWidgetLeft:function(b){var a=this.getActiveWidget(b);if(a&&a.initialConfig.floatingWidget){a.pane.moveFloatingWidgetLeft(a)}else{a&&a.pane.moveWidgetLeft(a)}}});