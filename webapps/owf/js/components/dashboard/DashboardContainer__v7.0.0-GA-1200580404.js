Ext.define("Ozone.components.dashboard.DashboardContainer",{extend:"Ext.panel.Panel",alias:["widget.dashboardContainer","widget.Ozone.components.dashboard.DashboardContainer"],plugins:new Ozone.plugins.DashboardContainer(),activeDashboard:null,dashboardMenuItems:null,dashboardStore:null,widgetStore:null,dashboards:null,autoSaveEnabled:true,layout:"fit",refreshUrl:window.location,user:null,widgetNames:{},originalWidgetNames:{},pollingInterval:Ozone.config.autoSaveInterval?Ozone.config.autoSaveInterval:900000,suppressLockWarning:false,floatingWidgetManager:null,bannerManager:null,dashboardDesignerManager:null,modalWindowManager:null,tooltipManager:null,initComponent:function(){var g=this,e={},c,b,d;this.stackStore=Ext.create("Ozone.data.StackStore",{});for(var f=0,a=this.dashboardStore.getCount();f<a;f++){d=this.dashboardStore.getAt(f);c=d.data;b=c.stack;if(b){if(e[b.id]){e[b.id].get("dashboards").push(d)}else{var h=this.stackStore.add(b)[0];h.set("dashboards",[d]);e[b.id]=h}}}this.originalDashboardStore=Ext.create("Ozone.data.DashboardStore",{});this.dashboardMenuItems=[];this.dashboards=[];this.initEventing();OWF.Container=OWF.Container||{};OWF.Container.Eventing=Ozone.eventing.Container;OWF.Container.Launcher=new Ozone.launcher.WidgetLauncherContainer(OWF.Container.Eventing);this.addWidgetContainer=new Ozone.marketplace.AddWidgetContainer(OWF.Container.Eventing);OWF.Container.DragAndDrop=new Ozone.dragAndDrop.WidgetDragAndDropContainer({eventingContainer:OWF.Container.Eventing});OWF.Container.DragAndDrop.addCallback("dragStart",Ext.bind(function(i){Ext.getCmp(this.activeDashboard.id).fireEvent("widgetStartDrag",i)},this));OWF.Container.DragAndDrop.addCallback("dragStop",Ext.bind(function(i){Ext.getCmp(this.activeDashboard.id).fireEvent("widgetStopDrag",i)},this));OWF.Container.Chrome=new Ozone.chrome.WidgetChromeContainer({eventingContainer:OWF.Container.Eventing});OWF.Container.State=new Ozone.state.WidgetStateContainer(OWF.Container.Eventing);this.user=Ozone.config.user;this.widgetNames=Ozone.config.widgetNames||{};this.widgetStore.on("datachanged",this.updateTitlesandBanner,this);Ext.apply(this,{layout:{type:"vbox",align:"stretch"},items:[{itemId:"owfbanner",xtype:"owfbanner",user:this.user,dashboardContainer:this},{id:"dashboardCardPanel",itemId:"dashboardCardPanel",xtype:"panel",flex:1,layout:{type:"bufferedcard"},cls:"usableCentralRegion",listeners:{afterlayout:{fn:function(i){i.isLayedOut=true},scope:this,single:true}},items:[]}]});this.callParent(arguments);this.on("afterlayout",this.startAutoSave,this,{single:true});this.on("resize",function(l,n,i,k,p,m){var j=this.getBanner();if(j&&j.popOutToolbar&&j.popOutToolbar.isVisible()){var o=j.getBanner().getPosition(true);if(o[0]>n||o[1]>i){j.dockPopOutBanner()}}});this.onBeforeUnload=function(i){Ozone.pref.PrefServer.deleteUserPreference({namespace:"owf.custom.widgetprefs",sync:true,name:"widgetNames"});if(this.activeDashboard!=null){Ext.getCmp(this.activeDashboard.id).saveToServer(true)}if(!this.shareButtonClicked){Ext.History.shutDown()}else{this.shareButtonClicked=false}};Ext.EventManager.on(window,"beforeunload",this.onBeforeUnload,this);this.addKeyBindings();this.addEvents({dashboardChanged:true});Ext.getDoc().on("mousedown",this.onWidgetMouseDown,this,{delegate:".widgetheader"});this.updateTitlesandBanner();this.initLoad()},onWidgetMouseDown:function(i,g){var e,c,k,b;if(i.getTarget().nodeName==="IMG"){return}k=Ext.get(g);e=k.up(".x-closable");c=e?e.dom.id:g.id;b=Ext.getCmp(c);b=b.card||b;if(!b.isWidget||b.floatingWidget){return}Ext.getDoc().on("mousemove",this.onMouseMove,this);Ext.getDoc().on("mouseup",this.onMouseUp,this);this._widgetToMove=b;this._sourcePane=this._widgetToMove.pane;this._paneWidgets=[];this._paneWidgetsBox=[];var b,j;var a=this._sourcePane.getWidgets(),d=Ext.getBody();for(var h=0,f=a.length;h<f;h++){b=a[h];b._position=h;this._paneWidgets.push(b);j=b.tab?b.tab.getBox():b.getBox();j.midpoint=b.tab?j.x+(j.width/2):j.y+(j.height/2);this._paneWidgetsBox.push(j)}},onMouseMove:function(j,e){var m=j.getXY(),d=Ext.get(e).up(".pane"),a=this._widgetToMove.isFloating();this._reorderingWidgets=false;if(this._counter){this.ddProxy.el.setStyle({left:(m[0]+25)+"px",top:(m[1]+25)+"px"});if(this.activeDashboard.configRecord.get("locked")){this.ddProxy.setStatus(this.ddProxy.dropNotAllowed)}else{this.ddProxy.setStatus(d?this.ddProxy.dropAllowed:this.ddProxy.dropNotAllowed)}if(d&&this._sourcePane.el===d){if(a){this.ddProxy.hide()}else{this.ddProxy.show();this._reorderingWidgets=true;var k,l;var b=false,i=m[0],h=m[1];for(var f=0,c=this._paneWidgets.length;f<c;f++){l=this._paneWidgets[f];k=this._paneWidgetsBox[f];if(l.tab){if(k.x<i&&((k.x+k.width)>i)){b=true;break}}else{if(k.y<h&&((k.y+k.height)>h)){b=true;break}}}f=(b&&l?f:this._paneWidgets.length);if(this._lastDropIndicatedWidget){this._lastDropIndicatedWidget.el.removeCls.call(this._lastDropIndicatedWidget.tab?this._lastDropIndicatedWidget.tab.el:this._lastDropIndicatedWidget.el,["indicate-drop-before","indicate-drop-after"])}if(f===this._widgetToMove._position){this.ddProxy.setStatus(this.ddProxy.dropNotAllowed)}else{if(b){this._lastDropIndicatedWidget=this._paneWidgets[f];var g;if((l.tab&&k.midpoint>i)||(!l.tab&&k.midpoint>h)){g="indicate-drop-before"}else{f=f+1;g="indicate-drop-after"}this._lastDropIndicatedWidget.el.addCls.call(this._lastDropIndicatedWidget.tab?this._lastDropIndicatedWidget.tab.el:this._lastDropIndicatedWidget.el,g);this._movePosition=f}}}}else{this.ddProxy.show()}}else{this._counter=1;this.ddProxy=this.ddProxy||Ext.create("Ext.dd.StatusProxy",{shadow:false});this.ddProxy.update('<img src="'+this._widgetToMove.model.get("image")+'" class="widget-drag-proxy"/>');this.ddProxy.show();this.ddProxy.hide();this.activeDashboard.enableWidgetMove(d)}},onMouseUp:function(a,b){var c;if(this._lastDropIndicatedWidget){this._lastDropIndicatedWidget.el.removeCls.call(this._lastDropIndicatedWidget.tab?this._lastDropIndicatedWidget.tab.el:this._lastDropIndicatedWidget.el,["indicate-drop-before","indicate-drop-after"])}Ext.getDoc().un("mousemove",this.onMouseMove,this);Ext.getDoc().un("mouseup",this.onMouseUp,this);if(this._movePosition&&this._widgetToMove._position<this._movePosition){this._movePosition-=1}if(this._reorderingWidgets&&this._movePosition!==undefined&&this._movePosition!==this._widgetToMove._position){this._sourcePane.reorderWidget(this._widgetToMove,this._movePosition)}else{if(this._widgetToMove&&(c=Ext.fly(b).up(".pane"))){this.activeDashboard.moveWidgetToPane(a,Ext.getCmp(this._widgetToMove.paneGuid),Ext.getCmp(c.dom.id),this._widgetToMove)}}this.activeDashboard.disableWidgetMove();this.ddProxy&&this.ddProxy.hide();delete this._counter;delete this._movePosition;delete this._widgetToMove;delete this._lastDropIndicatedWidget;delete this._sourcePane;delete this._paneWidgets;delete this._paneWidgetsBox},launchWidgets:function(a,c){var b=this;b.selectPane(c).then(function(f,d){b.activeDashboard.launchWidgets(f,null,d,{widgetModel:a})},function(){var d=Ext.getCmp("widget-launcher");if(d){d.fireEvent("noWidgetLaunched")}})},selectPane:function(b){var d=this,a=jQuery.Deferred(),c=this.activeDashboard.panes,e=Ext.getDoc();if(c.length===1){a.resolve(c[0])}else{this.activeDashboard.enableWidgetMove();if(b===true){if(document.activeElement){document.activeElement.blur()}c[0].focus()}e.on("keydown",this._selectPaneOnKeyDown,this,{capture:true,deferred:a});this.el.on("click",this._selectPaneOnClick,this,{deferred:a});a.always(function(){d.activeDashboard.disableWidgetMove();e.un("keydown",d._selectPaneOnKeyDown,d,{capture:true});d.el.un("click",d._selectPaneOnClick,d)})}return a.promise()},_selectPaneOnKeyDown:function(f,h,b){var c=this.activeDashboard.panes,a=f.getKey(),d=c.length-1,g;f.stopEvent();this._previousPaneIndex=this._previousPaneIndex||0;if(a===Ext.EventObject.TAB){if(f.shiftKey){if(this._previousPaneIndex===0){g=d}else{g=this._previousPaneIndex-1}}else{if(this._previousPaneIndex===d){g=0}else{g=this._previousPaneIndex+1}}c[this._previousPaneIndex].blur();c[g].focus();this._previousPaneIndex=g}else{if(a===Ext.EventObject.ENTER){b.deferred.resolve(c[this._previousPaneIndex],f);delete this._previousPaneIndex}else{if(a===Ext.EventObject.ESC){b.deferred.reject()}}}},_selectPaneOnClick:function(c,f,b){var d=Ext.get(f).up(".pane"),a=b.deferred;if(d){a.resolve(Ext.getCmp(d.id),c)}else{a.reject()}},initLoad:function(){var c=this.widgetStore.getRange();for(var g=0;g<c.length;g++){this.originalWidgetNames[c[g].data.widgetGuid]=c[g].data.name}var b=Ext.util.History.getToken();var f=b?Ext.urlDecode(b):{};var m=f.guid;var a=[];var l=f.stack;if(this.dashboardStore.getCount()>0){for(var g=0,k=this.dashboardStore.getCount();g<k;g++){var e=this.dashboardStore.getAt(g);var j=e.data;this.dashboards.push(this.createDashboardConfig(e));this.originalDashboardStore.add(Ext.JSON.decode(Ext.JSON.encode(e.data)));if(l&&e.data.stack&&e.data.stack.stackContext==l){a.push(this.createDashboardConfig(e))}if(m!=null){if(j.guid==m){this.activeDashboard=this.dashboards[this.dashboards.length-1]}}if(j.isdefault){this.defaultDashboard=this.dashboards[this.dashboards.length-1]}}}if(this.activeDashboard==null){if(a.length>0){this.activeDashboard=a[0];if(this.defaultDashboard){for(var g=0;g<a.length;g++){if(this.defaultDashboard.guid==a[g].guid){this.activeDashboard=a[g];break}}}this.defaultDashboard=this.activeDashboard}else{if(this.defaultDashboard!=null){this.activeDashboard=this.defaultDashboard}else{if(this.dashboards.length>0){this.activeDashboard=this.dashboards[0];this.defaultDashboard=this.activeDashboard}else{this.activeDashboard=this.createDashboardConfig(this.createEmptyDashboard("desktop",true));this.defaultDashboard=this.activeDashboard;this.dashboards.push(this.activeDashboard)}}}}Ext.state.Manager.setProvider(Ext.create("Ozone.state.WidgetStateStoreProvider",{store:this.activeDashboard?this.activeDashboard.stateStore:null}));Ext.util.History.on("change",function(i){if(i!=null){var n=Ext.urlDecode(i);if(n.guid!=null&&n.guid!="notFound"){this._activateDashboard(n.guid,n.stack)}else{if(n.guid=="notFound"){this._activateDashboard(null,n.stack)}else{this._activateDashboard("",n.stack)}}}else{this._activateDashboard(this.defaultDashboard.guid,n.stack)}},this);var h=this.getComponent("dashboardCardPanel");var d=Ext.bind(function(){h.activeItem=this.activeDashboard.id;h.add(this.dashboards);this.activeDashboard=h.getComponent(this.activeDashboard.id);this.activateDashboard(this.activeDashboard.id,true,this.activeDashboard.stackContext);if(this.activeDashboard.configRecord.get("locked")){this.getBanner().disableLaunchMenu()}else{this.getBanner().enableLaunchMenu()}},this);if(h.isLayedOut){d()}else{h.on({afterlayout:{fn:function(){d()},scope:this,single:true}})}},addKeyBindings:function(){Ext.FocusManager.disable();Ozone.KeyMap.addBinding([Ext.apply(Ozone.components.keys.HotKeys.WIDGET_SWITCHER,{scope:this,fn:this.showWidgetSwitcher}),Ext.apply(Ozone.components.keys.HotKeys.CLOSE_WIDGET,{scope:this,fn:this.closeWidget}),Ext.apply(Ozone.components.keys.HotKeys.MAXIMIZE_COLLAPSE_WIDGET,{scope:this,fn:this.maximizeCollapseWidget}),Ext.apply(Ozone.components.keys.HotKeys.MINIMIZE_EXPAND_WIDGET,{scope:this,fn:this.minimizeExpandWidget}),Ext.apply(Ozone.components.keys.HotKeys.ESCAPE_FOCUS,{scope:this,fn:this.esc}),Ext.apply(Ozone.components.keys.MoveHotKeys.MOVE_UP,{scope:this,alt:false,fn:this.saveWidgetState}),Ext.apply(Ozone.components.keys.MoveHotKeys.MOVE_RIGHT,{scope:this,alt:false,fn:this.saveWidgetState}),Ext.apply(Ozone.components.keys.MoveHotKeys.MOVE_DOWN,{scope:this,alt:false,fn:this.saveWidgetState}),Ext.apply(Ozone.components.keys.MoveHotKeys.MOVE_LEFT,{scope:this,alt:false,fn:this.saveWidgetState})]);Ozone.MoveKeyMap.addBinding([Ext.apply(Ozone.components.keys.MoveHotKeys.MOVE_UP,{scope:this,fn:function(a,c,b){this.activeDashboard.moveWidgetUp(b)}}),Ext.apply(Ozone.components.keys.MoveHotKeys.MOVE_RIGHT,{scope:this,fn:function(a,c,b){this.activeDashboard.moveWidgetRight(b)}}),Ext.apply(Ozone.components.keys.MoveHotKeys.MOVE_DOWN,{scope:this,fn:function(a,c,b){this.activeDashboard.moveWidgetDown(b)}}),Ext.apply(Ozone.components.keys.MoveHotKeys.MOVE_LEFT,{scope:this,fn:function(a,c,b){this.activeDashboard.moveWidgetLeft(b)}})])},showWidgetSwitcher:function(){var a="widget-switcher",b=Ext.getCmp(a);if(!b){b=Ext.widget("widgetswitcher",{id:a,dashboardContainer:this,activeDashboard:this.activeDashboard,widgetStore:this.widgetStore,plugins:new Ozone.components.keys.HotKeyComponent(Ozone.components.keys.HotKeys.WIDGET_SWITCHER)})}else{if(b.isVisible()){b.close();return}}b.show();b.activeDashboard=this.activeDashboard;b.setStore(this.activeDashboard.stateStore);b.center()},showDashboardSwitcher:function(){this.activeDashboard.saveToServer(false,true);var a="dashboard-switcher",b=Ext.getCmp(a);if(!b){b=Ext.widget("dashboardswitcher",{id:a,dashboardContainer:this,activeDashboard:this.activeDashboard,dashboardStore:this.dashboardStore,plugins:new Ozone.components.keys.HotKeyComponent(Ozone.components.keys.HotKeys.DASHBOARD_SWITCHER)})}else{if(b.isVisible()){b.close();return}}b.activeDashboard=this.activeDashboard;b.show().center()},destroyDashboardSwitcher:function(){var a="dashboard-switcher",b=Ext.getCmp(a);b&&b.destroy()},createDashboardConfig:function(a){var c=a.data;var b=Ext.create("Ozone.data.StateStore",{storeId:c.guid,data:[]});return{id:c.guid,itemId:c.guid,guid:c.guid,xtype:"dashboard",config:c,configRecord:a,widgetStore:this.widgetStore,stateStore:b,eventingContainer:OWF.Container.Eventing,widgetLauncher:OWF.Container.Launcher,addWidgetContainer:this.addWidgetContainer,widgetStateContainer:OWF.Container.State,widgetDragAndDrop:OWF.Container.DragAndDrop,dashboardContainer:this,viewportId:this.viewportId,name:c.name,userId:this.user.id,userName:this.user.displayName,stackContext:c.stack?c.stack.stackContext:null}},activateDashboard:function(b,a,c){var d=new Object();if(c){d.stack=c}d.guid=b;if(a){Ext.util.History.shutDown()}Ext.util.History.add(Ext.urlEncode(d));if(a){Ext.util.History.startUp()}},_activateDashboard:function(j,h){var d=this.getDashboardCardPanel();if(!d){return}if(j!=null&&j!=""){var k=d.layout.setActiveItem(j);if(k){this.activeDashboard=k;this.fireEvent(OWF.Events.Dashboard.CHANGED,j);this.setDefaultDashboard(j)}}else{var a=new Object();if(h){a.stack=h;var l=[];if(this.dashboardStore.getCount()>0){for(var c=0,g=this.dashboardStore.getCount();c<g;c++){var b=this.dashboardStore.getAt(c);if(h&&b.data.stack&&b.data.stack.stackContext==h){l.push(b.data.guid)}}}if(l.length>0){a.guid=l[0];if(this.defaultDashboard){for(var c=0;c<l.length;c++){if(this.defaultDashboard.guid==l[c]){a.guid=l[c];break}}}}}if(!a.guid){if(j==""){var f=this.defaultDashboard.guid;a.guid=f}else{var e=this.activeDashboard.guid;a.guid=e;Ext.defer(Ozone.Msg.alert,100,this,[Ozone.util.ErrorMessageString.invalidDashboard,this.activeDashboard.isdefault?Ozone.util.ErrorMessageString.invalidDashboardMsg:Ozone.util.ErrorMessageString.invalidDashboardGotoDefaultMsg,null,null,null,this.modalWindowManager])}}if(a.guid){Ext.util.History.add(Ext.urlEncode(a))}}},getBanner:function(){return this.getComponent("owfbanner")},getDashboardCardPanel:function(){return this.getComponent("dashboardCardPanel")},esc:function(c,a,b){if(a.fromWidget){this.unfocusWidget(c,a,b)}else{this.getBanner().getBanner().focus()}},unfocusWidget:function(b,c,a){var d=Ext.getCmp(a),e;if(d){e=d.tab?d.tab.header:d.header;if(e){e.titleCmp.focus()}else{this.getBanner().getBanner().focus()}}},openDashboardMgr:function(){var a="user-manage-dashboards";var b=Ext.getCmp(a);if(b){b.show();return}Ext.create("Ozone.components.window.DashboardsManager",{ownerCt:this,dashboardContainer:this,id:a,itemId:a,modal:true,border:false,bodyBorder:false}).show()},showCreateWindow:function(){var d=this.getHeight();var a=this.getWidth();var c=(d>339)?330:d-10;var b=(a>559)?550:a-10;var e="createNewDashboardWindowId";var g=Ext.getCmp(e);if(!g){var f={id:e,title:Ozone.layout.tooltipString.createDashboardTitle,ownerCt:this,constrain:Ext.isIE,constrainHeader:true,cls:"manageContainer",closeAction:"destroy",draggable:true,items:[{xtype:"owfCreateDashboardsContainer",dashboardContainer:this,winId:e}],width:b+20,height:c,listeners:{show:function(k){var h=this.getComponent("createNewDashboardPanel");var i=h.getComponent("titleBox");i.setRawValue("");var j=h.down("#importFileupload");j.setRawValue("");h.refreshData();if(h.afterRenderInitComplete==false){h.down("#viewCb").enable();h.down("#viewCb").validate();var l=h.down("#existViewCb");l.reset();l.disable();j.reset();j.disable();h.afterRenderInitComplete=true}h.focusTitleBox();i.clearInvalid();this.setupFocus(i.el,this.down("#cancelBtn").el)}}};g=Ext.widget("managerwindow",f)}if(g.isVisible()){g.close()}else{g.show()}},navigate:function(d){var c=this.getComponent("dashboardCardPanel");var b=c.getLayout();var a=c.items.indexOf(b.activeItem);a=a+d;b.activeItem.windowGroup.hideAll();if(a>0&&a<c.items.getCount()){b.setActiveItem(c.items.get(a))}},initEventing:function(){Ozone.eventing.Container.init({getIframeId:{fn:function(c){var a=Ext.getCmp(c);if(a!=null){var b=a.down("#widgetIframe");if(b!=null){return b.el.dom.id}}},scope:this},getOpenedWidgets:{fn:this.getOpenedWidgets,scope:this},widgetEventingReady:{fn:function(c,d){var g=gadgets.json.parse(d);if(g.loadTime!=null){var e=gadgets.json.parse(g.id);var b={id:e.id,msg:"Loaded in "+g.loadTime+" (ms)",loadTime:g.loadTime};var f=this.activeDashboard.stateStore;if(f!=null){var a=f.getById(e.id);if(a!=null){b.name=a.get("name");b.widgetGuid=a.get("widgetGuid");this.sendLoadTime(b)}else{f.on({add:{fn:function(j,i,k){var h=j.getById(e.id);if(h!=null){b.name=h.get("name");b.widgetGuid=h.get("widgetGuid");this.sendLoadTime(b)}},scope:this,single:true}})}}}},scope:this},onRoute:{fn:function(d,h,g,i){var b=false;if(d!=".."&&h!=".."){var a=Ozone.util.parseJson(d);var e=this.findParentDashboard(a.id);var c=Ozone.util.parseJson(h);var f=this.findParentDashboard(c.id);if(e!=null&&e==f){b=true}}else{b=true}return b},scope:this}});this.eventingContainer=Ozone.eventing.Container;OWF.IntentsContainer.init({onRoute:{fn:function(h,a,g,l,b){var m=Ozone.util.parseJson(h).id;var o=Ext.getCmp(m);var n=o.intentConfig;if(!l||(l.length!=null&&l.length<=0)){if(n!=null&&n[owfdojo.toJson(a)]!=null){var j=n[owfdojo.toJson(a)];var c=0;for(var f=0,k=j.length;f<k;f++){var e=j[f];var d=Ozone.util.parseJson(e).id;if(this.activeDashboard.stateStore.indexOfId(d)>-1){c++}}if(c==j.length){b.send(h,a,g,null,j);b.callback(j);return}else{delete n[owfdojo.toJson(a)]}}this.showLaunchMenuForIntents(a,b,h,g,o)}else{b.send(h,a,g,null,l);b.callback(l)}},scope:this}})},showLaunchMenuForIntents:function(a,c,g,f,k){var j=k.intentConfig;var i=Ext.getCmp("widget-launcher");if(i){if(!i.isVisible()){i.show()}i.disableWidgetStoreLoading(true);this.widgetStore.load({scope:this,callback:function(o,p,t){i.refreshOpenedWidgets();i.clearSelections(true);var l=Ext.create("Ozone.data.WidgetDefinition",{name:"Please select a widget below",description:"Widgets below are filtered against Intent: "+a.action+" "+a.dataType});i.updateInfoPanel(l,false,true,false,false);i.showIntentCheckBox=true;i.openOrCloseAdvancedSearch(true);var q=i.searchPanel.down("#intentsTree");var m=q.getSelectionModel();m.setLocked(false);var n={expanded:true,children:[{text:a.action,expanded:true,expandable:false,children:[{text:a.dataType,leaf:true}]}]};q.setRootNode(n);var r="!@//@!";q.selectPath(r+"Root"+r+a.action+r+a.dataType,"text",r);m.setLocked(true);i.disableWidgetStoreLoading(false);i.on({close:{fn:function(u){m.setLocked(false)},scope:this,single:true}});var s={intent:{action:a.action,dataType:a.dataType,receive:true}};i.searchPanel.search(s);i.searchPanel.loadGroupStore();i.showOpenedWidgetsView(true);i.loadLauncherState()}});var b=null;var e=null;var h=this;var d={beforewidgetlaunch:{fn:function(n,l){var m={intents:true};l.set("launchData",gadgets.json.stringify(m))}},afterwidgetlaunch:{fn:function(n,m,l){var p=n.uniqueId;var o='{"id":"'+p+'"}';!k.intentConfig&&(k.intentConfig={});j=k.intentConfig;if(l){c.send(g,a,f,null,o);if(i.getIntentCheckBoxValue()){if(j[owfdojo.toJson(a)]==null){j[owfdojo.toJson(a)]=[]}j[owfdojo.toJson(a)].push(o)}}else{b=function(q,r){if(q!=null&&owfdojo.toJson(q)===owfdojo.toJson(a)&&r===o){c.send(g,a,f,null,o);c.removeListener("onIntentsReady",b,this);if(i.getIntentCheckBoxValue()){if(j[owfdojo.toJson(a)]==null){j[owfdojo.toJson(a)]=[]}j[owfdojo.toJson(a)].push(o)}}};c.addListener("onIntentsReady",b,this)}c.callback([o]);i.showIntentCheckBox=false;i.un(e);h.un(d)},scope:this,single:true}};this.on(d);e={noWidgetLaunched:{fn:function(){this.un(d);if(b!=null){c.removeListener("onIntentsReady",b,this)}c.callback([]);i.showIntentCheckBox=false},scope:this,single:true}};i.on(e)}},findParentDashboard:function(d){var c=this.getComponent("dashboardCardPanel");var e=null;for(var b=0;b<c.items.getCount();b++){var a=c.items.getAt(b);if(a.stateStore.getById(d)!=null){e=a;break}}return e},sendLoadTime:function(a){if(Ozone.config.sendWidgetLoadTimesToServer===true){Ozone.util.Transport.send({url:Ozone.util.contextPath()+"/widgetLoadTime",method:"POST",async:true,content:a,onSuccess:function(){}})}if(Ozone.config.publishWidgetLoadTimes===true){var b=gadgets.json.stringify(a);Ozone.eventing.Container.publish("Ozone.eventing.widget.public",b)}},getOpenedWidgets:function(){var e=[];if(this.activeDashboard!=null&&this.activeDashboard.stateStore!=null){var g=this.activeDashboard.stateStore.getRange();for(var d=0;d<g.length;d++){var h=g[d].data;var a=Ext.getCmp(h.uniqueId);var c=this.widgetStore.getById(h.widgetGuid);if(c!=null){var b=c.data;if(b!=null&&a!=null){var f=a.down("#widgetIframe");if(f!=null){e.push({id:h.uniqueId,name:h.name,url:b.url,frameId:f.id,widgetGuid:h.widgetGuid,widgetName:b.name,universalName:b.universalName})}}}}}return e},startAutoSave:function(){if(this.autoSaveId){clearInterval(this.autoSaveId)}this.autoSaveId=setInterval(Ext.bind(function(){if(this.autoSaveClear){clearInterval(this.autoSaveId);this.autoSaveClear=false}else{if(this.autoSaveEnabled){if(this.activeDashboard){Ext.getCmp(this.activeDashboard.id).saveToServer()}}}},this),this.pollingInterval)},deleteDashboards:function(a){var e=a.length;if(e==0){return}var d=this.getDashboardCardPanel();for(var f=0;f<e;f++){var b=this.dashboardStore.find("guid",a[f]);if(b!=-1){if(this.dashboardStore.getAt(b).get("isDefault")==true){this.dashboardStore.getAt(0).get("isDefault")==true;this.activeDashboard=this.dashboards[0];this.defaultDashboard=this.activeDashboard}this.dashboardStore.removeAt(b)}d.remove(a[f]);for(var c=0,g=this.dashboards.length;c<g;c++){if(this.dashboards[c].id==a[f]){this.dashboards.splice(c,1);break}}}this.destroyDashboardSwitcher()},updateDashboardsFromStore:function(i,a,e,b){var f=this;var d=i[0].get("guid");var g=i[0].get("stack");var c=g?g.stackContext:null;this.dashboards.length=0;var h=this.getDashboardCardPanel();h.removeAll(true);this.destroyDashboardSwitcher();setTimeout(function(){for(var m=0,k=i.length;m<k;m++){var j=i[m];f.dashboards.push(f.createDashboardConfig(j));var l=h.add(f.dashboards[m]);if(j.get("isdefault")){d=j.get("guid");g=j.get("stack");c=g?g.stackContext:null;f.activeDashboard=l;f.defaultDashboard=l}}f._activateDashboard(b||d);f.activateDashboard(b||d,true,c)},200)},reloadDashboards:function(){var a=this;a.dashboardStore.load({callback:function(b,c,d){if(d==true){a.updateDashboardsFromStore(b,c,d)}}})},saveActiveDashboardToServer:function(){if(this.dashboardStore.getById(this.activeDashboard.id)){Ext.getCmp(this.activeDashboard.id).saveToServer(true,true,false)}},saveDashboard:function(c,b,e,a){var d=this;if(!a){a=function(){Ozone.Msg.alert("Dashboard Manager","Error creating or updating dashboard.",null,null,null,d.modalWindowManager);return}}Ozone.pref.PrefServer.createOrUpdateDashboard({json:c,saveAsNew:b=="create"?true:false,onSuccess:function(f){d.destroyDashboardSwitcher();d.dashboardCreated(f);e&&e(f);d=null},onFailure:a})},createEmptyDashboard:function(d,c){var a=guid.util.guid();var b={name:"Untitled",guid:a,isdefault:c,state:[]};this.saveDashboard(b,"create");var e={id:a,itemId:a,alteredByAdmin:"false",guid:a,isdefault:c,name:"Untitled",state:[]};this.dashboardStore.add(e);return this.dashboardStore.getAt(this.dashboardStore.getCount()-1)},createDashboard:function(a){this.designDashboard(a,false)},editDashboard:function(b){var a=this.getDashboardCardPanel().getComponent(b.get("guid"));this.designDashboard(a||b,a?true:false)},dashboardCreated:function(c){if(this.dashboardStore.getById(c.guid)){return}var a=Ext.create("Ozone.data.Dashboard",c);this.dashboardStore.add(a);this.dashboards.push(this.createDashboardConfig(a));var b=this.getDashboardCardPanel();return b.add(this.dashboards[this.dashboards.length-1])},designDashboard:function(b,c){Ozone.KeyMap.disable();var a=this.getBanner().getBanner(),e=this;if(a.state!=="docked"){a.hide()}else{a.el.mask()}var d=Ext.getCmp("dashboardCardPanel");var f=Ext.widget("dashboarddesigner",{dashboardContainer:this,dashboard:b||this.activeDashboard,dashboardStore:this.dashboardStore,dashboardExists:c,renderTo:d.el,ownerCt:d});f.on("destroy",function(){if(a.state!=="docked"){a.show()}else{a.el.unmask()}Ozone.KeyMap.enable()})},setDefaultDashboard:function(a){var b=this.getDashboardCardPanel().getComponent(a);if(b&&this.defaultDashboard!=b){this.defaultDashboard.isdefault=false;this.defaultDashboard.configRecord.set("isdefault",false);this.defaultDashboard.configRecord.commit(true);b.isdefault=true;b.configRecord.set("isdefault",true);b.configRecord.commit(true);this.defaultDashboard=b}},retrieveUpdatedWidgets:function(){this.widgetStore.load({scope:this,callback:function(b,a,c){if(b.length>=0){if(!c){Ozone.Msg.alert(Ozone.util.ErrorMessageString.retrieveUpdatedWidgets,Ozone.util.ErrorMessageString.retrieveUpdatedWidgetsMsg,null,null,null,this.modalWindowManager)}}else{Ozone.Msg.alert(Ozone.util.ErrorMessageString.retrieveUpdatedWidgets,Ozone.util.ErrorMessageString.retrieveUpdatedWidgetsMsg,null,null,null,this.modalWindowManager)}}})},storeContains:function(b){var a=this.activeDashboard.stateStore;if(a){return a.findRecord("widgetGuid",b)}return null},closeWidget:function(a,c,b){var d=b?Ext.getCmp(b):this.activeDashboard.getActiveWidget();d&&d.close()},maximizeCollapseWidget:function(a,c,b){var d=b?Ext.getCmp(b):this.activeDashboard.getActiveWidget();d&&d.pane.maximizeCollapseWidget(d)},minimizeExpandWidget:function(a,c,b){var d=b?Ext.getCmp(b):this.activeDashboard.getActiveWidget();d&&d.pane.minimizeExpandWidget(d)},saveWidgetState:function(a,c,b){var d=b?Ext.getCmp(b):this.activeDashboard.getActiveWidget();if(d&&d.isFloating()){d.onStateChange()}},updateTitlesandBanner:function(){var b=false;var e=false;var f=[],d=null;var a=this.widgetStore.getRange();for(var c=0;c<a.length;c++){var g=this.widgetNames[a[c].data.widgetGuid];if(g){a[c].data.name=g}if(a[c].data.widgetTypes[0].name=="marketplace"){b=true;f.push(a[c])}if(a[c].data.widgetTypes[0].name=="metric"){e=true}}if(b){if(f.length==1){d=f[0]}this.getBanner().addMarketplaceButton(d)}else{this.getBanner().removeMarketplaceButton()}if(e){this.getBanner().addMetricButton()}else{this.getBanner().removeMetricButton()}}});