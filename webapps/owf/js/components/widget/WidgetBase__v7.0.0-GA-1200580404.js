Ext.define("Ozone.components.widget.WidgetBase",{mixins:{circularfocus:"Ozone.components.focusable.CircularFocus"},dashboard:null,pane:null,isWidget:false,widgetStateContainer:null,stateEventChannelName:null,originalStateEvents:[],debugStateEvents:true,focusCls:"x-focus",focusDelay:200,overrides:{showFocusFrame:function(b){this.addCls("x-focus");this.focusShown=true;if(Ext.isIE){b.on("blur",function(){this.removeCls("x-focus");this.focusShown=false},this)}else{var a={handleEvent:Ext.bind(function(c){this.removeCls(this.focusCls);this.focusShown=false;document.removeEventListener("focus",a,true);window.removeEventListener("blur",a,false)},this)};document.addEventListener("focus",a,true);window.addEventListener("blur",a,false)}},getIframeEl:function(){var a=this.down(".widgetiframe");return a?a.getEl():null},focus:function(f,b,c,g){var e=this,a;if(b){if(!e.focusTask){e.focusTask=Ext.create("Ext.util.DelayedTask",e.focus)}e.focusTask.delay(Ext.isNumber(b)?b:10,null,e,[f,false,c,g]);return e}if(e.rendered&&!e.isDestroyed){a=e.getFocusEl();if(a.dom&&f===true){a.dom.select()}if(e.floating){e.toFront(true)}}if(g===true){var d=this.getIframeEl();if(d){d.focus();this.forceIframeFocus();if(c){this.showFocusFrame(d)}}}return e},forceIframeFocus:(function(){var a=0;return function(){var b=this;if(this.iframeReady){gadgets.rpc.call(this.getIframeId(),"_focus_widget_window");if(b.focusIframeTask){b.focusIframeTask.cancel()}}else{if(!b.focusIframeTask){b.focusIframeTask=Ext.create("Ext.util.DelayedTask",b.forceIframeFocus,b)}a+=1;if(a*b.focusDelay<=30*1000){b.focusIframeTask.delay(b.focusDelay)}else{b.focusIframeTask.cancel()}}}})(),updateHeader:function(b){var a=this,e=a.header,d=a.title,c=a.tools;Ext.each(c,function(g,f,h){if(g.xtype==="tool"&&!g.rendered){newTool={};Ext.copyTo(newTool,g,["type","expandType","handler","scope"]);newTool.xtype="widgettool";newTool=Ext.ComponentManager.create(newTool);h[f]=newTool;if(a.collapseTool===g){a.collapseTool=newTool}if(a.expandTool===g){a.expandTool=newTool}}});if(!a.preventHeader&&(b||d||(c&&c.length))){if(!e){e=a.header=Ext.create("Ozone.components.panel.WidgetHeader",{title:d,orientation:(a.headerPosition=="left"||a.headerPosition=="right")?"vertical":"horizontal",dock:a.headerPosition||"top",textCls:a.headerTextCls,icon:a.icon,iconCls:a.iconCls,baseCls:a.baseCls+"-header",tools:c,ui:a.ui,indicateDrag:a.draggable,border:a.border,frame:a.frame&&a.frameHeader,ignoreParentFrame:a.frame||a.overlapHeader,ignoreBorderManagement:a.frame||a.ignoreHeaderBorderManagement,singleton:a.singleton,listeners:a.collapsible&&a.titleCollapse?{click:a.toggleCollapse,scope:a}:null});a.addDocked(e,0);a.tools=e.tools}e.show();a.initHeaderAria()}else{if(e){e.hide()}}},insertTool:function(a,c){if(this.headers==null&&this.header!=null){this.headers=[this.header];this.header.insertTool(a,c)}else{if(this.headers){for(var b=0;b<this.headers.length;b++){if(this.headers[b]!=null){this.headers[b].insertTool(a,c)}}this.doComponentLayout()}}},updateTool:function(b){if(this.headers==null&&this.header!=null){this.headers=[this.header]}for(var c=0;c<this.headers.length;c++){if(this.headers[c]!=null){var a=this.headers[c].items.indexOfKey(b.itemId);if(a!=null&&a>-1){this.headers[c].remove(b.itemId);this.headers[c].insert(a,b)}}}this.doComponentLayout()},removeTool:function(b){if(this.headers==null&&this.header!=null){this.headers=[this.header]}for(var a=0;a<this.headers.length;a++){if(this.headers[a]!=null){this.headers[a].remove(b)}}this.doComponentLayout()},handleStateEvent:function(b,a){var d=b==="listen"?true:false,c={eventKey:guid.util.guid(),eventName:a};this.stateEventChannelName=this.stateEventChannelName?this.stateEventChannelName:this.widgetStateContainer.stateChannelPrefix+this.uniqueId;this.widgetStateContainer.eventingContainer.publish(this.stateEventChannelName,c);return d},initState:function(){if(Ext.state.Manager){var c=this.getStateId();if(c!=null){var b=null;var a=Ext.state.Manager.getProvider();if(a.getByStore!=null&&typeof a.getByStore=="function"){b=a.getByStore(this.dashboardGuid,c)}else{b=Ext.state.Manager.get(c)}if(b){if(this.fireEvent("beforestaterestore",this,b)!==false){this.applyState(Ext.apply({},b));this.fireEvent("staterestore",this,b)}}}}},saveState:function(){if(Ext.state.Manager&&this.stateful!==false){var b=this.getStateId();if(b!=null){var a=this.getState();if(this.fireEvent("beforestatesave",this,a)!==false){Ext.state.Manager.set(a.uniqueId,a);this.fireEvent("statesave",this,a)}}}},onStateChange:function(){var b=this,a=b.saveDelay;if(a>0&&!b.debugStateEvents){if(!b.stateTask){b.stateTask=Ext.create("Ext.util.DelayedTask",b.saveState,b)}b.stateTask.delay(b.saveDelay)}else{b.saveState()}}},beforeInitComponent:function(){this.createFocusCatch()},afterInitComponent:function(){this.addEvents("beforeclose","close");this.originalStateEvents=this.events;this.on({activate:this.onWidgetActivate,deactivate:this.onWidgetDeactivate,afterrender:{fn:this.onWidgetAfterRender,scope:this}});if(this.isWidget){this.on({beforeDestroy:this.onBeforeWidgetDestroy,destroy:this.onWidgetDestroy,render:this.onWidgetRender})}},onWidgetActivate:function(){this.active=true;this.removeCls(this.inactiveCls);this.removeClsWithUI([this.inactiveCls]);if(!this.preventHeader){if(this.header){this.header.activate()}else{this.on({afterrender:{fn:function(a){this.header.activate()},scope:this,single:true}})}}},onWidgetDeactivate:function(){this.active=false;this.addCls(this.inactiveCls);this.addClsWithUI([this.inactiveCls]);if(!this.preventHeader){if(this.header){this.header.deactivate()}else{this.on({afterrender:{fn:function(a){this.header.deactivate()},scope:this,single:true}})}}},onWidgetRender:function(){var a=Ozone.config.user;Ozone.metrics.logWidgetRender(a.id,a.displayName,Ozone.config.metric.url,this)},onWidgetAfterRender:function(){var f,b=false,a=false,d=this,e=Ext,c={capture:true};if(!d.header){return}if(d.xtype==="widgetwindow"||d.xtype==="widgetportlet"){d.mon(d.getEl(),"mousedown",function(i,h,g){var j=null;if(d.header!=null&&d.header.tools!=null){if(d.header.tools.close!=null){j=d.header.tools.close.toolEl}}if(j==null||h!==j.dom){this.dashboard.updateActiveWidget(this,true);if(d.xtype==="widgetwindow"){this.focus(undefined,undefined,undefined,true)}}},d)}f=d.header.getEl().dom},onBeforeWidgetDestroy:function(b){var a=b.getComponent("widgetIframe");if(a&&!a.isSrcCleared()){a.clearSrc();Ext.defer(b.destroy,100,b);return false}},onWidgetDestroy:function(c){c.dashboard.updateActiveWidget();Ext.state.Manager.clear({uniqueId:c.id,paneGuid:c.paneGuid});var d=Ext.getCmp("launchMenuWindow");if(d!=null){var a=d.down("#groupingdataview");if(a){a.enableItem(c.widgetGuid)}var b=d.down("#infodataview");if(b){b.enableItem(c.widgetGuid)}}},getStateId:function(){if(this.stateId!=null){return this.stateId}else{return((/^(ext-comp-|ext-gen)/).test(String(this.id))?null:this.id)}},purgeListener:function(a){var b=this.events[a];if(typeof b=="object"){b.clearListeners()}},restoreListener:function(a){var b=this.originalStateEvents[a];if(typeof b=="object"){this.events[a]=b}},getCurrentState:function(){var a=this.getSize(),b=this.getState();if(this.maximized){b.height=a.height;b.width=a.width}return b},getIframeId:function(){var a=this.getIframeEl();if(a!=null){return a.id}else{return null}},wasToolClicked:function(){var a=false;if(this.header!=null&this.header.toolClicked){a=true}return a},getFirstFocusableElement:function(){var a=this.getHeader();if(a!=null){return a.titleCmp.getEl()}},createFocusCatch:function(){if(!this.dockedItems){this.dockedItems=[]}this.dockedItems.push({xtype:"focuscatch",itemId:"focusCatch",dock:"bottom",listeners:{afterrender:{fn:function(a){a.mon(a.getEl(),"focus",function(){this.showFocusFrame(a.getEl())},this)},scope:this}}});this.on("afterrender",function(a){a.setupFocus(this.getFirstFocusableElement(),this.getComponent("focusCatch").getEl())})}});