Ext.define("Ozone.components.widget.DeleteWidgetsPanel",{extend:"Ext.panel.Panel",alias:["widget.deletewidgetspanel","widget.Ozone.components.widget.DeleteWidgetsPanel"],delWidgets:null,dashboardContainer:null,delTitlePanel:null,delView:null,reqTitlePanel:null,reqGrid:null,mixins:{circularFocus:"Ozone.components.focusable.CircularFocus"},id:"topdeletepanel",width:600,height:300,layout:{type:"vbox",align:"stretch"},initComponent:function(){this.delTitlePanel=Ext.create("Ext.panel.Panel",{layout:"fit",border:false,html:"You have selected to delete 0 widgets:"});this.delView=Ext.create("Ext.grid.Panel",{cls:"delView",columns:[{xtype:"templatecolumn",sortable:false,hideable:false,tpl:'<img src="{headerIcon}" />',width:36},{header:"Name",dataIndex:"name",flex:1,hideable:false}],store:Ext.create("Ext.data.Store",{autoDestroy:true,storeId:"deleteStore",idIndex:0,sortInfo:{field:"name",direction:"ASC"},fields:[{name:"guid"},{name:"name"},{name:"headerIcon"},{name:"image"}]})});this.reqTitlePanel=Ext.create("Ext.panel.Panel",{itemId:"reqTitlePanel",layout:"fit",hidden:true,border:false,html:"These widgets are required by other widgets in OWF. Deleting these widgets will additionally delete the widgets listed below."});this.reqGrid=Ext.create("Ext.grid.Panel",{itemId:"reqGrid",hidden:true,store:Ext.create("Ext.data.Store",{autoDestroy:true,storeId:"requiredStore",idIndex:0,sortInfo:{field:"name",direction:"ASC"},fields:[{name:"id"},{name:"name"},{name:"version"},{name:"url"},{name:"headerIcon"},{name:"image"},{name:"width"},{name:"height"},{name:"widgetGuid"},{name:"maximized"},{name:"minimized"},{name:"x"},{name:"y"},{name:"visible"},{name:"tags"},{name:"totalUsers"},{name:"totalGroups"},{name:"singleton"}]}),columns:[{dataIndex:"headerIcon",width:36,sortable:false,hideable:false,menuDisabled:true,renderer:function(m,h,g,n,l,i){var k=null;var j=Ozone.util.contextPath();if(!m.match(new RegExp("^/?"+j+"/.*$","i"))&&!m.match(new RegExp("^https?://.*","i"))){if(m.indexOf("/")==0){k=j+m}else{k=j+"/"+m}}else{k=m}return'<img src="'+k+'" title="'+g.data.name+'">'}},{header:"Name",dataIndex:"name",flex:1,sortable:false,hideable:false,menuDisabled:true},{header:"Version",dataIndex:"version",width:121,sortable:false,hideable:false,menuDisabled:true},{header:"Tags",dataIndex:"tags",flex:1,sortable:false,hideable:false,menuDisabled:true,renderer:function(n,h,g,o,k,j){var m="";if(n!=null){for(var l=0;l<n.length;l++){m+=n[l].name;if(l<n.length-1){m+=", "}}}return m}}],viewConfig:{emptyText:"No additional widgets to delete"},autoScroll:true,foreceFilt:true,flex:1,border:false,iconCls:"icon-grid"});this.items=[this.delTitlePanel,this.delView,this.reqTitlePanel,this.reqGrid];this.okBtn=Ext.create("Ext.button.Button",{text:Ozone.layout.DialogMessages.ok,handler:function(g){this.del()},scope:this});this.cancelBtn=Ext.create("Ext.button.Button",{xtype:"button",text:"Cancel",handler:function(g){this.cancel()},scope:this});this.buttons=[this.okBtn,this.cancelBtn];var d=this;var c=[];var e=[];var a=this.delWidgets;for(var b=0;b<a.length;b++){c.push(a[b].guid);e.push([a[b].guid,Ext.htmlEncode(a[b].name),a[b].headerIcon,a[b].image])}var f=this.delView.getStore();if(f){f.removeAll();f.loadData(e,true)}this.delTitlePanel.update("You have selected to delete "+f.getCount()+" widgets:");Ozone.pref.PrefServer.getDependentPersonWidgets({content:{ids:c},onSuccess:function(h){var n=[];var m=h.data;var l=d.delView.getStore();if(m){for(var j=0;j<m.length;j++){if(-1==l.find("guid",m[j].path)){n.push({id:m[j].path,name:m[j].value.namespace,version:m[j].value.widgetVersion,url:m[j].value.url,headerIcon:m[j].value.headerIcon,image:m[j].value.image,width:m[j].value.width,height:m[j].value.height,widgetGuid:m[j].path,maximized:m[j].value.maximized,minimized:m[j].value.minimized,x:m[j].value.x,y:m[j].value.y,visible:m[j].value.visible,tags:m[j].value.tags,totalUsers:m[j].value.totalUsers,totalGroups:m[j].value.totalGroups,singleton:m[j].value.singleton})}}}var o=d.reqTitlePanel;var g=d.reqGrid;var k=d.reqGrid.getStore();if(k){k.removeAll();if(n.length>0){o.show();g.show();k.loadData(n);d.doLayout()}else{o.hide();g.hide();d.doLayout()}}},onFailure:function(){alert("Error")}});this.callParent();this.on("afterrender",function(g){g.setupFocus(g.okBtn.getFocusEl(),g.cancelBtn.getFocusEl())})},del:function(){var f=this.delView.getStore();var g=f.getRange();var e=this.reqGrid.getStore();var a=e.getRange();var d=[];for(var b=0;b<g.length;b++){d.push(g[b].data.guid)}for(var b=0;b<a.length;b++){d.push(a[b].data.widgetGuid)}var c=this;Ozone.pref.PrefServer.updateAndDeleteWidgets({widgetsToUpdate:[],widgetGuidsToDelete:d,updateOrder:false,onSuccess:function(h){c.dashboardContainer.retrieveUpdatedWidgets()},onFailure:function(){Ozone.Msg.alert(Ozone.util.ErrorMessageString.saveUpdatedWidgets,Ozone.util.ErrorMessageString.saveUpdatedWidgetsMsg,null,null,null,c.dashboardContainer.modalWindowManager)}});this.cancel()},cancel:function(){this.ownerCt.close()}});