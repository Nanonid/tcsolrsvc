var Ozone=Ozone?Ozone:{};Ozone.dragAndDrop=Ozone.dragAndDrop?Ozone.dragAndDrop:{};Ozone.dragAndDrop.WidgetDragAndDrop=function(a){this.listeners={};this.callbacks={};this.dragging=false;this.dropEnabledFlag=false;this.dropZoneHandlers=[];a=a||{};this.dragIndicatorText=a.dragIndicatorText?a.dragIndicatorText:"Dragging Data";if(a.callbacks!=null&&owfdojo.isObject(a.callbacks)){owfdojo.mixin(this.callbacks,a.callbacks)}this.dragIndicator=this.createDragIndicator();this.dragIndicatorTextNode=owfdojo.query("span.ddText",this.dragIndicator)[0];this.widgetEventingController=a.widgetEventingController||Ozone.eventing.Widget.instance;if(a.keepMouseListenersAttached===undefined&&owfdojo.isIE){a.keepMouseListenersAttached=true}if(a.autoInit||a.autoInit===undefined){this.init(a)}function b(e,d,f){var c;if(document.createEvent){c=document.createEvent("MouseEvents");c.initMouseEvent(d,true,true,window,1,f.screenX,f.screenY,f.pageX,f.pageY,false,false,false,false,null,null);e.dispatchEvent(c)}else{if(document.createEventObject){c=document.createEventObject();e.fireEvent("on"+d,c)}}}gadgets.rpc.register("_fire_mouse_move",owfdojo.hitch(this,function(d){var c=document.elementFromPoint(d.pageX,d.pageY);if(this.getFlashWidgetId()){if(d.sender!==this.widgetEventingController.getWidgetId()){Ozone.util.getFlashApp().dispatchExternalMouseEvent(d.pageX,d.pageY)}this.mouseMove(d,true)}else{if(!arguments.callee.lastEl){arguments.callee.lastEl=c;b(c,"mouseover",d)}else{if(arguments.callee.lastEl!==c){b(arguments.callee.lastEl,"mouseout",d);b(c,"mouseover",d);arguments.callee.lastEl=c}}b(c,"mousemove",d)}}));gadgets.rpc.register("_fire_mouse_up",owfdojo.hitch(this,function(d){var c=document.elementFromPoint(d.pageX,d.pageY);if(c&&c.nodeName==="OBJECT"){this.mouseUp(d,true)}else{b(c,"mouseup",d)}}));Ozone.dragAndDrop.WidgetDragAndDrop.instance=this;return this};Ozone.dragAndDrop.WidgetDragAndDrop.prototype={dragStart:"dragStart",dragStop:"dragStop",dropReceive:"dropReceive",dragStartName:"_dragStart",dragOverWidgetName:"_dragOverWidget",dragOutName:"_dragOutName",dragStopInContainerName:"_dragStopInContainer",dragStopInWidgetName:"_dragStopInWidget",dragSendDataName:"_dragSendData",dropReceiveDataName:"_dropReceiveData",version:Ozone.version.owfversion+Ozone.version.dragAndDrop,init:function(a){a=a||{};this.widgetEventingController.subscribe(this.dragStartName,owfdojo.hitch(this,this.onStartDrag));this.widgetEventingController.subscribe(this.dragOutName,owfdojo.hitch(this,this.onDragOut));this.widgetEventingController.subscribe(this.dragStopInContainerName,owfdojo.hitch(this,this.onDragStopInContainer));this.widgetEventingController.subscribe(this.dropReceiveDataName,owfdojo.hitch(this,this.dropReceiveData));if(a.keepMouseListenersAttached===true){this.keepMouseListenersAttached=true;if(this.listeners.onmousemove==null){this.listeners.onmousemove=owfdojo.connect(document,"onmousemove",this,this.mouseMove)}if(this.listeners.onmouseup==null){this.listeners.onmouseup=owfdojo.connect(document,"onmouseup",this,this.mouseUp)}}},createDragIndicator:function(){return owfdojo.create("span",{className:"ddBox ddBoxCannotDrop",style:{display:"none"},innerHTML:'<span class="ddText">'+this.dragIndicatorText+"</span>"},owfdojo.body())},doStartDrag:function(a){var b={dragSourceId:this.widgetEventingController.getWidgetId()};this.dragZone=a.dragZone;owfdojo.mixin(b,a);delete b.dragDropData;delete b.dragZone;this.onStartDrag(this.widgetEventingController.getWidgetId(),b);this.widgetEventingController.unsubscribe(this.dragStartName);this.widgetEventingController.publish(this.dragStartName,b);this.widgetEventingController.subscribe(this.dragStartName,owfdojo.hitch(this,this.onStartDrag));this.widgetEventingController.publish(this.dragSendDataName,owfdojo.mixin({dragSourceId:this.widgetEventingController.getWidgetId()},a),"..")},onStartDrag:function(a,b){this.dragging=true;this.dragStartData=b;if(owfdojo.isFunction(this.callbacks[this.dragStart])){if(this.callbacks[this.dragStart](a,b)===false){this.dragging=false;return}}if(owfdojo.isIE){document.onselectstart=function(){return false};document.ondragstart=function(){return false}}this.dragIndicatorText=b.dragDropLabel;this.dragIndicatorTextNode.innerHTML=this.dragIndicatorText;if(this.listeners.onmousemove==null){this.listeners.onmousemove=owfdojo.connect(document,"onmousemove",this,this.mouseMove)}if(this.listeners.onmouseup==null){this.listeners.onmouseup=owfdojo.connect(document,"onmouseup",this,this.mouseUp)}},onDragOut:function(a,b){owfdojo.style(this.dragIndicator,{display:"none"})},getMouseCoordinates:function(b){var a=null;if(b.pageX||b.pageY){a={x:b.pageX,y:b.pageY}}else{a={x:b.clientX+document.body.scrollLeft-document.body.clientLeft,y:b.clientY+document.body.scrollTop-document.body.clientTop}}return a},mouseMove:function(d,g){if(this.dragging===true){if(this.getFlashWidgetId()&&g!==true&&Ozone.Widget.getDashboardLayout()==="tabbed"){gadgets.rpc.call("..","_fake_mouse_move",null,{sender:this.widgetEventingController.getWidgetId(),pageX:d.pageX,pageY:d.pageY,screenX:d.screenX,screenY:d.screenY});return}var f=null;var c=null;var h=this.getMouseCoordinates(d);var b=h.x;var j=h.y;owfdojo.style(this.dragIndicator,{display:"none"});if(d===undefined){d=window.event}if(owfdojo.isIE){f=document.body.clientWidth;c=document.body.clientHeight}else{f=window.innerWidth;c=window.innerHeight}if((owfdojo.isFF&&owfdojo.isFF>=4)||this.getFlashWidgetId()){if(d.clientX<0||d.clientX>f||d.clientY<0||d.clientY>c){if(!arguments.callee._fakeEventCounter){arguments.callee._fakeEventCounter=1}else{arguments.callee._fakeEventCounter+=1}gadgets.rpc.call("..","_fake_mouse_move",null,{sender:this.widgetEventingController.getWidgetId(),pageX:d.pageX,pageY:d.pageY,screenX:d.screenX,screenY:d.screenY});return}else{if(arguments.callee._fakeEventCounter){arguments.callee._fakeEventCounter=null;gadgets.rpc.call("..","_fake_mouse_out")}}}this.dragIndicator.style.top=j+19+"px";var i=f-100;if((b<f)&&(b>i)){this.dragIndicator.style.left=b-88+"px"}else{this.dragIndicator.style.left=b+12+"px"}var a=c-40;if((j>a)&&(j<c)){this.dragIndicator.style.top=j-30+"px"}this.dragIndicatorTextNode.innerHTML=this.dragIndicatorText;owfdojo.style(this.dragIndicator,{display:"block"})}},onDragStopInContainer:function(a,b){owfdojo.style(this.dragIndicator,{display:"none"});if(!this.keepMouseListenersAttached){for(l in this.listeners){owfdojo.disconnect(this.listeners[l]);this.listeners[l]=null}}this.dragging=false;this.dragStartData=null;this.dragZone=null;this.setDropEnabled(false);if(owfdojo.isFunction(this.callbacks[this.dragStop])){this.callbacks[this.dragStop](this.dropTarget)}},mouseUp:function(c,a){if(this.dragging===true){this.dragging=false;if(owfdojo.isIE){document.onselectstart=function(){return true};document.ondragstart=function(){return true}}owfdojo.style(this.dragIndicator,{display:"none"});if(this.getFlashWidgetId()){var d=null;var b=null;if(owfdojo.isIE){d=document.body.clientWidth;b=document.body.clientHeight}else{d=window.innerWidth;b=window.innerHeight}if((c.clientX<0||c.clientX>d||c.clientY<0||c.clientY>b||Ozone.Widget.getDashboardLayout()==="tabbed")&&a!==true){gadgets.rpc.call("..","_fake_mouse_up",null,{sender:this.widgetEventingController.getWidgetId(),pageX:c.pageX,pageY:c.pageY,screenX:c.screenX,screenY:c.screenY});return}}for(l in this.listeners){owfdojo.disconnect(this.listeners[l]);this.listeners[l]=null}this.dropTarget=c.target;this.widgetEventingController.publish(this.dragStopInWidgetName,this.widgetEventingController.getWidgetId())}},dropReceiveData:function(b,d,c){if(this.dropEnabledFlag){if(this.dropTarget){d.dropTarget=this.dropTarget;for(var a=0;a<this.dropZoneHandlers.length;a++){if(((this.dropTarget.id==this.dropZoneHandlers[a].id&&this.dropTarget.id!=null)||(owfdojo.hasClass(this.dropTarget,this.dropZoneHandlers[a].className))||(owfdojo.isDescendant(this.dropTarget,this.dropZoneHandlers[a].dropZone)))&&this.dragZone!=this.dropZoneHandlers[a].dropZone){this.dropZoneHandlers[a].handler(d)}}this.dropTarget=null}if(owfdojo.isFunction(this.callbacks[this.dropReceive])){this.callbacks[this.dropReceive](d)}}},addCallback:function(b,a){if(this.callbacks[b]==null){this.callbacks[b]=a}else{owfdojo.connect(this.callbacks,b,a)}},addDropZoneHandler:function(a){this.dropZoneHandlers.push(a)},getDropEnabled:function(){return this.dropEnabledFlag},isDragging:function(){return this.dragging},getDragStartData:function(){return owfdojo.mixin(this.dragStartData,{dragZone:this.dragZone})},setDropEnabled:function(a){if(a){this.dropEnabledFlag=true;owfdojo.removeClass(this.dragIndicator,"ddBoxCannotDrop");owfdojo.addClass(this.dragIndicator,"ddBoxCanDrop")}else{this.dropEnabledFlag=false;owfdojo.removeClass(this.dragIndicator,"ddBoxCanDrop");owfdojo.addClass(this.dragIndicator,"ddBoxCannotDrop")}},setFlashWidgetId:function(a){this.flashWidgetId=a},getFlashWidgetId:function(a){return this.flashWidgetId}};Ozone.dragAndDrop.WidgetDragAndDrop.getInstance=function(a){if(Ozone.dragAndDrop.WidgetDragAndDrop.instance==null){Ozone.dragAndDrop.WidgetDragAndDrop.instance=new Ozone.dragAndDrop.WidgetDragAndDrop(a)}return owfdojo.mixin(Ozone.dragAndDrop.WidgetDragAndDrop.instance,a)};