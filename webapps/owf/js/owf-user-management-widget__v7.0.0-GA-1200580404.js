Ext.define("Ozone.data.User",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id"},{name:"username"},{name:"userRealName"},{name:"email"},{name:"totalGroups"},{name:"totalWidgets"},{name:"totalDashboards"},{name:"totalStacks"},{name:"lastLogin"},{name:"title",mapping:"userRealName"}]});Ext.define("Ozone.data.UserStore",{extend:"Ozone.data.OWFStore",model:"Ozone.data.User",alias:"store.userstore",sorters:[{property:"userRealName",direction:"ASC"}],constructor:function(a){a=a?a:{};Ext.applyIf(a,{api:{read:"/user",create:"/user",update:"/user",destroy:"/user"},fields:["id","username","userRealName","email","totalWidgets","totalGroups","totalDashboards","lastLogin"],autoDestroy:true});Ozone.data.UserStore.superclass.constructor.call(this,a)}});Ext.define("Ozone.components.UsersGrid",{extend:"Ext.grid.Panel",alias:["widget.usersgrid","widget.Ozone.components.UsersGrid"],plugins:new Ozone.components.focusable.FocusableGridPanel(),store:null,baseParams:{},quickSearchFields:["userRealName","username","email"],showHeaderBar:true,viewConfig:{forceFit:true},defaultPageSize:50,initComponent:function(){if(this.store==null){this.store=Ext.StoreMgr.lookup({type:"userstore",pageSize:this.defaultPageSize})}if(this.baseParams){this.setBaseParams(this.baseParams)}this.columns=[{itemId:"id",header:"ID",dataIndex:"id",sortable:true,hidden:true},{header:"User Name",dataIndex:"username",flex:2,sortable:true,editable:false,hidden:true,renderer:function(a){return a?Ext.htmlEncode(a):""}},{header:"Full Name",dataIndex:"userRealName",flex:2,sortable:true,editable:false,renderer:function(a){return a?Ext.htmlEncode(a):""}},{header:"Last Sign In",dataIndex:"lastLogin",flex:2,sortable:true,editable:false,renderer:function(a){return a?Ext.Date.format(new Date(a),"m-d-Y H:i"):""}},{header:"Groups",dataIndex:"totalGroups",flex:1,sortable:false,editable:false},{header:"Widgets",dataIndex:"totalWidgets",flex:1,sortable:false,editable:false},{header:"Dashboards",dataIndex:"totalDashboards",flex:1,sortable:false,editable:false},{header:"Stacks",dataIndex:"totalStacks",flex:1,sortable:false,editable:false}];Ext.apply(this,{multiSelect:true,dockedItems:[Ext.create("Ext.toolbar.Paging",{itemId:"bottomBar",dock:"bottom",store:this.store,pageSize:this.pageSize,displayInfo:true,hidden:this.hidePagingToolbar})],columnLines:true});this.relayEvents(this.store,["datachanged"]);this.callParent(arguments)},setBaseParams:function(a){this.baseParams=a;if(this.store.proxy.extraParams){Ext.apply(this.store.proxy.extraParams,a)}else{this.store.proxy.extraParams=a}},applyFilter:function(d,a){this.store.proxy.extraParams={};Ext.apply(this.store.proxy.extraParams,this.baseParams);if(!Ext.isEmpty(d)){var c=[];for(var b=0;b<a.length;b++){c.push({filterField:a[b],filterValue:d})}Ext.apply(this.store.proxy.extraParams,{filters:Ext.JSON.encode(c),filterOperator:"OR"})}if(this.baseParams){this.setBaseParams(this.baseParams)}this.store.loadPage(1,{params:{offset:0,max:this.store.pageSize}})},clearFilters:function(){this.store.proxy.extraParams=undefined;if(this.baseParams){this.setBaseParams(this.baseParams)}this.store.load({params:{start:0,max:this.store.pageSize}})},load:function(){this.store.loadPage(1)},refresh:function(){this.store.loadPage(this.store.currentPage)},setStore:function(b,c){this.reconfigure(b,c);var a=this.getBottomToolbar();if(a){a.bindStore(b)}},getTopToolbar:function(){return this.getDockedItems('toolbar[dock="top"]')[0]},getBottomToolbar:function(){return this.getDockedItems('toolbar[dock="bottom"]')[0]}});Ext.define("Ozone.components.admin.user.UserDetailPanel",{extend:"Ext.panel.Panel",alias:["widget.userdetailpanel"],layout:{type:"vbox",align:"stretch"},detailsView:null,initComponent:function(){if(this.store==null){this.store=Ext.StoreMgr.lookup({type:"userstore"})}this.detailsView=Ext.create("Ext.view.View",{store:this.store,deferEmptyText:false,flex:1,tpl:new Ext.XTemplate('<tpl for=".">','<div class="userdetailsummary">','<div id="detail-info" class="detail-info">','<div class="detail-block">','<div class="detail-title">{userRealName:htmlEncode}</div>','<div><span class="detail-label">User Name:</span> {username:htmlEncode}</div>','<div><span class="detail-label">Email:</span> {email:htmlEncode}</div>','<div><span class="detail-label">Last Sign In:</span> {lastLogin:this.renderDate}</div>',"</div>","</div>","</div>","</tpl>",{compiled:true,renderDate:function(a){return a?Ext.Date.format(new Date(a),"m-d-Y H:i"):""}}),emptyText:"No user selected",itemSelector:"div.userdetailsummary",autoScroll:"true"});this.items=[this.detailsView];this.callParent(arguments)},loadData:function(a){this.detailsView.store.loadData([a],false)},removeData:function(){this.detailsView.store.removeAll(false)}});Ext.define("Ozone.components.admin.user.UserManagementPanel",{extend:"Ozone.components.admin.ManagementPanel",alias:["widget.usermanagement","widget.usermanagementpanel","widget.Ozone.components.admin.UserManagementPanel"],lastAction:null,dragAndDrop:true,launchesWidgets:true,channel:"AdminChannel",defaultTitle:"Users",guid_EditCopyWidget:null,minButtonWidth:80,cls:"usermanagementpanel",detailsAutoOpen:true,handleEvent:function(b,c){if(c.domain=="User"||c.relationship=="users"){var a=Ext.getCmp("managementpanel");if(a){a.refreshGrid();a.refreshWidgetLaunchMenu()}}},initComponent:function(a){var b=this;OWF.Preferences.getUserPreference({namespace:"owf.admin.UserEditCopy",name:"guid_to_launch",onSuccess:function(c){b.guid_EditCopyWidget=c.value},onFailure:function(c){b.showAlert("Preferences Error","Error looking up User Editor: "+c)}});Ext.applyIf(this,{xtype:"panel",itemId:"main",layout:{type:"border"},items:[{xtype:"usersgrid",itemId:"usersgrid",border:false,region:"center"},{xtype:"userdetailpanel",itemId:"userdetailpanel",region:"east",preventHeader:true,collapseMode:"mini",collapsible:true,collapsed:true,split:true,border:false,width:300}],dockedItems:[{xtype:"toolbar",dock:"top",layout:{type:"hbox",align:"stretchmax"},items:[{itemId:"tbtext",xtype:"tbtext",text:'<span class="heading-bold">'+this.defaultTitle+"</span>"},"->",{xtype:"searchbox",listeners:{searchChanged:{fn:function(d,e){var c=this.down("#usersgrid");if(c!=null){c.applyFilter(e,c.quickSearchFields)}},scope:this}}}]},{xtype:"toolbar",dock:"bottom",ui:"footer",defaults:{minWidth:this.minButtonWidth},items:[{xtype:"button",text:"Create",itemId:"create",handler:function(d,c){c.stopPropagation();this.doCreate()},scope:this},{xtype:"button",text:"Edit",itemId:"edit",handler:function(){var e=this.down("#usersgrid");if(e){var c=e.getSelectionModel().getSelection();if(c&&c.length>0){for(var d=0;d<c.length;++d){this.doEdit(c[d].data.id,c[d].data.userRealName)}}else{b.showAlert("Error","You must select at least one user to edit.")}}},scope:this},{xtype:"button",text:"Delete",itemId:"delete",handler:function(){var d=this.down("#usersgrid");if(d){var c=d.getSelectionModel().getSelection();if(c&&c.length>0){var e="This action will permanently delete ";if(c.length===1){e+='<span class="heading-bold">'+Ext.htmlEncode(c[0].data.userRealName)+"</span>."}else{e+='the selected <span class="heading-bold">'+c.length+" users</span>."}b.showConfirmation("Warning",e,function(g,j,h){if(g==="ok"){var i=this.down("#usersgrid").store;i.remove(c);var f=i.getTotalCount()-c.length;i.on({write:{fn:function(){if(i.data.items.length==0&&i.currentPage>1){var l=i.getPageFromRecordIndex(f-1);var k=(l>=i.currentPage)?i.currentPage:l;i.loadPage(k)}d.getBottomToolbar().doRefresh()},scope:this,single:true}});i.save()}})}else{b.showAlert("Error","You must select at least one user to delete.")}}},scope:this}]}]});this.callParent(arguments);OWF.Eventing.subscribe("AdminChannel",owfdojo.hitch(this,function(c,e,d){if(e.domain==="User"){this.down("#usersgrid").getBottomToolbar().doRefresh()}}));this.on({render:{fn:function(){var c=this.down("#usersgrid");if(c!=null){c.on({select:{fn:function(h,e,f,g){var d=this.down("#userdetailpanel");if(d!=null){d.loadData(e);if(this.detailsAutoOpen){d.expand()}}},scope:this}});c.getView().on({itemdblclick:{fn:function(){var d=c.getSelectionModel().getSelection();if(d&&d.length>0){for(var e=0;e<d.length;e++){this.doEdit(d[e].data.id,d[e].data.userRealName)}}else{b.showAlert("Error","You must select at least one user to edit.")}},scope:this},itemkeydown:{scope:this,fn:function(f,e,h,g,d){switch(d.getKey()){case d.SPACE:case d.ENTER:this.doEdit(e.data.id,e.data.userRealName)}}}});c.store.on({datachanged:{fn:function(e,f){var d=this.down("#userdetailpanel");if(d!=null){d.collapse();d.removeData()}},scope:this},load:{fn:function(d,e){},scope:this}});if(c.store.proxy){c.store.proxy.on("exception",function(i,f,d,h){var g;var j=c.store;try{g=(typeof f)=="string"?Ext.JSON.decode(f):f}catch(k){g={errorMsg:f}}b.showAlert("Server Error","Error during "+d.action+(g&&g.errorMsg?(": "+g.errorMsg):""));j.removed=[];j.load()})}c.load()}},scope:this},afterrender:{fn:function(){var c=this.el.down(".x-collapse-el");c.on("click",function(){var d=this.el.down(".x-splitter-collapsed");if(d){this.detailsAutoOpen=true}else{this.detailsAutoOpen=false}},this)},scope:this}})}});