var Ozone=Ozone?Ozone:{};Ozone.eventing=Ozone.eventing?Ozone.eventing:{};Ozone.eventing.Widget=function(b,a){if(Ozone.eventing.Widget.instance==null){Ozone.eventing.Widget.instance=this;this.isAfterInit=false;if(a!=null){owfdojo.connect(this,"afterInitCallBack",this,a)}this.setWidgetRelay(b);try{this.widgetInit()}catch(c){throw"Widget relay init failed. Relaying will not work. Inner Exception: "+c.name+": "+c.message}}else{if(a!=null){if(this.isAfterInit===false){owfdojo.connect(this,"afterInitCallBack",this,a)}else{setTimeout(a,50)}}}return Ozone.eventing.Widget.instance};Ozone.eventing.Widget.widgetRelayURL=Ozone.eventing.Widget.widgetRelayURL?Ozone.eventing.Widget.widgetRelayURL:null;Ozone.eventing.Widget.prototype={version:Ozone.version.owfversion+Ozone.version.eventing,getWidgetRelay:function(){return this.widgetRelay},setWidgetRelay:function(b){if(b==null){if(Ozone.eventing.Widget.widgetRelayURL!=null){b=Ozone.eventing.Widget.widgetRelayURL}else{var d=window.location.pathname;var a=/^(\/[^\/]+\/).*$/i;var c=d.match(a);if(c!=null&&c[1]!=null&&c[1].length>0){d=c[1];d=d.substring(0,d.length-1)}else{d=""}b=d+"/js/eventing/rpc_relay.uncompressed.html"}}this.widgetRelay=window.location.protocol+"//"+window.location.host+(b.charAt(0)!="/"?("/"+b):b)},getWidgetId:function(){return this.widgetId},getContainerRelay:function(){return this.containerRelay},widgetInit:function(){var i={};var h=null;var e=Ozone.util.parseWindowNameData();if(e!=null){this.widgetId='{"id":"'+e.id+'"}';this.locked=e.locked;this.containerRelay=e.relayUrl}else{throw {name:"WidgetInitException",message:"The call to container_init failed. Inner Exception: "}}gadgets.rpc.setRelayUrl("..",this.containerRelay,false,true);var c,g;function b(){var k={fn:"activateWidget",params:{guid:e.id,focusIframe:document.activeElement===document.body}};var j="_WIDGET_STATE_CHANNEL_"+e.id;if(!this.disableActivateWidget){gadgets.rpc.call("..",j,null,this.widgetId,k)}else{this.disableActivateWidget=false}}gadgets.rpc.register("after_container_init",owfdojo.hitch(this,function(){gadgets.rpc.unregister("after_container_init");if(!c){c=owfdojo.connect(document,"click",owfdojo.hitch(this,b))}if(!g){g=owfdojo.connect(document,"onkeyup",owfdojo.hitch(this,b))}this.afterContainerInit()}));gadgets.rpc.register("_widget_activated",owfdojo.hitch(this,function(){if(c){owfdojo.disconnect(c)}if(c){owfdojo.disconnect(g)}c=null;g=null}));gadgets.rpc.register("_widget_deactivated",owfdojo.hitch(this,function(){if(!c){c=owfdojo.connect(document,"click",owfdojo.hitch(this,b))}if(!g){g=owfdojo.connect(document,"onkeyup",owfdojo.hitch(this,b))}}));try{var a='{"id":"'+e.id+'"}';var d={id:a,version:this.version,useMultiPartMessagesForIFPC:true,relayUrl:this.widgetRelay};if(Ozone.util.pageLoad.loadTime!=null&&Ozone.util.pageLoad.autoSend){d.loadTime=Ozone.util.pageLoad.loadTime}h=Ozone.util.toString(d);gadgets.rpc.call("..","container_init",null,a,h)}catch(f){throw {name:"WidgetInitException",message:"The call to container_init failed. Inner Exception: "+f}}},isInitialized:function(){return this.isAfterInit},afterInitCallBack:function(a){},afterContainerInit:function(){this.isAfterInit=true;if(this.afterInitCallBack!=null){this.afterInitCallBack(this)}},registerHandler:function(a,b){gadgets.rpc.register(a,b)},send:function(){gadgets.rpc.call.apply(gadgets.rpc,arguments)},subscribe:function(a,b){gadgets.pubsub.subscribe(a,b);return this},unsubscribe:function(a){gadgets.pubsub.unsubscribe(a);return this},publish:function(a,c,b){gadgets.pubsub.publish(a,c,b);return this}};Ozone.eventing.Widget.getInstance=function(a,b){if(Ozone.eventing.Widget.instance==null){Ozone.eventing.Widget.instance=new Ozone.eventing.Widget(b,a)}else{if(a!=null){if(!Ozone.eventing.Widget.instance.isAfterInit){owfdojo.connect(Ozone.eventing.Widget.instance,"afterInitCallBack",Ozone.eventing.Widget.instance,a)}else{setTimeout(function(){a(Ozone.eventing.Widget.instance)},50)}}}return Ozone.eventing.Widget.instance};